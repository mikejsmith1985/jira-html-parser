<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Link Generator - Jira & ServiceNow</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  
  <style>
    :root {
      --primary-color: #0d6efd;
      --secondary-color: #6c757d;
      --success-color: #198754;
      --danger-color: #dc3545;
      --warning-color: #ffc107;
      --info-color: #0dcaf0;
      --corporate-blue: #1e3a8a;
      --corporate-gray: #64748b;
      --corporate-light: #e2e8f0;
      
      /* Light mode colors */
      --bg-gradient-start: #f1f5f9;
      --bg-gradient-mid: #e2e8f0;
      --bg-gradient-end: #cbd5e1;
      --card-bg: #ffffff;
      --text-primary: #1e293b;
      --text-secondary: #64748b;
      --border-color: #e2e8f0;
      --navbar-bg: #ffffff;
    }
    
    [data-bs-theme="dark"] {
      --bg-gradient-start: #0f172a;
      --bg-gradient-mid: #1e293b;
      --bg-gradient-end: #334155;
      --card-bg: #1e293b;
      --text-primary: #f1f5f9;
      --text-secondary: #94a3b8;
      --border-color: #334155;
      --navbar-bg: #1e293b;
      --input-bg: #2d3748;
      --toolbar-bg: #2d3748;
    }
    
    [data-bs-theme="dark"] .form-select,
    [data-bs-theme="dark"] .form-control,
    [data-bs-theme="dark"] .rich-value {
      background: #2d3748 !important;
      color: #f1f5f9 !important;
      border-color: #4a5568 !important;
    }
    
    [data-bs-theme="dark"] .toolbar-section {
      background: #2d3748 !important;
      border-color: #4a5568 !important;
    }
    
    [data-bs-theme="dark"] .formatting-toolbar {
      background: rgba(15, 23, 42, 0.95) !important;
      backdrop-filter: blur(10px);
    }
    
    [data-bs-theme="dark"] .rich-value {
      background: #2d3748 !important;
      color: #f1f5f9 !important;
      border-color: #4a5568 !important;
    }
    
    [data-bs-theme="dark"] .rich-value:focus {
      border-color: #60a5fa !important;
      box-shadow: 0 0 0 0.25rem rgba(96, 165, 250, 0.25) !important;
    }
    
    [data-bs-theme="dark"] .form-select option {
      background: #2d3748;
      color: #f1f5f9;
    }
    
    [data-bs-theme="dark"] .field-select {
      background: #2d3748 !important;
      color: #f1f5f9 !important;
    }
    
    /* Better button visibility in dark mode */
    [data-bs-theme="dark"] .btn-outline-primary {
      color: #60a5fa !important;
      border-color: #60a5fa !important;
    }
    
    [data-bs-theme="dark"] .btn-outline-primary:hover {
      background: #60a5fa !important;
      border-color: #60a5fa !important;
      color: #0f172a !important;
    }
    
    [data-bs-theme="dark"] .btn-outline-secondary {
      color: #94a3b8 !important;
      border-color: #64748b !important;
      background: rgba(100, 116, 139, 0.1) !important;
    }
    
    [data-bs-theme="dark"] .btn-outline-secondary:hover {
      background: #64748b !important;
      border-color: #64748b !important;
      color: #f1f5f9 !important;
    }
    
    [data-bs-theme="dark"] .btn-outline-danger {
      color: #f87171 !important;
      border-color: #f87171 !important;
    }
    
    [data-bs-theme="dark"] .btn-outline-danger:hover {
      background: #f87171 !important;
      border-color: #f87171 !important;
      color: #0f172a !important;
    }
    
    [data-bs-theme="dark"] .btn-outline-dark {
      color: #cbd5e1 !important;
      border-color: #64748b !important;
      background: rgba(100, 116, 139, 0.15) !important;
    }
    
    [data-bs-theme="dark"] .btn-outline-dark:hover {
      background: #64748b !important;
      border-color: #64748b !important;
      color: #f1f5f9 !important;
    }
    
    [data-bs-theme="dark"] .btn-outline-success {
      color: #4ade80 !important;
      border-color: #4ade80 !important;
    }
    
    [data-bs-theme="dark"] .btn-outline-success:hover {
      background: #4ade80 !important;
      border-color: #4ade80 !important;
      color: #0f172a !important;
    }
    
    [data-bs-theme="dark"] .btn-outline-warning {
      color: #fbbf24 !important;
      border-color: #fbbf24 !important;
    }
    
    [data-bs-theme="dark"] .btn-outline-warning:hover {
      background: #fbbf24 !important;
      border-color: #fbbf24 !important;
      color: #0f172a !important;
    }
    
    /* Dark mode for Bootstrap modals */
    [data-bs-theme="dark"] .modal-content {
      background-color: #1e293b !important;
      color: #f1f5f9 !important;
      border-color: #334155 !important;
    }
    
    [data-bs-theme="dark"] .modal-header {
      background: linear-gradient(135deg, #0f172a 0%, #1e40af 100%) !important;
      border-bottom-color: #334155 !important;
    }
    
    [data-bs-theme="dark"] .modal-footer {
      border-top-color: #334155 !important;
    }
    
    [data-bs-theme="dark"] .modal-body {
      background-color: #1e293b !important;
    }
    
    [data-bs-theme="dark"] .modal-body input,
    [data-bs-theme="dark"] .modal-body select,
    [data-bs-theme="dark"] .modal-body textarea {
      background-color: #2d3748 !important;
      color: #f1f5f9 !important;
      border-color: #4a5568 !important;
    }
    
    [data-bs-theme="dark"] .modal-body input:focus,
    [data-bs-theme="dark"] .modal-body select:focus,
    [data-bs-theme="dark"] .modal-body textarea:focus {
      background-color: #2d3748 !important;
      border-color: #60a5fa !important;
      box-shadow: 0 0 0 0.25rem rgba(96, 165, 250, 0.25) !important;
    }
    
    [data-bs-theme="dark"] .modal-body .form-label {
      color: #e2e8f0 !important;
    }
    
    [data-bs-theme="dark"] .list-group-item {
      background-color: #2d3748 !important;
      color: #f1f5f9 !important;
      border-color: #4a5568 !important;
    }
    
    [data-bs-theme="dark"] .list-group-item:hover {
      background-color: #374151 !important;
    }
    
    [data-bs-theme="dark"] .alert-success {
      background-color: rgba(34, 197, 94, 0.15) !important;
      color: #4ade80 !important;
      border-color: rgba(34, 197, 94, 0.3) !important;
    }
    
    [data-bs-theme="dark"] .alert-warning {
      background-color: rgba(251, 191, 36, 0.15) !important;
      color: #fbbf24 !important;
      border-color: rgba(251, 191, 36, 0.3) !important;
    }
    
    [data-bs-theme="dark"] #link {
      background: rgba(0, 0, 0, 0.3) !important;
      color: #cbd5e1 !important;
    }
    
    /* Dark mode for custom modals (Field Manager, Presets, Config Management, etc.) */
    /* Target both the wrapper and inner divs with inline styles */
    [data-bs-theme="dark"] #fieldManagerModal > div,
    [data-bs-theme="dark"] #managePresetsModal > div,
    [data-bs-theme="dark"] #fieldExtractorModal > div,
    [data-bs-theme="dark"] #fieldExtractorModal > div > div,
    [data-bs-theme="dark"] #fieldPickerModal > div,
    [data-bs-theme="dark"] #fieldPickerModal > div > div,
    [data-bs-theme="dark"] #configManagementModal > div,
    [data-bs-theme="dark"] #configManagementModal > div > div,
    [data-bs-theme="dark"] #baseUrlModal > div,
    [data-bs-theme="dark"] #issueTypeModal > div,
    [data-bs-theme="dark"] #projectIdModal > div,
    [data-bs-theme="dark"] #savePresetModal > div,
    [data-bs-theme="dark"] #importModal > div {
      background: #1e293b !important;
      color: #f1f5f9 !important;
    }
    
    [data-bs-theme="dark"] #fieldManagerModal h2,
    [data-bs-theme="dark"] #fieldManagerModal h3,
    [data-bs-theme="dark"] #managePresetsModal h2,
    [data-bs-theme="dark"] #fieldExtractorModal h2,
    [data-bs-theme="dark"] #fieldExtractorModal h3,
    [data-bs-theme="dark"] #fieldPickerModal h2,
    [data-bs-theme="dark"] #fieldPickerModal h3,
    [data-bs-theme="dark"] #configManagementModal h2,
    [data-bs-theme="dark"] #baseUrlModal h2,
    [data-bs-theme="dark"] #issueTypeModal h2,
    [data-bs-theme="dark"] #projectIdModal h2,
    [data-bs-theme="dark"] #savePresetModal h2,
    [data-bs-theme="dark"] #importModal h2 {
      color: #f1f5f9 !important;
    }
    
    [data-bs-theme="dark"] #fieldManagerModal p,
    [data-bs-theme="dark"] #fieldExtractorModal p,
    [data-bs-theme="dark"] #fieldPickerModal p,
    [data-bs-theme="dark"] #configManagementModal p,
    [data-bs-theme="dark"] #baseUrlModal p,
    [data-bs-theme="dark"] #issueTypeModal p,
    [data-bs-theme="dark"] #projectIdModal p,
    [data-bs-theme="dark"] #savePresetModal p,
    [data-bs-theme="dark"] #importModal p {
      color: #cbd5e1 !important;
    }
    
    [data-bs-theme="dark"] #configItemsList,
    [data-bs-theme="dark"] #presetsList,
    [data-bs-theme="dark"] #fieldManagerModal input,
    [data-bs-theme="dark"] #fieldManagerModal select,
    [data-bs-theme="dark"] #fieldManagerModal textarea,
    [data-bs-theme="dark"] #managePresetsModal input,
    [data-bs-theme="dark"] #configManagementModal input,
    [data-bs-theme="dark"] #configManagementModal select,
    [data-bs-theme="dark"] #baseUrlModal input,
    [data-bs-theme="dark"] #issueTypeModal input,
    [data-bs-theme="dark"] #projectIdModal input,
    [data-bs-theme="dark"] #savePresetModal input,
    [data-bs-theme="dark"] #importModal input,
    [data-bs-theme="dark"] #importModal textarea {
      background: #2d3748 !important;
      color: #f1f5f9 !important;
      border-color: #4a5568 !important;
    }
    
    [data-bs-theme="dark"] .info-box {
      background: rgba(96, 165, 250, 0.15) !important;
      border-color: rgba(96, 165, 250, 0.3) !important;
      color: #93c5fd !important;
    }
    
    [data-bs-theme="dark"] .info-box h3 {
      color: #60a5fa !important;
    }
    
    [data-bs-theme="dark"] #fieldExtractorModal a,
    [data-bs-theme="dark"] #fieldPickerModal a {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
    }
    
    [data-bs-theme="dark"] #fieldPickerBookmarklet {
      background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%) !important;
    }
    
    [data-bs-theme="dark"] .config-tab {
      color: #94a3b8 !important;
    }
    
    [data-bs-theme="dark"] .config-tab.active {
      color: #60a5fa !important;
      border-bottom-color: #60a5fa !important;
    }
    
    [data-bs-theme="dark"] .tab-content-section {
      background: #2d3748 !important;
      border-color: #4a5568 !important;
    }
    
    [data-bs-theme="dark"] .config-item {
      background: #374151 !important;
      border-color: #4a5568 !important;
      color: #f1f5f9 !important;
    }
    
    [data-bs-theme="dark"] .config-item:hover {
      background: #475569 !important;
    }
    
    /* Dark mode for field rows and selects */
    [data-bs-theme="dark"] .field-select.required-field {
      background: rgba(239, 68, 68, 0.15) !important;
      border-left-color: #f87171 !important;
    }
    
    [data-bs-theme="dark"] .field-select {
      background: #2d3748 !important;
      color: #f1f5f9 !important;
      border-color: #4a5568 !important;
    }
    
    [data-bs-theme="dark"] .field-select:focus {
      border-color: #60a5fa !important;
      box-shadow: 0 0 0 0.25rem rgba(96, 165, 250, 0.25) !important;
    }
    
    /* Dark mode for Field Manager specific elements */
    [data-bs-theme="dark"] #bulkOperationsToolbar {
      background: rgba(96, 165, 250, 0.15) !important;
      border-color: rgba(96, 165, 250, 0.3) !important;
    }
    
    [data-bs-theme="dark"] #fieldManagerList,
    [data-bs-theme="dark"] #ignoredFieldsList {
      background: #2d3748 !important;
      border-color: #4a5568 !important;
    }
    
    [data-bs-theme="dark"] .field-list-row {
      border-bottom-color: #4a5568 !important;
      color: #f1f5f9 !important;
    }
    
    [data-bs-theme="dark"] #comboboxOptionsSection {
      background: #2d3748 !important;
      border-color: #4a5568 !important;
    }
    
    [data-bs-theme="dark"] #comboboxOptionsList {
      background: #374151 !important;
      border-color: #4a5568 !important;
    }
    
    [data-bs-theme="dark"] .combobox-option-row {
      border-bottom-color: #4a5568 !important;
      color: #f1f5f9 !important;
    }
    
    [data-bs-theme="dark"] .combobox-option-row strong {
      color: #f1f5f9 !important;
    }
    
    /* Fix Select All checkbox area */
    [data-bs-theme="dark"] .select-all-row {
      background: #374151 !important;
      border-bottom-color: #60a5fa !important;
    }
    
    [data-bs-theme="dark"] .select-all-row label {
      color: #f1f5f9 !important;
    }
    
    [data-bs-theme="dark"] #fieldManagerList label {
      color: #f1f5f9 !important;
    }
    
    /* Dark mode for all styled divs within modals */
    [data-bs-theme="dark"] #fieldExtractorModal div[style*="background:#f8f9fa"],
    [data-bs-theme="dark"] #fieldExtractorModal div[style*="background:#e8f4fd"],
    [data-bs-theme="dark"] #fieldExtractorModal div[style*="background:#fff3cd"],
    [data-bs-theme="dark"] #fieldExtractorModal div[style*="background:white"],
    [data-bs-theme="dark"] #fieldPickerModal div[style*="background:#f8f9fa"],
    [data-bs-theme="dark"] #fieldPickerModal div[style*="background:#e8f4fd"],
    [data-bs-theme="dark"] #fieldPickerModal div[style*="background:#fff3cd"],
    [data-bs-theme="dark"] #fieldPickerModal div[style*="background:white"],
    [data-bs-theme="dark"] #configManagementModal div[style*="background:#f8f9fa"],
    [data-bs-theme="dark"] #configManagementModal div[style*="background:#e8f4fd"],
    [data-bs-theme="dark"] #configManagementModal div[style*="background:white"],
    [data-bs-theme="dark"] #managePresetsModal div[style*="background:#f8f9fa"],
    [data-bs-theme="dark"] #managePresetsModal div[style*="background:white"],
    [data-bs-theme="dark"] #savePresetModal div[style*="background:#f5f5f5"],
    [data-bs-theme="dark"] #savePresetModal div[style*="background:#f9f9f9"],
    [data-bs-theme="dark"] #savePresetModal div[style*="background:white"] {
      background: #2d3748 !important;
      border-color: #4a5568 !important;
    }
    
    /* Dark mode for warning/info boxes in modals */
    [data-bs-theme="dark"] #fieldExtractorModal div[style*="background:#fff3cd"],
    [data-bs-theme="dark"] #fieldPickerModal div[style*="background:#fff3cd"] {
      background: rgba(251, 191, 36, 0.15) !important;
      border-color: rgba(251, 191, 36, 0.4) !important;
      color: #fbbf24 !important;
    }
    
    [data-bs-theme="dark"] #fieldExtractorModal div[style*="background:#fff3cd"] strong,
    [data-bs-theme="dark"] #fieldPickerModal div[style*="background:#fff3cd"] strong {
      color: #fbbf24 !important;
    }
    
    /* Dark mode for blue info boxes in modals */
    [data-bs-theme="dark"] #fieldExtractorModal div[style*="background:#e8f4fd"],
    [data-bs-theme="dark"] #fieldPickerModal div[style*="background:#e8f4fd"] {
      background: rgba(96, 165, 250, 0.15) !important;
      border-color: rgba(96, 165, 250, 0.4) !important;
    }
    
    [data-bs-theme="dark"] #fieldExtractorModal div[style*="background:#e8f4fd"] h3,
    [data-bs-theme="dark"] #fieldExtractorModal div[style*="background:#e8f4fd"] p,
    [data-bs-theme="dark"] #fieldPickerModal div[style*="background:#e8f4fd"] h3,
    [data-bs-theme="dark"] #fieldPickerModal div[style*="background:#e8f4fd"] p {
      color: #93c5fd !important;
    }
    
    /* Dark mode for ordered/unordered lists in modals */
    [data-bs-theme="dark"] #fieldExtractorModal ol,
    [data-bs-theme="dark"] #fieldExtractorModal ol li,
    [data-bs-theme="dark"] #fieldPickerModal ol,
    [data-bs-theme="dark"] #fieldPickerModal ol li {
      color: #cbd5e1 !important;
    }
    
    /* Dark mode for buttons in modals */
    [data-bs-theme="dark"] #fieldExtractorModal button,
    [data-bs-theme="dark"] #fieldPickerModal button,
    [data-bs-theme="dark"] #managePresetsModal button,
    [data-bs-theme="dark"] #savePresetModal button {
      background: #4a5568 !important;
      color: #f1f5f9 !important;
      border-color: #60a5fa !important;
    }
    
    [data-bs-theme="dark"] #fieldExtractorModal button:hover,
    [data-bs-theme="dark"] #fieldPickerModal button:hover,
    [data-bs-theme="dark"] #managePresetsModal button:hover,
    [data-bs-theme="dark"] #savePresetModal button:hover {
      background: #60a5fa !important;
    }
    
    /* Dark mode for Save Preset modal specific elements */
    [data-bs-theme="dark"] #savePresetModal label,
    [data-bs-theme="dark"] #savePresetModal span,
    [data-bs-theme="dark"] #savePresetModal strong {
      color: #f1f5f9 !important;
    }
    
    [data-bs-theme="dark"] #savePresetModal input,
    [data-bs-theme="dark"] #savePresetModal textarea {
      background: #2d3748 !important;
      color: #f1f5f9 !important;
      border-color: #4a5568 !important;
    }
    
    body {
      background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-mid) 50%, var(--bg-gradient-end) 100%);
      min-height: 100vh;
      padding: 20px 0;
      color: var(--text-primary);
      transition: background 0.3s ease, color 0.3s ease;
    }
    
    .main-container {
      max-width: 1400px;
      margin: 0 auto;
    }
    
    .navbar-brand {
      font-size: 1.5rem;
      font-weight: 700;
      background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .card {
      border: none;
      box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.1);
      margin-bottom: 1.5rem;
      background: var(--card-bg);
      transition: background 0.3s ease;
    }
    
    .card-body {
      color: var(--text-primary);
    }
    
    .navbar {
      background: var(--navbar-bg) !important;
      transition: background 0.3s ease;
    }
    
    .navbar-text {
      color: var(--text-secondary) !important;
    }
    
    .form-select,
    .form-control,
    .rich-value {
      background: var(--card-bg);
      color: var(--text-primary);
      border-color: var(--border-color);
      transition: background 0.3s ease, color 0.3s ease, border-color 0.3s ease;
    }
    
    .toolbar-section {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
    }
    
    .formatting-toolbar {
      background: var(--card-bg);
      border-color: var(--border-color);
    }
    
    .output {
      background: var(--card-bg);
      border-color: var(--border-color);
      color: var(--text-primary);
    }
    
    [data-bs-theme="dark"] .card {
      box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.5);
    }
    
    [data-bs-theme="dark"] .navbar {
      box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.5);
    }
    
    .dark-mode-toggle {
      background: none;
      border: 1px solid var(--border-color);
      color: var(--text-primary);
      border-radius: 0.375rem;
      padding: 0.5rem 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .dark-mode-toggle:hover {
      background: var(--border-color);
    }
    
    .card-header {
      background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
      color: white;
      font-weight: 600;
      border: none;
      padding: 1rem 1.5rem;
    }
    
    .field-row {
      display: flex;
      gap: 0.75rem;
      align-items: flex-end;
      margin-bottom: 1rem;
    }
    
    .field-select {
      flex: 0 0 280px;
    }
    
    .field-select.required-field {
      border-left: 4px solid var(--danger-color) !important;
      background: #fff5f5 !important;
    }
    
    .editor-container {
      flex: 1;
      min-width: 0;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    
    /* Floating toolbar that appears on text selection */
    .formatting-toolbar {
      position: absolute;
      display: none;
      gap: 0.25rem;
      padding: 0.5rem;
      background: rgba(33, 37, 41, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 0.5rem;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.25);
      z-index: 1000;
      pointer-events: auto;
    }
    
    .formatting-toolbar.show {
      display: flex;
      animation: fadeInUp 0.2s ease-out;
    }
    
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(8px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .formatting-toolbar .btn {
      padding: 0.5rem 0.75rem;
      font-size: 0.875rem;
      font-weight: 600;
      min-width: 38px;
      background: transparent;
      color: #fff;
      border: none;
      transition: all 0.15s ease;
    }
    
    .formatting-toolbar .btn:hover {
      background: rgba(255, 255, 255, 0.15);
      transform: scale(1.05);
    }
    
    .formatting-toolbar .btn:active {
      transform: scale(0.95);
    }
    
    .rich-value {
      position: relative;
      min-height: 100px;
      border: 1px solid #ced4da;
      border-radius: 0.375rem;
      padding: 0.75rem;
      background: white;
      outline: none;
      transition: border-color 0.15s ease, box-shadow 0.15s ease;
    }
    
    .rich-value:focus {
      border-color: #0d6efd;
      box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.15);
    }
    
    .toolbar-section {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
      padding: 1rem;
      background: white;
      border-radius: 0.5rem;
      box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }
    
    .app-selector {
      display: flex;
      gap: 0;
      margin-bottom: 1.5rem;
    }
    
    .app-selector .btn {
      flex: 1;
      border-radius: 0;
      font-weight: 600;
      padding: 0.75rem 1.5rem;
    }
    
    .app-selector .btn:first-child {
      border-top-left-radius: 0.375rem;
      border-bottom-left-radius: 0.375rem;
    }
    
    .app-selector .btn:last-child {
      border-top-right-radius: 0.375rem;
      border-bottom-right-radius: 0.375rem;
    }
    
    .btn-icon {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .output {
      margin-top: 1.5rem;
      background: #f8f9fa;
      border-radius: 0.5rem;
      padding: 1.5rem;
      border: 1px solid #dee2e6;
      word-break: break-all;
    }
    
    .badge-required {
      background: var(--danger-color);
      font-size: 0.75rem;
      padding: 0.25rem 0.5rem;
      margin-left: 0.5rem;
    }
    
    .jira-only, .snow-only { display: none; }
    body.app-jira .jira-only { display: block; }
    body.app-jira .snow-only { display: none !important; }
    body.app-servicenow .snow-only { display: block; }
    body.app-servicenow .jira-only { display: none !important; }
    
    @media (max-width: 768px) {
      .field-row {
        flex-direction: column;
        align-items: stretch;
      }
      .field-select {
        flex: 1 1 auto;
      }
      .toolbar-section {
        justify-content: center;
      }
    }
    
    /* Modal improvements */
    .modal-header {
      background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
      color: white;
      border: none;
    }
    
    .modal-header .btn-close {
      filter: brightness(0) invert(1);
    }
    
    .modal-footer {
      border-top: 1px solid #dee2e6;
    }
  </style>
</head>
<body class="app-servicenow">
  
  <!-- Navigation Bar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-white shadow-sm mb-4">
    <div class="container-fluid main-container">
      <a class="navbar-brand" href="#">
        <i class="bi bi-link-45deg"></i> Template Link Generator
      </a>
      <span class="navbar-text text-muted">
        <small>Enterprise Issue Template Solution</small>
      </span>
      <button class="dark-mode-toggle ms-auto" onclick="toggleDarkMode()" id="darkModeToggle" title="Toggle Dark Mode">
        <i class="bi bi-moon-stars-fill"></i>
        <span id="darkModeText">Dark</span>
      </button>
    </div>
  </nav>

  <div class="main-container">
    <!-- App Type Selector Card -->
    <div class="card">
      <div class="card-body">
        <h5 class="card-title mb-3">
          <i class="bi bi-grid-3x3-gap"></i> Select Platform
        </h5>
        <div class="app-selector">
          <button type="button" id="btnJira" class="btn btn-outline-primary" onclick="switchAppType('jira')">
            <i class="bi bi-kanban"></i> Jira
          </button>
          <button type="button" id="btnServiceNow" class="btn btn-primary" onclick="switchAppType('servicenow')">
            <i class="bi bi-snow"></i> ServiceNow
          </button>
        </div>
      </div>
    </div>

    <!-- Toolbar Card -->
    <div class="card">
      <div class="card-body">
        <div class="toolbar-section">
          <select id="presetSelect" class="form-select" onchange="loadPresetFromDropdown()" style="flex: 1; min-width: 200px;">
            <option value="">
              <i class="bi bi-bookmark"></i> Load Preset
            </option>
          </select>
          <button type="button" onclick="openManagePresetsModal()" class="btn btn-outline-primary btn-icon">
            <i class="bi bi-bookmarks"></i> Presets
          </button>
          <button type="button" onclick="openFieldExtractorModal()" class="btn btn-outline-secondary btn-icon" title="Extract fields from forms">
            <i class="bi bi-search"></i> Field Extractor
          </button>
          <button type="button" onclick="openFieldPickerModal()" class="btn btn-outline-danger btn-icon" title="Inspect individual fields">
            <i class="bi bi-crosshair"></i> Field Picker
          </button>
          <button type="button" onclick="openConfigManagementModal()" class="btn btn-outline-dark btn-icon" title="Manage your configurations">
            <i class="bi bi-gear"></i> Manage Configs
          </button>
          <button type="button" onclick="exportConfiguration()" class="btn btn-outline-success btn-icon" title="Export all configurations">
            <i class="bi bi-download"></i> Export
          </button>
          <button type="button" onclick="openImportModal()" class="btn btn-outline-warning btn-icon" title="Import configurations">
            <i class="bi bi-upload"></i> Import
          </button>
          <button type="button" onclick="undoLastImport()" class="btn btn-outline-danger btn-icon" title="Undo the last import">
            <i class="bi bi-arrow-counterclockwise"></i> Undo
          </button>
        </div>
      </div>
    </div>

    <!-- Main Form Card -->
    <div class="card">
      <div class="card-header">
        <i class="bi bi-pencil-square"></i> Link Configuration
      </div>
      <div class="card-body">
        <form id="linkForm" autocomplete="off">
          
          <!-- Base URL -->
          <div class="mb-4">
            <label for="baseUrl" class="form-label fw-semibold">
              <i class="bi bi-globe"></i> Base URL
              <span class="badge bg-danger">Required</span>
            </label>
            <div class="input-group">
              <select id="baseUrl" class="form-select" required onchange="saveState(); updateAllFieldSelects(); detectAppType(); autoPopulateRequiredFields();">
                <option value="">-- Select Base URL --</option>
              </select>
              <button type="button" onclick="openBaseUrlManager()" class="btn btn-primary">
                <i class="bi bi-gear"></i> Manage
              </button>
            </div>
          </div>
          
          <!-- Jira-specific: Project ID -->
          <div id="projectIdRow" class="mb-4 jira-only">
            <label for="projectId" class="form-label fw-semibold">
              <i class="bi bi-folder"></i> Project ID (pid)
            </label>
            <div class="input-group">
              <select id="projectId" class="form-select" onchange="saveState(); autoPopulateRequiredFields()">
                <option value="">-- Select Project ID --</option>
              </select>
              <button type="button" onclick="openProjectIdManager()" class="btn btn-primary">
                <i class="bi bi-gear"></i> Manage
              </button>
            </div>
          </div>
          
          <!-- Issue Type -->
          <div class="mb-4">
            <label for="issueType" class="form-label fw-semibold">
              <i class="bi bi-tag"></i> Issue Type
              <span class="badge bg-danger">Required</span>
            </label>
            <div class="input-group">
              <select id="issueType" class="form-select" required onchange="saveState(); updateAllFieldSelects(); autoPopulateRequiredFields();">
                <option value="">-- Select Issue Type --</option>
              </select>
              <button type="button" onclick="openIssueTypeManager()" class="btn btn-primary">
                <i class="bi bi-gear"></i> Manage
              </button>
            </div>
          </div>
          
          <!-- Filter Fields Toggle -->
          <div class="form-check mb-4">
            <input type="checkbox" class="form-check-input" id="filterFieldsByIssueType" onchange="updateAllFieldSelects(); saveState();">
            <label class="form-check-label" for="filterFieldsByIssueType">
              <i class="bi bi-funnel"></i> Only show fields for selected issue type
            </label>
          </div>
      
      <div class="fields" id="fields"></div>
      
      <div class="d-grid gap-2 mt-4">
        <button type="button" class="btn btn-primary btn-lg" onclick="addField()">
          <i class="bi bi-plus-circle"></i> Add Field
        </button>
      </div>
      
      <div class="row g-2 mt-3">
        <div class="col-md-6">
          <button type="submit" class="btn btn-success btn-lg w-100">
            <i class="bi bi-link-45deg"></i> Generate Link
          </button>
        </div>
        <div class="col-md-6">
          <button type="button" onclick="openSavePresetModal()" class="btn btn-secondary btn-lg w-100">
            <i class="bi bi-bookmark-plus"></i> Save as Preset
          </button>
        </div>
      </div>
    </form>
    
    <!-- Output Section -->
    <div class="alert alert-success mt-4" id="output" style="display:none; cursor: pointer;" role="alert" onclick="toggleLinkDisplay()">
      <div id="copyMessage">
        <h5 class="alert-heading d-flex align-items-center justify-content-between">
          <span>
            <i class="bi bi-clipboard-check-fill"></i> Link Copied to Clipboard!
          </span>
          <small class="text-muted">
            <i class="bi bi-chevron-down" id="expandIcon"></i> Click to view link (<span id="urlLength">0</span> chars)
          </small>
        </h5>
      </div>
      <div id="linkDetails" style="display:none;">
        <hr>
        <div id="link" class="mb-3" style="word-break: break-all; font-family: 'Courier New', monospace; background: rgba(255, 255, 255, 0.3); padding: 1rem; border-radius: 0.375rem; font-size: 0.875rem;"></div>
        <button class="btn btn-warning btn-sm" onclick="event.stopPropagation(); copyLink();">
          <i class="bi bi-clipboard"></i> Copy Again
        </button>
      </div>
    </div>
  </div>
</div>

  <!-- Field Management Modal -->
  <div id="fieldManagerModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.5);z-index:1000;align-items:center;justify-content:center;">
    <div style="background:#fff;border-radius:8px;padding:24px;max-width:1000px;width:90vw;max-height:80vh;overflow-y:auto;">
      <h2>Manage Fields & Configuration</h2>
      
      <div style="margin-top:16px;">
        <h3 style="font-size:1em;color:#2c3e50;margin-bottom:8px;">Configuration Items</h3>
        <div id="configItemsList" style="margin-bottom:16px;max-height:150px;overflow-y:auto;border:1px solid #ddd;border-radius:4px;padding:8px;background:#f9f9f9;"></div>
        
        <h3 style="font-size:1em;color:#2c3e50;margin-top:16px;margin-bottom:8px;">Issue Types / Table Names</h3>
        <div style="background:#e8f4fd;border:1px solid #3498db;border-radius:4px;padding:12px;margin-bottom:16px;">
          <div style="display:flex;gap:8px;margin-bottom:8px;">
            <input type="text" id="issueTypeAliasInput" placeholder="Display Name (e.g., Service Request)" style="flex:2;padding:8px;border:1px solid #ccc;border-radius:4px;font-size:0.9em;">
            <input type="text" id="issueTypeValueInput" placeholder="ID/Value (e.g., sc_req_item)" style="flex:2;padding:8px;border:1px solid #ccc;border-radius:4px;font-size:0.9em;">
            <button type="button" onclick="addIssueTypeDefinition()" style="background:#27ae60;color:#fff;border:none;border-radius:4px;padding:8px 16px;cursor:pointer;font-size:0.9em;white-space:nowrap;">Add</button>
          </div>
          <div id="issueTypesListInModal" style="max-height:120px;overflow-y:auto;"></div>
        </div>
        
        <h3 style="font-size:1em;color:#2c3e50;margin-top:16px;margin-bottom:8px;">
          Custom Fields
          <span id="selectedFieldCount" style="display:none;font-size:0.85em;color:#3498db;font-weight:normal;margin-left:8px;"></span>
        </h3>
        
        <!-- Ignored Fields Button -->
        <div style="margin-bottom:8px;display:flex;gap:8px;">
          <button type="button" onclick="openIgnoredFieldsManager()" style="background:#e67e22;color:#fff;border:none;border-radius:4px;padding:6px 12px;cursor:pointer;font-size:0.85em;flex:1;">
            üìõ Manage Ignored Fields (<span id="ignoredFieldsCount">0</span>)
          </button>
          <button type="button" onclick="openFieldOptimization()" style="background:#9b59b6;color:#fff;border:none;border-radius:4px;padding:6px 12px;cursor:pointer;font-size:0.85em;flex:1;">
            üîß Optimize Fields
          </button>
        </div>
        
        <!-- Bulk Operations Toolbar -->
        <div id="bulkOperationsToolbar" style="display:none;background:#e8f4fd;border:1px solid #3498db;border-radius:4px;padding:8px;margin-bottom:8px;">
          <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
            <button type="button" onclick="bulkDeleteFields()" style="background:#e74c3c;color:#fff;border:none;border-radius:4px;padding:6px 12px;cursor:pointer;font-size:0.85em;">Delete Selected</button>
            <button type="button" onclick="bulkSetAppType('jira')" style="background:#5dade2;color:#fff;border:none;border-radius:4px;padding:6px 12px;cursor:pointer;font-size:0.85em;">Set Jira</button>
            <button type="button" onclick="bulkSetAppType('servicenow')" style="background:#45b7d1;color:#fff;border:none;border-radius:4px;padding:6px 12px;cursor:pointer;font-size:0.85em;">Set ServiceNow</button>
            <button type="button" onclick="bulkSetRequired(true)" style="background:#27ae60;color:#fff;border:none;border-radius:4px;padding:6px 12px;cursor:pointer;font-size:0.85em;">Mark Required</button>
            <button type="button" onclick="bulkSetRequired(false)" style="background:#95a5a6;color:#fff;border:none;border-radius:4px;padding:6px 12px;cursor:pointer;font-size:0.85em;">Mark Optional</button>
            <button type="button" onclick="deselectAllFields()" style="background:#7f8c8d;color:#fff;border:none;border-radius:4px;padding:6px 12px;cursor:pointer;font-size:0.85em;">Deselect All</button>
          </div>
        </div>
        
        <!-- Search/Filter -->
        <input type="text" id="fieldSearchInput" placeholder="üîç Search fields..." oninput="filterFieldsList()" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;margin-bottom:8px;box-sizing:border-box;">
        
        <div id="fieldManagerList" style="margin-bottom:16px;max-height:200px;overflow-y:auto;border:1px solid #ddd;border-radius:4px;padding:8px;"></div>
      </div>
      
      <div style="margin-top:16px;display:flex;flex-direction:column;gap:8px;">
        <select id="fieldBaseUrlSelect" style="padding:8px;border:1px solid #ccc;border-radius:4px;width:100%;margin-bottom:4px;">
          <option value="">All Instances (Global)</option>
        </select>
        <select id="fieldIssueTypeSelect" style="padding:8px;border:1px solid #ccc;border-radius:4px;width:100%;margin-bottom:4px;">
          <option value="">All Issue Types (Global)</option>
        </select>
        <div style="display:flex;gap:8px;">
          <input type="text" id="fieldIdInput" placeholder="ID (e.g. u_custom_field)" style="flex:1;padding:8px;border:1px solid #ccc;border-radius:4px;">
          <input type="text" id="fieldLabelInput" placeholder="Label (e.g. Custom Field)" style="flex:1;padding:8px;border:1px solid #ccc;border-radius:4px;">
        </div>
        <div style="display:flex;gap:8px;align-items:center;">
          <label style="margin:0;font-weight:500;">Field Type:</label>
          <select id="fieldTypeSelect" onchange="toggleFieldTypeOptions()" style="flex:1;padding:8px;border:1px solid #ccc;border-radius:4px;">
            <option value="text">Text (Rich Editor)</option>
            <option value="combobox">Combobox (Dropdown)</option>
          </select>
          <label style="margin:0;display:flex;align-items:center;gap:4px;white-space:nowrap;">
            <input type="checkbox" id="fieldRequiredCheckbox" style="margin:0;">
            <span>Required</span>
          </label>
        </div>
        <div id="comboboxOptionsSection" style="display:none;border:1px solid #ddd;border-radius:4px;padding:12px;background:#f9f9f9;">
          <div style="font-weight:500;margin-bottom:8px;">Combobox Options:</div>
          <div id="comboboxOptionsList" style="max-height:150px;overflow-y:auto;margin-bottom:8px;"></div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;">
            <input type="text" id="optionLabelInput" placeholder="Label (e.g. High)" style="flex:1;min-width:120px;padding:6px;border:1px solid #ccc;border-radius:4px;font-size:0.9em;">
            <input type="text" id="optionValueInput" placeholder="Value (e.g. 1)" style="flex:1;min-width:100px;padding:6px;border:1px solid #ccc;border-radius:4px;font-size:0.9em;">
            <button type="button" onclick="addComboboxOption()" style="background:#27ae60;color:#fff;border:none;border-radius:4px;padding:6px 12px;cursor:pointer;font-size:0.9em;white-space:nowrap;">Add Option</button>
          </div>
        </div>
        <button type="button" onclick="addFieldDefinition()" style="background:#3498db;color:#fff;border:none;border-radius:4px;padding:8px 16px;cursor:pointer;" id="addFieldBtn">Add</button>
      </div>
      <div style="margin-top:16px;text-align:right;gap:8px;display:flex;justify-content:flex-end;">
        <button type="button" onclick="cancelEditField()" id="cancelEditFieldBtn" style="display:none;background:#95a5a6;color:#fff;border:none;border-radius:4px;padding:8px 16px;cursor:pointer;">Cancel</button>
        <button type="button" onclick="closeFieldManager()" style="background:#95a5a6;color:#fff;border:none;border-radius:4px;padding:8px 16px;cursor:pointer;">Close</button>
      </div>
    </div>
  </div>

  <!-- Ignored Fields Manager Modal -->
  <div id="ignoredFieldsModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.5);z-index:1001;align-items:center;justify-content:center;">
    <div style="background:#fff;border-radius:8px;padding:24px;max-width:600px;width:90vw;max-height:80vh;overflow-y:auto;">
      <h2>üìõ Manage Ignored Fields</h2>
      <p style="color:#666;margin-top:8px;">Fields marked as ignored are hidden from dropdowns and won't auto-populate.</p>
      
      <!-- Search -->
      <input type="text" id="ignoredFieldSearchInput" placeholder="üîç Search ignored fields..." oninput="filterIgnoredFieldsList()" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;margin:16px 0 8px 0;box-sizing:border-box;">
      
      <!-- Ignored Fields List -->
      <div id="ignoredFieldsList" style="margin-bottom:16px;max-height:300px;overflow-y:auto;border:1px solid #ddd;border-radius:4px;padding:8px;background:#f9f9f9;">
        <!-- Fields will be populated here -->
      </div>
      
      <!-- Bulk Actions -->
      <div style="display:flex;gap:8px;margin-bottom:16px;">
        <button type="button" onclick="bulkUnignoreFields()" style="background:#27ae60;color:#fff;border:none;border-radius:4px;padding:8px 16px;cursor:pointer;font-size:0.9em;">Un-ignore Selected</button>
        <button type="button" onclick="clearAllIgnoredFields()" style="background:#e74c3c;color:#fff;border:none;border-radius:4px;padding:8px 16px;cursor:pointer;font-size:0.9em;">Clear All</button>
      </div>
      
      <div style="text-align:right;">
        <button type="button" onclick="closeIgnoredFieldsManager()" style="background:#95a5a6;color:#fff;border:none;border-radius:4px;padding:8px 16px;cursor:pointer;">Close</button>
      </div>
    </div>
  </div>

  <!-- Field Optimization Modal -->
  <div id="fieldOptimizationModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.5);z-index:1001;align-items:center;justify-content:center;">
    <div style="background:#fff;border-radius:8px;padding:24px;max-width:700px;width:90vw;max-height:80vh;overflow-y:auto;">
      <h2>üîß Field Optimization</h2>
      <p style="color:#666;margin-top:8px;">Merge duplicate fields from multiple issue types into global fields.</p>
      
      <!-- Stats -->
      <div style="background:#e7f3ff;padding:12px;border-radius:8px;border-left:4px solid #2196F3;margin:16px 0;font-size:0.9em;">
        <strong>üìä Analysis:</strong> <span id="optimizationStats">Analyzing...</span>
      </div>
      
      <!-- Duplicate Groups List -->
      <div id="optimizationList" style="margin-bottom:16px;max-height:400px;overflow-y:auto;">
        <!-- Groups will be populated here -->
      </div>
      
      <!-- Bulk Actions -->
      <div style="display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap;">
        <button type="button" onclick="mergeSelectedToMultiType()" style="background:#9b59b6;color:#fff;border:none;border-radius:4px;padding:8px 16px;cursor:pointer;font-size:0.9em;">Merge Selected</button>
        <button type="button" onclick="mergeSelectedToGlobal()" style="background:#f39c12;color:#fff;border:none;border-radius:4px;padding:8px 16px;cursor:pointer;font-size:0.9em;">‚≠ê Global Selected</button>
        <button type="button" onclick="undoLastOptimization()" style="background:#e67e22;color:#fff;border:none;border-radius:4px;padding:8px 16px;cursor:pointer;font-size:0.9em;">Undo Last</button>
      </div>
      
      <div style="background:#fff3cd;padding:12px;border-radius:8px;border-left:4px solid #ffc107;margin-bottom:16px;font-size:0.85em;">
        <strong>üí° Tip:</strong> <strong>Merge</strong> = combine into one field with multiple issue types. <strong>Global</strong> = available for ALL issue types. Fields appearing in all types are auto-recommended for global.
      </div>
      
      <div style="text-align:right;">
        <button type="button" onclick="closeFieldOptimization()" style="background:#95a5a6;color:#fff;border:none;border-radius:4px;padding:8px 16px;cursor:pointer;">Close</button>
      </div>
    </div>
  </div>

  <!-- Save Preset Modal -->
  <div id="savePresetModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.5);z-index:1000;align-items:center;justify-content:center;">
    <div style="background:#fff;border-radius:8px;padding:24px;max-width:500px;width:90vw;">
      <h2>Save as Preset</h2>
      <div style="margin-top:16px;">
        <label style="display:block;margin-bottom:8px;font-weight:500;">Preset Name *</label>
        <input type="text" id="presetNameInput" placeholder="e.g. Incident Report" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;box-sizing:border-box;">
      </div>
      <div style="margin-top:16px;">
        <label style="display:block;margin-bottom:8px;font-weight:500;">Description (optional)</label>
        <textarea id="presetDescriptionInput" placeholder="What is this preset for?" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;box-sizing:border-box;min-height:60px;"></textarea>
      </div>
      <div style="margin-top:16px;padding:12px;background:#f5f5f5;border-radius:4px;">
        <label style="display:flex;align-items:center;margin-bottom:8px;cursor:pointer;">
          <input type="checkbox" id="lockBaseUrl" style="margin-right:8px;">
          <span>Lock Base URL to: <strong id="baseUrlDisplay"></strong></span>
        </label>
        <label style="display:flex;align-items:center;cursor:pointer;">
          <input type="checkbox" id="lockIssueType" style="margin-right:8px;">
          <span>Lock Issue Type to: <strong id="issueTypeDisplay"></strong></span>
        </label>
      </div>
      <div style="margin-top:16px;text-align:right;gap:8px;display:flex;justify-content:flex-end;">
        <button type="button" onclick="closeSavePresetModal()" style="background:#95a5a6;color:#fff;border:none;border-radius:4px;padding:8px 16px;cursor:pointer;">Cancel</button>
        <button type="button" onclick="saveCurrentAsPreset()" style="background:#9b59b6;color:#fff;border:none;border-radius:4px;padding:8px 16px;cursor:pointer;">Save Preset</button>
      </div>
    </div>
  </div>

  <!-- Manage Presets Modal -->
  <div id="managePresetsModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.5);z-index:1000;align-items:center;justify-content:center;">
    <div style="background:#fff;border-radius:8px;padding:24px;max-width:600px;width:90vw;max-height:80vh;overflow-y:auto;">
      <h2>Manage Presets</h2>
      <div id="presetsList" style="margin-top:16px;max-height:400px;overflow-y:auto;border:1px solid #ddd;border-radius:4px;padding:8px;"></div>
      <div style="margin-top:16px;text-align:right;gap:8px;display:flex;justify-content:flex-end;">
        <button type="button" onclick="closeManagePresetsModal()" style="background:#95a5a6;color:#fff;border:none;border-radius:4px;padding:8px 16px;cursor:pointer;">Close</button>
      </div>
    </div>
  </div>

  <!-- Base URL Manager Modal -->
  <div id="baseUrlManagerModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.5);z-index:1000;align-items:center;justify-content:center;">
    <div style="background:#fff;border-radius:8px;padding:24px;max-width:600px;width:90vw;max-height:80vh;overflow-y:auto;">
      <h2>Manage Base URLs</h2>
      
      <div style="margin-top:16px;">
        <h3 style="font-size:1.1em;color:#2c3e50;margin-bottom:12px;">Add New Base URL</h3>
        <div style="padding:16px;background:#f9f9f9;border-radius:4px;">
          <div style="margin-bottom:12px;">
            <label style="display:block;margin-bottom:4px;font-weight:500;font-size:0.9em;">Alias / Label *</label>
            <input type="text" id="baseUrlAliasInput" placeholder="e.g. Production, Dev, Staging" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;box-sizing:border-box;">
          </div>
          <div style="margin-bottom:12px;">
            <label style="display:block;margin-bottom:4px;font-weight:500;font-size:0.9em;">Base URL *</label>
            <input type="text" id="baseUrlValueInput" placeholder="https://dev12345.service-now.com" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;box-sizing:border-box;">
          </div>
          <div style="text-align:right;">
            <button type="button" onclick="saveBaseUrl()" style="background:#27ae60;color:#fff;border:none;border-radius:4px;padding:8px 16px;cursor:pointer;font-weight:500;" id="saveBaseUrlBtn">Save</button>
            <button type="button" onclick="cancelBaseUrlEdit()" id="cancelBaseUrlBtn" style="display:none;background:#95a5a6;color:#fff;border:none;border-radius:4px;padding:8px 16px;cursor:pointer;margin-left:8px;">Cancel</button>
          </div>
        </div>
      </div>

      <div style="margin-top:24px;">
        <h3 style="font-size:1.1em;color:#2c3e50;margin-bottom:12px;">Saved Base URLs</h3>
        <div id="baseUrlSavedList" style="max-height:300px;overflow-y:auto;border:1px solid #ddd;border-radius:4px;padding:8px;"></div>
      </div>

      <div style="margin-top:16px;text-align:right;gap:8px;display:flex;justify-content:flex-end;">
        <button type="button" onclick="closeBaseUrlManager()" style="background:#95a5a6;color:#fff;border:none;border-radius:4px;padding:8px 16px;cursor:pointer;">Close</button>
      </div>
    </div>
  </div>

  <!-- Issue Type Manager Modal -->
  <div id="issueTypeManagerModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.5);z-index:1000;align-items:center;justify-content:center;">
    <div style="background:#fff;border-radius:8px;padding:24px;max-width:600px;width:90vw;max-height:80vh;overflow-y:auto;">
      <h2>Manage Issue Types</h2>
      
      <div style="margin-top:16px;">
        <h3 style="font-size:1.1em;color:#2c3e50;margin-bottom:12px;">Add New Issue Type</h3>
        <div style="padding:16px;background:#f9f9f9;border-radius:4px;">
          <div style="margin-bottom:12px;">
            <label style="display:block;margin-bottom:4px;font-weight:500;font-size:0.9em;">Alias / Label *</label>
            <input type="text" id="issueTypeAliasInput" placeholder="e.g. Incident, Change Request" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;box-sizing:border-box;">
          </div>
          <div style="margin-bottom:12px;">
            <label style="display:block;margin-bottom:4px;font-weight:500;font-size:0.9em;">Issue Type *</label>
            <input type="text" id="issueTypeValueInput" placeholder="e.g. incident, change_request" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;box-sizing:border-box;">
          </div>
          <div style="text-align:right;">
            <button type="button" onclick="saveIssueType()" style="background:#27ae60;color:#fff;border:none;border-radius:4px;padding:8px 16px;cursor:pointer;font-weight:500;" id="saveIssueTypeBtn">Save</button>
            <button type="button" onclick="cancelIssueTypeEdit()" id="cancelIssueTypeBtn" style="display:none;background:#95a5a6;color:#fff;border:none;border-radius:4px;padding:8px 16px;cursor:pointer;margin-left:8px;">Cancel</button>
          </div>
        </div>
      </div>

      <div style="margin-top:24px;">
        <h3 style="font-size:1.1em;color:#2c3e50;margin-bottom:12px;">Saved Issue Types</h3>
        <div id="issueTypeSavedList" style="max-height:300px;overflow-y:auto;border:1px solid #ddd;border-radius:4px;padding:8px;"></div>
      </div>

      <div style="margin-top:16px;text-align:right;gap:8px;display:flex;justify-content:flex-end;">
        <button type="button" onclick="closeIssueTypeManager()" style="background:#95a5a6;color:#fff;border:none;border-radius:4px;padding:8px 16px;cursor:pointer;">Close</button>
      </div>
    </div>
  </div>

  <!-- Project ID Manager Modal (Jira only) -->
  <div id="projectIdManagerModal" class="jira-only" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.5);z-index:1000;align-items:center;justify-content:center;">
    <div style="background:#fff;border-radius:8px;padding:24px;max-width:600px;width:90vw;max-height:80vh;overflow-y:auto;">
      <h2>Manage Project IDs</h2>
      
      <div style="margin-top:16px;">
        <h3 style="font-size:1.1em;color:#2c3e50;margin-bottom:12px;">Add New Project ID</h3>
        <div style="padding:16px;background:#f9f9f9;border-radius:4px;">
          <div style="margin-bottom:12px;">
            <label style="display:block;margin-bottom:4px;font-weight:500;font-size:0.9em;">Alias / Label *</label>
            <input type="text" id="projectIdAliasInput" placeholder="e.g. My Project, Team A" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;box-sizing:border-box;">
          </div>
          <div style="margin-bottom:12px;">
            <label style="display:block;margin-bottom:4px;font-weight:500;font-size:0.9em;">Project ID *</label>
            <input type="text" id="projectIdValueInput" placeholder="e.g. 10001, PROJ" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;box-sizing:border-box;">
          </div>
          <div style="text-align:right;">
            <button type="button" onclick="saveProjectId()" style="background:#27ae60;color:#fff;border:none;border-radius:4px;padding:8px 16px;cursor:pointer;font-weight:500;" id="saveProjectIdBtn">Save</button>
            <button type="button" onclick="cancelProjectIdEdit()" id="cancelProjectIdBtn" style="display:none;background:#95a5a6;color:#fff;border:none;border-radius:4px;padding:8px 16px;cursor:pointer;margin-left:8px;">Cancel</button>
          </div>
        </div>
      </div>

      <div style="margin-top:24px;">
        <h3 style="font-size:1.1em;color:#2c3e50;margin-bottom:12px;">Saved Project IDs</h3>
        <div id="projectIdSavedList" style="max-height:300px;overflow-y:auto;border:1px solid #ddd;border-radius:4px;padding:8px;"></div>
      </div>

      <div style="margin-top:16px;text-align:right;gap:8px;display:flex;justify-content:flex-end;">
        <button type="button" onclick="closeProjectIdManager()" style="background:#95a5a6;color:#fff;border:none;border-radius:4px;padding:8px 16px;cursor:pointer;">Close</button>
      </div>
    </div>
  </div>

  <!-- Field Extractor Modal -->
  <div id="fieldExtractorModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.5);z-index:1000;">
    <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;border-radius:8px;padding:24px;max-width:700px;width:90vw;max-height:80vh;overflow-y:auto;box-shadow:0 4px 20px rgba(0,0,0,0.15);">
      <h2 style="margin:0 0 16px 0;color:#2c3e50;">üîç Field Extractor</h2>
      <p style="color:#666;margin:0 0 20px 0;line-height:1.5;">Automatically extract field definitions from Jira or ServiceNow forms using the bookmarklet below.</p>
      
      <div style="background:#e8f4fd;padding:20px;border-radius:8px;border:2px solid #3498db;margin-bottom:20px;">
        <h3 style="font-size:1em;margin:0 0 12px 0;color:#2980b9;font-weight:600;">üìå Step 1: Add Bookmarklet</h3>
        <p style="font-size:0.9em;color:#555;margin:0 0 12px 0;">Drag the button below to your browser's bookmarks bar:</p>
        <div style="text-align:center;padding:20px;background:white;border-radius:6px;">
          <a id="fieldExtractorBookmarklet" href="" style="display:inline-block;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:white;text-decoration:none;padding:14px 28px;border-radius:8px;font-weight:600;font-size:14px;cursor:move;box-shadow:0 2px 8px rgba(102,126,234,0.4);transition:transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">üîç Field Extractor</a>
          <p style="margin:12px 0 0 0;font-size:0.85em;color:#999;font-style:italic;">‚Üê Drag this to your bookmarks bar</p>
        </div>
      </div>

      <div style="background:#f8f9fa;padding:20px;border-radius:8px;margin-bottom:20px;border:1px solid #dee2e6;">
        <h3 style="font-size:1em;margin:0 0 12px 0;color:#2c3e50;font-weight:600;">üìñ Step 2: Use the Bookmarklet</h3>
        <ol style="margin:0;padding-left:24px;line-height:2;color:#555;font-size:0.9em;">
          <li>Navigate to a ServiceNow form page (e.g., Create Incident, Create Change Request)</li>
          <li>Make sure all form sections are expanded to capture all fields</li>
          <li>Click the <strong>"üîç Field Extractor"</strong> bookmark you just added</li>
          <li>A popup will show all discovered fields - download or copy the JSON</li>
          <li>Return to this tool and click <strong>"Import Config"</strong> to load the fields</li>
        </ol>
      </div>

      <div style="background:#fff3cd;padding:16px;border-radius:8px;border-left:4px solid #ffc107;font-size:0.9em;color:#856404;line-height:1.6;">
        <strong>üí° Pro Tip:</strong> Run the bookmarklet on different ServiceNow forms to extract fields specific to each form type (Incident, Change, Problem, etc.).
      </div>

      <div style="margin-top:24px;text-align:right;">
        <button type="button" onclick="closeFieldExtractorModal()" style="background:#6c757d;color:#fff;border:none;border-radius:6px;padding:10px 24px;cursor:pointer;font-size:14px;font-weight:500;transition:background 0.2s;" onmouseover="this.style.background='#5a6268'" onmouseout="this.style.background='#6c757d'">Close</button>
      </div>
    </div>
  </div>

  <!-- Field Picker Modal -->
  <div id="fieldPickerModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.5);z-index:1000;">
    <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;border-radius:8px;padding:24px;max-width:700px;width:90vw;max-height:80vh;overflow-y:auto;box-shadow:0 4px 20px rgba(0,0,0,0.15);">
      <h2 style="margin:0 0 16px 0;color:#2c3e50;">üéØ Field Picker</h2>
      <p style="color:#666;margin:0 0 20px 0;line-height:1.5;">Click on individual fields to inspect their properties, IDs, and options.</p>
      
      <div style="background:#e8f4fd;padding:20px;border-radius:8px;border:2px solid #3498db;margin-bottom:20px;">
        <h3 style="font-size:1em;margin:0 0 12px 0;color:#2980b9;font-weight:600;">üìå Step 1: Add Bookmarklet</h3>
        <p style="font-size:0.9em;color:#555;margin:0 0 12px 0;">Drag the button below to your browser's bookmarks bar:</p>
        <div style="text-align:center;padding:20px;background:white;border-radius:6px;">
          <a id="fieldPickerBookmarklet" href="" style="display:inline-block;background:linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);color:white;text-decoration:none;padding:14px 28px;border-radius:8px;font-weight:600;font-size:14px;cursor:move;box-shadow:0 2px 8px rgba(231,76,60,0.4);transition:transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">üéØ Field Picker</a>
          <p style="margin:12px 0 0 0;font-size:0.85em;color:#999;font-style:italic;">‚Üê Drag this to your bookmarks bar</p>
        </div>
      </div>

      <div style="background:#f8f9fa;padding:20px;border-radius:8px;margin-bottom:20px;border:1px solid #dee2e6;">
        <h3 style="font-size:1em;margin:0 0 12px 0;color:#2c3e50;font-weight:600;">üìñ Step 2: Use the Field Picker</h3>
        <ol style="margin:0;padding-left:24px;line-height:2;color:#555;font-size:0.9em;">
          <li>Navigate to a Jira or ServiceNow form page</li>
          <li>Click the <strong>"üéØ Field Picker"</strong> bookmark you just added</li>
          <li>A green banner appears - Field Picker is now active!</li>
          <li>Click any form field (input, dropdown, textarea) to see its details</li>
          <li>Copy the field ID, label, or full JSON definition</li>
          <li>Click another field to inspect it, or press <strong>ESC</strong> to exit</li>
        </ol>
      </div>

      <div style="background:#fff3cd;padding:16px;border-radius:8px;border-left:4px solid #ffc107;font-size:0.9em;color:#856404;line-height:1.6;">
        <strong>üí° Pro Tip:</strong> Field Picker stays active until you press ESC, so you can inspect multiple fields without reactivating the bookmarklet!
      </div>

      <div style="margin-top:24px;text-align:right;">
        <button type="button" onclick="closeFieldPickerModal()" style="background:#6c757d;color:#fff;border:none;border-radius:6px;padding:10px 24px;cursor:pointer;font-size:14px;font-weight:500;transition:background 0.2s;" onmouseover="this.style.background='#5a6268'" onmouseout="this.style.background='#6c757d'">Close</button>
      </div>
    </div>
  </div>

  <!-- Import Modal -->
  <div id="importModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.5);z-index:1000;align-items:center;justify-content:center;">
    <div class="modal-content" style="background:#fff;border-radius:12px;padding:28px;max-width:700px;width:90vw;max-height:85vh;overflow-y:auto;box-shadow:0 4px 20px rgba(0,0,0,0.15);">
      <h2 style="margin:0 0 16px 0;color:#2c3e50;">üì• Import Configuration</h2>
      <p style="color:#666;margin:0 0 24px 0;line-height:1.5;">Import field definitions, base URLs, and settings from a JSON file or paste JSON directly.</p>
      
      <!-- Tab Selection -->
      <div style="display:flex;gap:8px;margin-bottom:20px;border-bottom:2px solid #e9ecef;">
        <button id="importFileTabBtn" class="import-tab active" onclick="switchImportTab('file')" style="background:none;border:none;padding:12px 20px;cursor:pointer;font-weight:600;color:#6c757d;border-bottom:3px solid #3498db;transition:all 0.2s;">
          üìÅ Upload File(s)
        </button>
        <button id="importPasteTabBtn" class="import-tab" onclick="switchImportTab('paste')" style="background:none;border:none;padding:12px 20px;cursor:pointer;font-weight:600;color:#6c757d;border-bottom:3px solid transparent;transition:all 0.2s;">
          üìã Paste JSON
        </button>
      </div>
      
      <!-- File Upload Tab -->
      <div id="importFileTab" style="display:block;">
        <div style="background:#f8fafc;border:2px dashed #cbd5e0;border-radius:8px;padding:32px;text-align:center;margin-bottom:16px;">
          <input type="file" id="importFileInput" accept=".json" multiple style="display:none;" onchange="handleFileImport(event)">
          <p style="margin:0 0 16px 0;color:#64748b;font-size:14px;">
            <i class="bi bi-cloud-upload" style="font-size:48px;display:block;margin-bottom:12px;"></i>
            Click below to select one or more JSON files
          </p>
          <button type="button" onclick="document.getElementById('importFileInput').click()" style="background:#3498db;color:#fff;border:none;border-radius:6px;padding:12px 24px;cursor:pointer;font-size:14px;font-weight:600;">
            Choose File(s)
          </button>
        </div>
        <p style="color:#64748b;font-size:13px;margin:0;"><strong>üí° Tip:</strong> You can select multiple JSON files at once. They will be merged automatically.</p>
      </div>
      
      <!-- Paste JSON Tab -->
      <div id="importPasteTab" style="display:none;">
        <textarea id="importJsonTextarea" placeholder="Paste your JSON configuration here..." style="width:100%;min-height:300px;padding:12px;border:1px solid #cbd5e0;border-radius:6px;font-family:Monaco,Consolas,monospace;font-size:13px;resize:vertical;margin-bottom:16px;"></textarea>
        <div style="display:flex;gap:8px;justify-content:flex-end;">
          <button type="button" onclick="clearImportJson()" style="background:#95a5a6;color:#fff;border:none;border-radius:6px;padding:10px 20px;cursor:pointer;font-size:14px;">
            Clear
          </button>
          <button type="button" onclick="importFromPastedJson()" style="background:#27ae60;color:#fff;border:none;border-radius:6px;padding:10px 20px;cursor:pointer;font-size:14px;font-weight:600;">
            Import JSON
          </button>
        </div>
        <p style="color:#64748b;font-size:13px;margin:12px 0 0 0;"><strong>üí° Tip:</strong> Paste the entire JSON configuration from an export file.</p>
      </div>
      
      <div style="margin-top:24px;text-align:right;">
        <button type="button" onclick="closeImportModal()" style="background:#6c757d;color:#fff;border:none;border-radius:6px;padding:10px 24px;cursor:pointer;font-size:14px;">
          Close
        </button>
      </div>
    </div>
  </div>

  <!-- Config Management Modal -->
  <div id="configManagementModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.5);z-index:1000;">
    <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;border-radius:12px;padding:28px;max-width:900px;width:90vw;max-height:85vh;overflow-y:auto;box-shadow:0 4px 20px rgba(0,0,0,0.15);">
      <h2 style="margin:0 0 16px 0;color:#2c3e50;">‚öôÔ∏è Configuration Management</h2>
      <p style="color:#666;margin:0 0 24px 0;line-height:1.5;">Manage your imported field definitions, base URLs, issue types, and project IDs.</p>
      
      <div id="configManagementTabs" style="display:flex;gap:8px;margin-bottom:20px;border-bottom:2px solid #e9ecef;">
        <button id="tabFieldsBtn" class="config-tab active" onclick="showConfigTab('fields')" style="background:none;border:none;padding:12px 20px;cursor:pointer;font-weight:600;color:#6c757d;border-bottom:3px solid transparent;transition:all 0.2s;">Fields</button>
        <button id="tabDropdownsBtn" class="config-tab" onclick="showConfigTab('dropdowns')" style="background:none;border:none;padding:12px 20px;cursor:pointer;font-weight:600;color:#6c757d;border-bottom:3px solid transparent;transition:all 0.2s;">Base URLs</button>
        <button id="tabIssueTypesBtn" class="config-tab" onclick="showConfigTab('issueTypes')" style="background:none;border:none;padding:12px 20px;cursor:pointer;font-weight:600;color:#6c757d;border-bottom:3px solid transparent;transition:all 0.2s;">Issue Types</button>
        <button id="tabProjectsBtn" class="config-tab jira-only" onclick="showConfigTab('projects')" style="background:none;border:none;padding:12px 20px;cursor:pointer;font-weight:600;color:#6c757d;border-bottom:3px solid transparent;transition:all 0.2s;">Project IDs</button>
      </div>

      <div id="configFieldsTab" class="config-tab-content" style="display:block;">
        <!-- Add/Edit Field Form -->
        <div style="background:#e8f4fd;border:1px solid #3498db;border-radius:8px;padding:16px;margin-bottom:20px;">
          <h4 style="margin:0 0 16px 0;color:#2c3e50;font-size:1.1em;">Add / Edit Field</h4>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px;">
            <div>
              <label style="display:block;margin-bottom:4px;font-size:0.9em;color:#555;">Field ID *</label>
              <input type="text" id="configFieldIdInput" placeholder="e.g., assigned_to" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;font-size:0.9em;">
            </div>
            <div>
              <label style="display:block;margin-bottom:4px;font-size:0.9em;color:#555;">Label *</label>
              <input type="text" id="configFieldLabelInput" placeholder="e.g., Assigned To" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;font-size:0.9em;">
            </div>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:12px;">
            <div>
              <label style="display:block;margin-bottom:4px;font-size:0.9em;color:#555;">Field Type</label>
              <select id="configFieldTypeSelect" onchange="toggleConfigFieldOptions()" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;font-size:0.9em;">
                <option value="text">Text</option>
                <option value="combobox">Combobox</option>
              </select>
            </div>
            <div>
              <label style="display:block;margin-bottom:4px;font-size:0.9em;color:#555;">Base URL</label>
              <select id="configFieldBaseUrlSelect" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;font-size:0.9em;">
                <option value="">All Instances</option>
              </select>
            </div>
            <div>
              <label style="display:block;margin-bottom:4px;font-size:0.9em;color:#555;">Issue Type</label>
              <select id="configFieldIssueTypeSelect" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;font-size:0.9em;">
                <option value="">All Issue Types</option>
              </select>
            </div>
          </div>
          <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
            <label style="margin:0;display:flex;align-items:center;gap:6px;font-size:0.9em;">
              <input type="checkbox" id="configFieldRequiredCheck">
              <span>Required</span>
            </label>
          </div>
          <div id="configComboboxOptionsSection" style="display:none;border-top:1px solid #3498db;padding-top:12px;margin-top:12px;">
            <label style="display:block;margin-bottom:8px;font-size:0.9em;color:#555;font-weight:600;">Combobox Options:</label>
            <div id="configComboboxOptionsList" style="max-height:120px;overflow-y:auto;margin-bottom:8px;"></div>
            <div style="display:flex;gap:8px;">
              <input type="text" id="configOptionLabelInput" placeholder="Label" style="flex:1;padding:6px;border:1px solid #ccc;border-radius:4px;font-size:0.85em;">
              <input type="text" id="configOptionValueInput" placeholder="Value" style="flex:1;padding:6px;border:1px solid #ccc;border-radius:4px;font-size:0.85em;">
              <button type="button" onclick="addConfigComboboxOption()" style="background:#27ae60;color:#fff;border:none;border-radius:4px;padding:6px 12px;cursor:pointer;font-size:0.85em;white-space:nowrap;">Add</button>
            </div>
          </div>
          <div style="display:flex;gap:8px;margin-top:12px;">
            <button type="button" onclick="saveConfigField()" id="configSaveFieldBtn" style="background:#27ae60;color:#fff;border:none;border-radius:6px;padding:10px 20px;cursor:pointer;font-size:0.9em;font-weight:600;">Save Field</button>
            <button type="button" onclick="cancelConfigFieldEdit()" id="configCancelFieldBtn" style="display:none;background:#95a5a6;color:#fff;border:none;border-radius:6px;padding:10px 20px;cursor:pointer;font-size:0.9em;">Cancel</button>
          </div>
        </div>
        
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
          <div id="fieldsSummary" style="color:#666;font-size:0.9em;"></div>
          <div>
            <button onclick="clearAllFields()" style="background:#e74c3c;color:#fff;border:none;border-radius:6px;padding:8px 16px;cursor:pointer;font-size:13px;">Clear All Fields</button>
          </div>
        </div>
        <div id="fieldsListByIssueType" style="max-height:400px;overflow-y:auto;"></div>
      </div>

      <div id="configDropdownsTab" class="config-tab-content" style="display:none;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
          <div id="urlsSummary" style="color:#666;font-size:0.9em;"></div>
          <div>
            <button onclick="clearAllBaseUrls()" style="background:#e74c3c;color:#fff;border:none;border-radius:6px;padding:8px 16px;cursor:pointer;font-size:13px;">Clear All URLs</button>
          </div>
        </div>
        <div id="baseUrlsList" style="max-height:400px;overflow-y:auto;"></div>
      </div>

      <div id="configIssueTypesTab" class="config-tab-content" style="display:none;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
          <div id="issueTypesSummary" style="color:#666;font-size:0.9em;"></div>
          <div>
            <button onclick="clearAllIssueTypesConfig()" style="background:#e74c3c;color:#fff;border:none;border-radius:6px;padding:8px 16px;cursor:pointer;font-size:13px;">Clear All Issue Types</button>
          </div>
        </div>
        <div id="issueTypesList" style="max-height:400px;overflow-y:auto;"></div>
      </div>

      <div id="configProjectsTab" class="config-tab-content jira-only" style="display:none;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
          <div id="projectsSummary" style="color:#666;font-size:0.9em;"></div>
          <div>
            <button onclick="clearAllProjectIds()" style="background:#e74c3c;color:#fff;border:none;border-radius:6px;padding:8px 16px;cursor:pointer;font-size:13px;">Clear All Projects</button>
          </div>
        </div>
        <div id="projectIdsList" style="max-height:400px;overflow-y:auto;"></div>
      </div>

      <div style="margin-top:24px;display:flex;gap:12px;justify-content:flex-end;">
        <button type="button" onclick="closeConfigManagementModal()" style="background:#6c757d;color:#fff;border:none;border-radius:6px;padding:10px 24px;cursor:pointer;font-size:14px;font-weight:500;">Close</button>
      </div>
    </div>
  </div>

  <script>
    // ========================================================================
    // APP TYPE MANAGEMENT - Jira vs ServiceNow
    // ========================================================================
    
    let currentAppType = localStorage.getItem('linkGenAppType') || 'servicenow';
    let currentEditingFieldIndex = null;
    
    // Dark Mode Functions
    function toggleDarkMode() {
      const html = document.documentElement;
      const currentTheme = html.getAttribute('data-bs-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      
      html.setAttribute('data-bs-theme', newTheme);
      localStorage.setItem('theme', newTheme);
      
      updateDarkModeButton(newTheme);
    }
    
    function updateDarkModeButton(theme) {
      const icon = document.querySelector('#darkModeToggle i');
      const text = document.getElementById('darkModeText');
      
      if (theme === 'dark') {
        icon.className = 'bi bi-sun-fill';
        text.textContent = 'Light';
      } else {
        icon.className = 'bi bi-moon-stars-fill';
        text.textContent = 'Dark';
      }
    }
    
    function initializeDarkMode() {
      const savedTheme = localStorage.getItem('theme') || 'light';
      document.documentElement.setAttribute('data-bs-theme', savedTheme);
      updateDarkModeButton(savedTheme);
    }
    
    function switchAppType(appType) {
      currentAppType = appType;
      localStorage.setItem('linkGenAppType', appType);
      
      // Update body class
      document.body.classList.remove('app-jira', 'app-servicenow');
      document.body.classList.add('app-' + appType);
      
      // Update Bootstrap button states
      const btnJira = document.getElementById('btnJira');
      const btnServiceNow = document.getElementById('btnServiceNow');
      
      if (appType === 'jira') {
        btnJira.classList.remove('btn-outline-primary');
        btnJira.classList.add('btn-primary');
        btnServiceNow.classList.remove('btn-primary');
        btnServiceNow.classList.add('btn-outline-primary');
      } else {
        btnServiceNow.classList.remove('btn-outline-primary');
        btnServiceNow.classList.add('btn-primary');
        btnJira.classList.remove('btn-primary');
        btnJira.classList.add('btn-outline-primary');
      }
      
      // Update title - keep it as "Template Link Generator" for both platforms
      const titleElement = document.querySelector('.navbar-brand');
      if (titleElement) {
        titleElement.innerHTML = `<i class="bi bi-link-45deg"></i> Template Link Generator`;
      }
      
      // Refresh dropdowns for the new app type
      populateBaseUrlDropdown();
      populateIssueTypeDropdown();
      populatePresetDropdown();
      if (appType === 'jira') {
        populateProjectIdDropdown();
      }
    }
    
    function detectAppType() {
      const baseUrlId = document.getElementById('baseUrl').value;
      const baseUrls = loadItems(getStorageKey('baseUrls'));
      const baseUrlItem = baseUrls.find(i => i.id === baseUrlId);
      if (baseUrlItem && baseUrlItem.value) {
        const url = baseUrlItem.value.toLowerCase();
        if (url.includes('service-now.com') || url.includes('servicenow.com')) {
          if (currentAppType !== 'servicenow') switchAppType('servicenow');
        } else {
          if (currentAppType !== 'jira') switchAppType('jira');
        }
      }
    }
    
    function getStorageKey(key) {
      // Use app-specific unified storage keys
      const prefix = currentAppType === 'jira' ? 'linkGenJira' : 'linkGenSnow';
      return prefix + key.charAt(0).toUpperCase() + key.slice(1);
    }
    
    // ========================================================================
    // CONFIGURATION ITEMS - Persistence Layer
    // ========================================================================

    const DEFAULT_CONFIG_ITEMS = [
      { id: "baseUrl", label: "Base URL", category: "config" },
      { id: "issueType", label: "Issue Type", category: "config" }
    ];

    const DEFAULT_FIELDS = [
      { id: "short_description", label: "Short Description", category: "standard", fieldType: "text" },
      { id: "description", label: "Description", category: "standard", fieldType: "text" },
      { id: "priority", label: "Priority", category: "standard", fieldType: "text" },
      { id: "assigned_to", label: "Assigned To", category: "standard", fieldType: "text" },
      { id: "category", label: "Category", category: "standard", fieldType: "text" },
      { id: "urgency", label: "Urgency", category: "standard", fieldType: "text" },
      { id: "impact", label: "Impact", category: "standard", fieldType: "text" }
    ];

    // ========================================================================
    // CONFIGURATION ITEMS - Persistence Layer
    // ========================================================================

    function loadConfigurationItems() {
      try {
        const stored = localStorage.getItem('snowConfigItems');
        if (!stored) return DEFAULT_CONFIG_ITEMS;
        const parsed = JSON.parse(stored);
        if (!Array.isArray(parsed)) return DEFAULT_CONFIG_ITEMS;
        return parsed.filter(c => c.id && c.label);
      } catch (e) {
        console.error('Failed to load config items:', e);
        return DEFAULT_CONFIG_ITEMS;
      }
    }

    function saveConfigurationItems(items) {
      try {
        const unique = Array.from(new Map(items.map(d => [d.id, d])).values());
        localStorage.setItem('snowConfigItems', JSON.stringify(unique));
        return true;
      } catch (e) {
        console.error('Failed to save config items:', e);
        throw new Error('Could not save configuration items (localStorage full?)');
      }
    }

    function loadFieldDefinitions() {
      try {
        const stored = localStorage.getItem(getStorageKey('fieldDefinitions'));
        if (!stored) return DEFAULT_FIELDS;
        const parsed = JSON.parse(stored);
        if (!Array.isArray(parsed)) return DEFAULT_FIELDS;
        // Filter out ignored fields by default
        return parsed.filter(f => f.id && f.label && !f.ignored);
      } catch (e) {
        console.error('Failed to load field definitions:', e);
        return DEFAULT_FIELDS;
      }
    }
    
    function loadAllFieldDefinitions() {
      // Load ALL fields including ignored ones (for Ignored Fields Manager)
      try {
        const stored = localStorage.getItem(getStorageKey('fieldDefinitions'));
        if (!stored) return DEFAULT_FIELDS;
        const parsed = JSON.parse(stored);
        if (!Array.isArray(parsed)) return DEFAULT_FIELDS;
        return parsed.filter(f => f.id && f.label);
      } catch (e) {
        console.error('Failed to load all field definitions:', e);
        return DEFAULT_FIELDS;
      }
    }

    function saveFieldDefinitions(definitions) {
      try {
        // Deduplicate by id + issueTypeId + baseUrlId to preserve duplicates across issue types
        const unique = Array.from(new Map(definitions.map(d => {
          const issueTypeKey = Array.isArray(d.issueTypeId) ? d.issueTypeId.sort().join(',') : (d.issueTypeId || 'global');
          const key = `${d.id}|${issueTypeKey}|${d.baseUrlId || 'global'}`;
          return [key, d];
        })).values());
        localStorage.setItem(getStorageKey('fieldDefinitions'), JSON.stringify(unique));
        return true;
      } catch (e) {
        console.error('Failed to save field definitions:', e);
        throw new Error('Could not save field definitions (localStorage full?)');
      }
    }

    function migrateFieldNames(fields, fieldDefinitions) {
      return fields.map(field => {
        if (!field.fieldId && field.name) {
          const def = fieldDefinitions.find(d => d.id === field.name);
          if (def) {
            return { ...field, fieldId: def.id };
          }
          const newDef = { id: field.name, label: field.name, category: 'custom' };
          fieldDefinitions.push(newDef);
          return { ...field, fieldId: newDef.id };
        }
        return field;
      });
    }

    // ========================================================================
    // RESTORE LAST STATE & MIGRATION
    // ========================================================================
    window.onload = function() {
      // Check for config URL parameter (e.g., ?config=https://...)
      const params = new URLSearchParams(window.location.search);
      const configUrl = params.get('config');
      
      if (configUrl) {
        // Load configuration from URL before initializing form
        loadConfigurationFromUrl(configUrl);
        return; // Don't continue until config is loaded
      }

      // Don't restore any saved state - user wants clean form every time
      // Just add one empty field to start
      addField();

      // Populate preset dropdown
      populatePresetDropdown();
    };

    // Show/hide floating toolbar based on text selection
    function showFloatingToolbar(editor, toolbar) {
      const selection = window.getSelection();
      if (!selection.rangeCount || selection.isCollapsed) {
        toolbar.classList.remove('show');
        return;
      }

      // Check if selection is within this editor
      const range = selection.getRangeAt(0);
      if (!editor.contains(range.commonAncestorContainer)) {
        toolbar.classList.remove('show');
        return;
      }

      // Position toolbar above the selection
      const rect = range.getBoundingClientRect();
      const toolbarHeight = 50; // Approximate height
      const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
      const scrollLeft = window.pageXOffset || document.documentElement.scrollLeft;
      
      toolbar.style.left = `${rect.left + scrollLeft + (rect.width / 2)}px`;
      toolbar.style.top = `${rect.top + scrollTop - toolbarHeight}px`;
      toolbar.style.transform = 'translateX(-50%)';
      toolbar.classList.add('show');
    }

    // Save state
    function saveState() {
      const state = {
        baseUrl: document.getElementById('baseUrl').value,
        issueType: document.getElementById('issueType').value,
        fields: getFields()
      };
      localStorage.setItem('snowGenState', JSON.stringify(state));
    }

    // Add a new field row with dropdown
    function addField(data = {}) {
      const fieldsDiv = document.getElementById('fields');
      const row = document.createElement('div');
      row.className = 'field-row';
      row.setAttribute('data-field-id', data.fieldId || '');

      // Field selection dropdown
      const fieldSelect = document.createElement('select');
      fieldSelect.className = 'form-select field-select';

      const placeholder = document.createElement('option');
      placeholder.value = '';
      placeholder.textContent = '-- Select Field --';
      fieldSelect.appendChild(placeholder);

      const definitions = loadFieldDefinitions();
      const currentBaseUrlId = document.getElementById('baseUrl').value;
      const currentIssueTypeId = document.getElementById('issueType').value;
      
      // Get current app type from body class
      const isJira = document.body.classList.contains('app-jira');
      const isServiceNow = document.body.classList.contains('app-servicenow');

      definitions.sort((a, b) => a.label.localeCompare(b.label)).forEach(def => {
        // Filter: Show if Global (no baseUrlId) OR matches current Base URL OR matches the current field (so it doesn't disappear if already selected)
        // AND (no issueTypeId OR matches current Issue Type)
        // AND matches current app type
        const matchesBaseUrl = !def.baseUrlId || def.baseUrlId === currentBaseUrlId;
        
        // Handle both single issueTypeId and array of issueTypeIds
        let matchesIssueType = !def.issueTypeId && !def.tableNameId;
        if (!matchesIssueType && def.issueTypeId) {
          if (Array.isArray(def.issueTypeId)) {
            matchesIssueType = def.issueTypeId.includes(currentIssueTypeId);
          } else {
            matchesIssueType = def.issueTypeId === currentIssueTypeId;
          }
        }
        if (!matchesIssueType && def.tableNameId) {
          matchesIssueType = def.tableNameId === currentIssueTypeId;
        }
        
        // Filter by app type
        let matchesAppType = true;
        if (def.appType) {
          if (isJira && def.appType !== 'jira') matchesAppType = false;
          if (isServiceNow && def.appType !== 'servicenow') matchesAppType = false;
        }
        
        if ((matchesBaseUrl && matchesIssueType && matchesAppType) || def.id === data.fieldId) {
          const option = document.createElement('option');
          option.value = def.id;
          // Add visual indicator for required fields
          option.textContent = def.required ? '‚ö†Ô∏è ' + def.label + ' (Required)' : def.label;
          fieldSelect.appendChild(option);
        }
      });

      if (data.fieldId) {
        fieldSelect.value = data.fieldId;
        // Check if this is a required field
        const fieldDef = definitions.find(d => d.id === data.fieldId);
        if (fieldDef && fieldDef.required) {
          fieldSelect.classList.add('required-field');
          fieldSelect.title = 'Required field for this issue type';
        }
      }
      
      // Update required styling when field changes
      fieldSelect.addEventListener('change', () => {
        const selectedDef = definitions.find(d => d.id === fieldSelect.value);
        if (selectedDef && selectedDef.required) {
          fieldSelect.classList.add('required-field');
          fieldSelect.title = 'Required field for this issue type';
        } else {
          fieldSelect.classList.remove('required-field');
          fieldSelect.title = '';
        }
      });

      // Value input container (will be populated based on field type)
      const valueContainer = document.createElement('div');
      valueContainer.className = 'editor-container';
      valueContainer.style.flex = '1';
      valueContainer.style.minWidth = '0';

      // Function to render the appropriate input based on field type
      const renderFieldInput = (preserveValue = false) => {
        const selectedFieldId = fieldSelect.value;
        const currentDefinitions = loadFieldDefinitions(); // Get fresh definitions
        const fieldDef = currentDefinitions.find(d => d.id === selectedFieldId);
        
        // Save current value if preserving
        let currentValue = '';
        if (preserveValue) {
          const existingInput = valueContainer.querySelector('.rich-value');
          if (existingInput) {
            if (existingInput.tagName === 'SELECT') {
              currentValue = existingInput.value;
            } else if (existingInput.contentEditable === 'true') {
              currentValue = existingInput.innerHTML;
            }
          }
        } else {
          currentValue = data.value || '';
        }
        
        valueContainer.innerHTML = '';
        
        if (!fieldDef || fieldDef.fieldType === 'text' || !fieldDef.fieldType) {
          // Render rich text editor with floating toolbar
          const richValue = document.createElement('div');
          richValue.contentEditable = 'true';
          richValue.className = 'rich-value form-control';
          richValue.style.minHeight = '80px';
          richValue.style.width = '100%';
          richValue.innerHTML = currentValue;
          richValue.oninput = saveState;

          // Create floating toolbar (initially hidden)
          const toolbar = document.createElement('div');
          toolbar.className = 'formatting-toolbar';
          toolbar.id = `toolbar-${Date.now()}`; // Unique ID

          const formatButtons = [
            { icon: 'bi-type-bold', cmd: 'bold', title: 'Bold' },
            { icon: 'bi-type-italic', cmd: 'italic', title: 'Italic' },
            { icon: 'bi-type-underline', cmd: 'underline', title: 'Underline' },
            { icon: 'bi-list-ul', cmd: 'insertUnorderedList', title: 'Bullet List' },
            { icon: 'bi-list-ol', cmd: 'insertOrderedList', title: 'Numbered List' },
            { icon: 'bi-eraser', cmd: 'removeFormat', title: 'Clear Formatting' }
          ];

          formatButtons.forEach(({ icon, cmd, title }) => {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'btn btn-sm';
            btn.innerHTML = `<i class="bi ${icon}"></i>`;
            btn.title = title;
            btn.onclick = (e) => {
              e.preventDefault();
              document.execCommand(cmd, false, null);
              saveState();
            };
            toolbar.appendChild(btn);
          });

          // Show toolbar on text selection
          richValue.addEventListener('mouseup', () => showFloatingToolbar(richValue, toolbar));
          richValue.addEventListener('keyup', () => showFloatingToolbar(richValue, toolbar));
          
          // Store toolbar reference for cleanup
          richValue.dataset.toolbarId = toolbar.id;
          
          // Hide toolbar when clicking outside
          document.addEventListener('click', (e) => {
            if (!toolbar.contains(e.target) && e.target !== richValue && !richValue.contains(e.target)) {
              toolbar.classList.remove('show');
            }
          });

          valueContainer.appendChild(richValue);
          // Append toolbar to body so it can float above everything
          document.body.appendChild(toolbar);
        } else if (fieldDef.fieldType === 'combobox') {
          // Render combobox dropdown
          const comboSelect = document.createElement('select');
          comboSelect.className = 'rich-value form-select';
          comboSelect.style.minHeight = 'auto';
          comboSelect.style.padding = '8px';

          const comboPlaceholder = document.createElement('option');
          comboPlaceholder.value = '';
          comboPlaceholder.textContent = '-- Select Option --';
          comboSelect.appendChild(comboPlaceholder);

          if (fieldDef.options && Array.isArray(fieldDef.options)) {
            fieldDef.options.forEach(opt => {
              const option = document.createElement('option');
              option.value = opt.value;
              option.textContent = opt.label;
              comboSelect.appendChild(option);
            });
          }

          if (currentValue) {
            comboSelect.value = currentValue;
          }
          comboSelect.onchange = saveState;

          valueContainer.appendChild(comboSelect);
        }
      };

      // Initial render
      renderFieldInput(false);

      // Re-render when field selection changes
      fieldSelect.onchange = () => {
        renderFieldInput(false); // Don't preserve value when changing fields
        saveState();
      };

      // Remove button
      const remove = document.createElement('button');
      remove.type = 'button';
      remove.className = 'btn btn-danger';
      remove.innerHTML = '<i class="bi bi-trash"></i>';
      remove.title = 'Remove Field';
      remove.onclick = () => { 
        // Clean up any associated floating toolbar
        const richValue = row.querySelector('.rich-value[data-toolbar-id]');
        if (richValue && richValue.dataset.toolbarId) {
          const toolbar = document.getElementById(richValue.dataset.toolbarId);
          if (toolbar) {
            toolbar.remove();
          }
        }
        fieldsDiv.removeChild(row); 
        saveState(); 
      };

      row.appendChild(fieldSelect);
      row.appendChild(valueContainer);
      row.appendChild(remove);
      fieldsDiv.appendChild(row);
      saveState();
    }

    // Get all field data from rows
    function getFields() {
      const rows = document.querySelectorAll('.field-row');
      return Array.from(rows).map(row => {
        const fieldSelect = row.querySelector('.field-select');
        const fieldId = fieldSelect ? fieldSelect.value : '';
        
        // Check if it's a rich text editor or a combobox
        const richValue = row.querySelector('.rich-value');
        let value = '';
        
        if (richValue) {
          if (richValue.tagName === 'SELECT') {
            // It's a combobox - get the selected value (ID)
            value = richValue.value;
          } else if (richValue.contentEditable === 'true') {
            // It's a rich text editor - get the HTML content
            value = richValue.innerHTML;
          }
        }
        
        return {
          fieldId: fieldId,
          name: fieldId, // Keep name for backward compatibility with URL generation
          value: value
        };
      }).filter(f => f.fieldId);
    }

    // Format value for ServiceNow - pass HTML directly (ServiceNow accepts HTML)
    function smartFormatValue(val) {
      if (!val) return '';
      
      // Check if the value looks like HTML (starts with tags)
      if (!val.match(/<[^>]+>/)) {
          return val;
      }

      // Use DOM traversal to extract text with proper newlines
      const temp = document.createElement('div');
      temp.innerHTML = val;

      function traverse(node) {
        if (node.nodeType === 3) { // Text node
          return node.textContent;
        }
        if (node.nodeType !== 1) return ''; // Not an element

        const tagName = node.tagName.toLowerCase();
        let content = '';
        
        for (const child of node.childNodes) {
          content += traverse(child);
        }

        // Block elements that should force newlines
        const blockTags = ['div', 'p', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'ul', 'ol', 'li', 'blockquote', 'section', 'article', 'header', 'footer', 'tr'];
        
        if (tagName === 'br') {
          return '\n';
        }
        
        if (tagName === 'li') {
          // Add bullet for list items
          return '\n‚Ä¢ ' + content.trim() + '\n';
        }

        if (blockTags.includes(tagName)) {
           return '\n' + content + '\n';
        }

        return content;
      }

      let text = traverse(temp);

      // Clean up excessive newlines
      text = text.replace(/\n\s*\n\s*\n/g, '\n\n');
      text = text.trim();
      
      return text;
    }

    // Generate link based on app type
    document.getElementById('linkForm').onsubmit = function(e) {
      e.preventDefault();
      
      const baseUrlId = document.getElementById('baseUrl').value;
      const baseUrls = loadItems(getStorageKey('baseUrls')) || loadItems('snowSavedBaseUrls') || [];
      const baseUrlItem = baseUrls.find(i => i.id === baseUrlId);
      const baseUrl = baseUrlItem ? baseUrlItem.value.trim().replace(/\/+$/, '') : '';

      if (!baseUrl) {
        alert('Please select a valid Base URL');
        return;
      }

      const issueType = document.getElementById('issueType').value.trim();
      const fields = getFields();
      let url;

      if (currentAppType === 'jira') {
        // Jira link generation
        const projectId = document.getElementById('projectId').value.trim();
        
        url = `${baseUrl}/secure/CreateIssueDetails!init.jspa?pid=${encodeURIComponent(projectId)}&issuetype=${encodeURIComponent(issueType)}`;
        fields.forEach(f => {
          let val = smartFormatValue(f.value);
          if (val) {
            url += `&${encodeURIComponent(f.name)}=${encodeURIComponent(val)}`;
          }
        });
      } else {
        // ServiceNow link generation
        // Build the sysparm_query string using ^ separator
        const queryParts = [];
        fields.forEach(f => {
          let val = smartFormatValue(f.value);
          
          // CLEANING FIX for Issue #8:
          // If a value matches the pattern of a 32-char hex string prefixed with "3D",
          // strip the "3D" prefix. "3D" is the hex code for '=', and users sometimes
          // paste values that include this encoded artifact.
          if (val && val.length === 34 && val.match(/^3D[0-9a-fA-F]{32}$/)) {
              val = val.substring(2);
          }

          if (val) {
            // FIX for Issue #18: Strip table prefix from field name for ServiceNow
            // ServiceNow sysparm_query expects field names without the table prefix
            // e.g., "short_description" not "change_request.short_description"
            let fieldName = f.name;
            if (fieldName.includes('.')) {
              fieldName = fieldName.split('.').pop(); // Get the part after the last dot
            }
            queryParts.push(`${fieldName}=${val}`);
          }
        });

        const queryString = queryParts.join('^');
        
        // Build the ServiceNow URL: https://<BASE_URL>/<ISSUE_TYPE>.do?sys_id=-1&sysparm_query=<ENCODED_QUERY>
        url = `${baseUrl}/${issueType}.do?sys_id=-1`;
        if (queryString) {
          url += `&sysparm_query=${encodeURIComponent(queryString)}`;
        }
      }

      document.getElementById('link').textContent = url;
      
      // Update URL length display
      const urlLengthSpan = document.getElementById('urlLength');
      if (urlLengthSpan) {
        urlLengthSpan.textContent = url.length;
      }
      
      // Auto-copy to clipboard
      copyToClipboard(url);
      
      // Collapse the link details by default
      document.getElementById('linkDetails').style.display = 'none';
      document.getElementById('expandIcon').className = 'bi bi-chevron-down';
      
      // Check for URL length issues (414 Request-URI Too Large)
      const MAX_SAFE_LENGTH = currentAppType === 'jira' ? 2048 : 8200;
      const outputDiv = document.getElementById('output');
      const warningId = 'url-length-warning';
      let warningEl = document.getElementById(warningId);

      if (url.length > MAX_SAFE_LENGTH) {
        if (!warningEl) {
          warningEl = document.createElement('div');
          warningEl.id = warningId;
          warningEl.className = 'alert alert-warning mt-2';
          warningEl.style.cursor = 'default';
          warningEl.onclick = (e) => e.stopPropagation();
          outputDiv.appendChild(warningEl);
        }
        warningEl.innerHTML = `<strong><i class="bi bi-exclamation-triangle"></i> Warning: URL Too Long (${url.length} chars)</strong><br>
        The generated link exceeds ${MAX_SAFE_LENGTH} characters. You may encounter a "414 Request-URI Too Large" error.<br>
        Try reducing the content in rich text fields.`;
      } else if (warningEl) {
        warningEl.remove();
      }

      document.getElementById('output').style.display = 'block';
      saveState();
    };

    function updateAllFieldSelects() {
      const rows = document.querySelectorAll('.field-row');
      const currentBaseUrlId = document.getElementById('baseUrl').value;
      const currentIssueTypeId = document.getElementById('issueType').value;
      const filterByIssueType = document.getElementById('filterFieldsByIssueType').checked;
      const definitions = loadFieldDefinitions();
      
      // Get current app type from body class
      const isJira = document.body.classList.contains('app-jira');
      const isServiceNow = document.body.classList.contains('app-servicenow');
      
      rows.forEach(row => {
        const select = row.querySelector('.field-select');
        if (!select) return;
        
        const currentValue = select.value;
        
        // Check if current value is still valid for the new filters
        let currentValueStillValid = false;
        if (currentValue) {
          const currentDef = definitions.find(d => d.id === currentValue);
          if (currentDef) {
            const matchesBaseUrl = !currentDef.baseUrlId || currentDef.baseUrlId === currentBaseUrlId;
            const matchesIssueType = !filterByIssueType || (!currentDef.issueTypeId || currentDef.issueTypeId === currentIssueTypeId) && (!currentDef.tableNameId || currentDef.tableNameId === currentIssueTypeId);
            let matchesAppType = true;
            if (currentDef.appType) {
              if (isJira && currentDef.appType !== 'jira') matchesAppType = false;
              if (isServiceNow && currentDef.appType !== 'servicenow') matchesAppType = false;
            }
            currentValueStillValid = matchesBaseUrl && matchesIssueType && matchesAppType;
          }
        }
        
        // Clear options except placeholder
        while (select.options.length > 1) {
          select.remove(1);
        }
        
        // Re-populate with filtered options
        definitions.sort((a, b) => a.label.localeCompare(b.label)).forEach(def => {
          const matchesBaseUrl = !def.baseUrlId || def.baseUrlId === currentBaseUrlId;
          const matchesIssueType = !filterByIssueType || (!def.issueTypeId || def.issueTypeId === currentIssueTypeId) && (!def.tableNameId || def.tableNameId === currentIssueTypeId);
          
          // Filter by app type - only show fields for current app
          let matchesAppType = true;
          if (def.appType) {
            if (isJira && def.appType !== 'jira') matchesAppType = false;
            if (isServiceNow && def.appType !== 'servicenow') matchesAppType = false;
          }
          
          if (matchesBaseUrl && matchesIssueType && matchesAppType) {
            const option = document.createElement('option');
            option.value = def.id;
            // Add visual indicator for required fields
            option.textContent = def.required ? '‚ö†Ô∏è ' + def.label + ' (Required)' : def.label;
            select.appendChild(option);
          }
        });
        
        // Restore value ONLY if it's still valid, otherwise clear it
        if (currentValueStillValid) {
          select.value = currentValue;
        } else {
          select.value = ''; // Clear invalid selection
        }
      });
    }
    
    function autoPopulateRequiredFields() {
      const currentIssueTypeId = document.getElementById('issueType').value;
      if (!currentIssueTypeId) {
        console.log('Auto-populate: No issue type selected, skipping');
        return;
      }
      
      const currentBaseUrlId = document.getElementById('baseUrl').value;
      const definitions = loadFieldDefinitions();
      const fieldsDiv = document.getElementById('fields');
      
      // Get current app type
      const isJira = document.body.classList.contains('app-jira');
      const isServiceNow = document.body.classList.contains('app-servicenow');
      
      // Load dropdown entries to match by value (v0.11.2 fix)
      const baseUrls = loadItems(getStorageKey('baseUrls')) || [];
      const issueTypes = loadItems(getStorageKey('issueTypes')) || [];
      
      // Get the actual values for selected IDs
      const selectedBaseUrl = baseUrls.find(bu => bu.id === currentBaseUrlId);
      const selectedIssueType = issueTypes.find(it => it.id === currentIssueTypeId);
      
      console.log('[Auto-populate] Matching criteria:', {
        baseUrlId: currentBaseUrlId,
        baseUrlValue: selectedBaseUrl?.value || selectedBaseUrl?.url,
        issueTypeId: currentIssueTypeId,
        issueTypeValue: selectedIssueType?.value || selectedIssueType?.id
      });
      
      // Find all required fields for this issue type, base URL, AND current app
      const requiredFields = definitions.filter(def => {
        // Issue Type matching: exact match by ID OR by value (v0.11.2)
        let matchesIssueType = !def.issueTypeId && !def.tableNameId; // Global field
        if (!matchesIssueType && (def.issueTypeId || def.tableNameId)) {
          const fieldIssueTypeId = def.issueTypeId || def.tableNameId;
          // Match by ID
          matchesIssueType = fieldIssueTypeId === currentIssueTypeId;
          // OR match by value (for imported fields before dropdown existed)
          if (!matchesIssueType && selectedIssueType) {
            matchesIssueType = fieldIssueTypeId === selectedIssueType.value ||
                              fieldIssueTypeId === selectedIssueType.id;
          }
        } else {
          matchesIssueType = true; // Global field matches all
        }
        
        // Base URL matching: exact match by ID OR by value (v0.11.2)
        let matchesBaseUrl = !def.baseUrlId; // Global field
        if (!matchesBaseUrl && def.baseUrlId) {
          // Match by ID
          matchesBaseUrl = def.baseUrlId === currentBaseUrlId;
          // OR match by value (for imported fields before dropdown existed)
          if (!matchesBaseUrl && selectedBaseUrl) {
            const baseUrlValue = selectedBaseUrl.value || selectedBaseUrl.url;
            matchesBaseUrl = def.baseUrlId === baseUrlValue ||
                            def.baseUrlId.includes(baseUrlValue) ||
                            baseUrlValue.includes(def.baseUrlId);
          }
        } else {
          matchesBaseUrl = true; // Global field matches all
        }
        
        // App Type matching
        let matchesAppType = true;
        if (def.appType) {
          if (isJira && def.appType !== 'jira') matchesAppType = false;
          if (isServiceNow && def.appType !== 'servicenow') matchesAppType = false;
        }
        
        const matches = def.required && matchesIssueType && matchesBaseUrl && matchesAppType;
        if (def.required) {
          console.log('[Auto-populate] Field:', def.label, {
            required: def.required,
            matchesIssueType,
            matchesBaseUrl,
            matchesAppType,
            finalMatch: matches
          });
        }
        return matches;
      });
      
      console.log('=== AUTO-POPULATE DEBUG ===');
      console.log('Selected Base URL ID:', currentBaseUrlId);
      console.log('Selected Issue Type ID:', currentIssueTypeId);
      console.log('Current App:', isJira ? 'Jira' : 'ServiceNow');
      console.log('Total field definitions in storage:', definitions.length);
      console.log('Fields marked as required:', definitions.filter(d => d.required).length);
      
      // Debug each required field's matching
      definitions.filter(d => d.required).forEach(def => {
        console.log('- Field:', def.label, {
          id: def.id,
          issueTypeId: def.issueTypeId,
          baseUrlId: def.baseUrlId,
          appType: def.appType,
          required: def.required
        });
      });
      
      console.log('Auto-populate: Found ' + requiredFields.length + ' required fields matching criteria');
      if (requiredFields.length > 0) {
        console.log('Matching required fields:', requiredFields.map(f => f.label + ' (ID: ' + f.id + ')'));
      }
      
      // If no required fields found, show a message
      if (requiredFields.length === 0) {
        console.log('No required fields detected for this combination. Ensure fields were extracted with v0.7.1+ Field Extractor.');
        return;
      }
      
      // Get currently added field IDs and remove empty field rows
      const existingFieldIds = new Set();
      const emptyRows = [];
      document.querySelectorAll('.field-row').forEach(row => {
        const select = row.querySelector('.field-select');
        if (select && select.value) {
          existingFieldIds.add(select.value);
        } else if (select && !select.value) {
          // Track empty rows to remove after auto-populate
          emptyRows.push(row);
        }
      });
      
      let addedCount = 0;
      
      // Add missing required fields
      requiredFields.forEach(reqField => {
        if (!existingFieldIds.has(reqField.id)) {
          // Add the field automatically
          const data = {
            fieldId: reqField.id,
            fieldValue: ''
          };
          addField(data);
          
          // Set the field select to the required field
          const rows = document.querySelectorAll('.field-row');
          const lastRow = rows[rows.length - 1];
          if (lastRow) {
            const select = lastRow.querySelector('.field-select');
            if (select) {
              select.value = reqField.id;
              // Trigger change to update field type
              select.dispatchEvent(new Event('change'));
              addedCount++;
            }
          }
        }
      });
      
      // Remove empty field rows after auto-populating
      if (addedCount > 0 && emptyRows.length > 0) {
        console.log('Removing ' + emptyRows.length + ' empty field row(s)');
        emptyRows.forEach(row => row.remove());
      }
      
      // Show notification if fields were added
      if (addedCount > 0) {
        showNotification('‚úì Auto-added ' + addedCount + ' required field(s)', 'success');
      }
    }
    
    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.style.cssText = 
        'position: fixed;' +
        'top: 20px;' +
        'right: 20px;' +
        'padding: 12px 20px;' +
        'background: ' + (type === 'success' ? '#27ae60' : '#3498db') + ';' +
        'color: white;' +
        'border-radius: 4px;' +
        'box-shadow: 0 2px 8px rgba(0,0,0,0.2);' +
        'z-index: 10000;' +
        'animation: slideIn 0.3s ease-out;';
      notification.textContent = message;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease-out';
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }

    // ========================================================================
    // FIELD MANAGER - Modal UI Functions
    // ========================================================================

    function openFieldManager() {
      const modal = document.getElementById('fieldManagerModal');
      modal.style.display = 'flex';
      
      // Update ignored fields count
      updateIgnoredFieldsCount();
      
      // Populate Base URL select
      const select = document.getElementById('fieldBaseUrlSelect');
      select.innerHTML = '<option value="">All Instances (Global)</option>';
      const items = loadItems(getStorageKey('baseUrls')) || [];
      items.forEach(item => {
        const option = document.createElement('option');
        option.value = item.id;
        option.textContent = `${item.alias} (${item.value})`;
        select.appendChild(option);
      });

      // Populate Issue Type select
      const issueTypeSelect = document.getElementById('fieldIssueTypeSelect');
      issueTypeSelect.innerHTML = '<option value="">All Issue Types (Global)</option>';
      const issueTypeItems = loadItems(getStorageKey('issueTypes')) || [];
      issueTypeItems.forEach(item => {
        const option = document.createElement('option');
        // Use item.value to match the currentIssueTypeId retrieved from document.getElementById('issueType').value
        option.value = item.value;
        option.textContent = `${item.alias} (${item.value})`;
        issueTypeSelect.appendChild(option);
      });

      refreshConfigItemsList();
      refreshIssueTypesListInModal();
      refreshFieldsList();
    }

    function closeFieldManager() {
      const modal = document.getElementById('fieldManagerModal');
      modal.style.display = 'none';
      cancelEditField();
    }

    function addIssueTypeDefinition() {
      const alias = document.getElementById('issueTypeAliasInput').value.trim();
      const value = document.getElementById('issueTypeValueInput').value.trim();
      
      if (!alias || !value) {
        alert('Please provide both display name and ID/value');
        return;
      }
      
      const issueTypes = loadItems(getStorageKey('issueTypes')) || [];
      
      // Check for duplicates
      if (issueTypes.some(it => it.value === value)) {
        alert('An issue type with this ID/value already exists');
        return;
      }
      
      const newIssueType = {
        id: 'it_' + Date.now(),
        alias: alias,
        value: value
      };
      
      issueTypes.push(newIssueType);
      saveItems(getStorageKey('issueTypes'), issueTypes);
      
      // Clear inputs
      document.getElementById('issueTypeAliasInput').value = '';
      document.getElementById('issueTypeValueInput').value = '';
      
      // Refresh displays
      refreshIssueTypesListInModal();
      populateIssueTypeDropdown();
      
      // Refresh the issue type select in the modal
      const issueTypeSelect = document.getElementById('fieldIssueTypeSelect');
      issueTypeSelect.innerHTML = '<option value="">All Issue Types (Global)</option>';
      const issueTypeItems = loadItems(getStorageKey('issueTypes')) || [];
      issueTypeItems.forEach(item => {
        const option = document.createElement('option');
        option.value = item.value;
        option.textContent = `${item.alias} (${item.value})`;
        issueTypeSelect.appendChild(option);
      });
    }

    function refreshIssueTypesListInModal() {
      const issueTypes = loadItems(getStorageKey('issueTypes')) || [];
      const list = document.getElementById('issueTypesListInModal');
      
      if (issueTypes.length === 0) {
        list.innerHTML = '<p style="color:#999;text-align:center;padding:12px;margin:0;font-size:0.9em;">No issue types yet. Add one above.</p>';
        return;
      }
      
      let html = '';
      issueTypes.forEach(it => {
        html += `
          <div style="display:flex;justify-content:space-between;align-items:center;padding:8px;background:#fff;margin-bottom:4px;border-radius:4px;border:1px solid #dee2e6;">
            <div style="font-size:0.9em;">
              <strong>${it.alias}</strong> <span style="color:#666;">‚Ä¢ ${it.value}</span>
            </div>
            <button onclick="deleteIssueTypeFromModal('${it.id}')" style="background:#e74c3c;color:#fff;border:none;border-radius:4px;padding:4px 10px;cursor:pointer;font-size:0.8em;">Delete</button>
          </div>
        `;
      });
      
      list.innerHTML = html;
    }

    function deleteIssueTypeFromModal(itId) {
      if (!confirm('Delete this issue type?')) return;
      
      const issueTypes = loadItems(getStorageKey('issueTypes')) || [];
      const filtered = issueTypes.filter(it => it.id !== itId);
      saveItems(getStorageKey('issueTypes'), filtered);
      
      refreshIssueTypesListInModal();
      populateIssueTypeDropdown();
      
      // Refresh the issue type select in the modal
      const issueTypeSelect = document.getElementById('fieldIssueTypeSelect');
      issueTypeSelect.innerHTML = '<option value="">All Issue Types (Global)</option>';
      const issueTypeItems = loadItems(getStorageKey('issueTypes')) || [];
      issueTypeItems.forEach(item => {
        const option = document.createElement('option');
        option.value = item.value;
        option.textContent = `${item.alias} (${item.value})`;
        issueTypeSelect.appendChild(option);
      });
    }

    // ========================================================================
    // IGNORED FIELDS MANAGER
    // ========================================================================
    
    function openIgnoredFieldsManager() {
      const modal = document.getElementById('ignoredFieldsModal');
      modal.style.display = 'flex';
      refreshIgnoredFieldsList();
    }
    
    function closeIgnoredFieldsManager() {
      const modal = document.getElementById('ignoredFieldsModal');
      modal.style.display = 'none';
      // Refresh main field manager to update counts
      refreshFieldsList();
      updateIgnoredFieldsCount();
    }
    
    function refreshIgnoredFieldsList() {
      const list = document.getElementById('ignoredFieldsList');
      const allFields = loadAllFieldDefinitions();
      const ignoredFields = allFields.filter(f => f.ignored);
      const searchTerm = document.getElementById('ignoredFieldSearchInput')?.value.toLowerCase() || '';
      
      list.innerHTML = '';
      
      if (ignoredFields.length === 0) {
        list.innerHTML = '<div style="color:#999;text-align:center;padding:20px;">No ignored fields</div>';
        return;
      }
      
      ignoredFields.filter(field => {
        if (!searchTerm) return true;
        return field.label.toLowerCase().includes(searchTerm) || 
               field.id.toLowerCase().includes(searchTerm);
      }).forEach(field => {
        const row = document.createElement('div');
        row.style.cssText = 'display:flex;gap:8px;align-items:center;padding:8px;border-bottom:1px solid #ddd;background:#fff;margin-bottom:4px;border-radius:4px;';
        
        // Checkbox
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'ignored-field-checkbox';
        checkbox.dataset.fieldId = field.id;
        checkbox.style.cssText = 'cursor:pointer;';
        
        // Field info
        const info = document.createElement('div');
        info.style.cssText = 'flex:1;';
        
        let badges = '';
        if (field.appType) {
          const appColor = field.appType === 'jira' ? '#5dade2' : '#45b7d1';
          badges += `<span style="font-size:0.75em;background:${appColor};color:#fff;padding:2px 6px;border-radius:3px;margin-left:4px;">${field.appType.toUpperCase()}</span>`;
        }
        
        const ignoredDate = field.ignoredAt ? new Date(field.ignoredAt).toLocaleDateString() : 'Unknown';
        const reason = field.ignoredReason || 'manual';
        
        info.innerHTML = `
          <div style="font-weight:500;">${escapeHtml(field.label)}${badges}</div>
          <div style="font-size:0.85em;color:#666;">${escapeHtml(field.id)}</div>
          <div style="font-size:0.75em;color:#999;">Ignored on ${ignoredDate} (${reason})</div>
        `;
        
        // Un-ignore button
        const unignoreBtn = document.createElement('button');
        unignoreBtn.textContent = 'Un-ignore';
        unignoreBtn.style.cssText = 'background:#27ae60;color:#fff;border:none;border-radius:4px;padding:6px 12px;cursor:pointer;font-size:0.85em;';
        unignoreBtn.onclick = function() {
          unignoreField(field.id);
        };
        
        row.appendChild(checkbox);
        row.appendChild(info);
        row.appendChild(unignoreBtn);
        list.appendChild(row);
      });
    }
    
    function filterIgnoredFieldsList() {
      refreshIgnoredFieldsList();
    }
    
    function unignoreField(fieldId) {
      const allFields = loadAllFieldDefinitions();
      const field = allFields.find(f => f.id === fieldId);
      
      if (field) {
        field.ignored = false;
        delete field.ignoredAt;
        delete field.ignoredReason;
        localStorage.setItem(getStorageKey('fieldDefinitions'), JSON.stringify(allFields));
        refreshIgnoredFieldsList();
        updateIgnoredFieldsCount();
        showNotification('‚úì Field un-ignored: ' + field.label, 'success');
      }
    }
    
    function bulkUnignoreFields() {
      const checkboxes = document.querySelectorAll('.ignored-field-checkbox:checked');
      if (checkboxes.length === 0) {
        alert('Please select fields to un-ignore.');
        return;
      }
      
      if (!confirm(`Un-ignore ${checkboxes.length} field(s)?`)) {
        return;
      }
      
      const allFields = loadAllFieldDefinitions();
      let count = 0;
      
      checkboxes.forEach(cb => {
        const fieldId = cb.dataset.fieldId;
        const field = allFields.find(f => f.id === fieldId);
        if (field) {
          field.ignored = false;
          delete field.ignoredAt;
          delete field.ignoredReason;
          count++;
        }
      });
      
      localStorage.setItem(getStorageKey('fieldDefinitions'), JSON.stringify(allFields));
      refreshIgnoredFieldsList();
      updateIgnoredFieldsCount();
      showNotification(`‚úì Un-ignored ${count} field(s)`, 'success');
    }
    
    function clearAllIgnoredFields() {
      const allFields = loadAllFieldDefinitions();
      const ignoredCount = allFields.filter(f => f.ignored).length;
      
      if (ignoredCount === 0) {
        alert('No ignored fields to clear.');
        return;
      }
      
      if (!confirm(`Un-ignore all ${ignoredCount} field(s)? This cannot be undone.`)) {
        return;
      }
      
      allFields.forEach(field => {
        if (field.ignored) {
          field.ignored = false;
          delete field.ignoredAt;
          delete field.ignoredReason;
        }
      });
      
      localStorage.setItem(getStorageKey('fieldDefinitions'), JSON.stringify(allFields));
      refreshIgnoredFieldsList();
      updateIgnoredFieldsCount();
      showNotification(`‚úì Cleared all ${ignoredCount} ignored field(s)`, 'success');
    }
    
    function updateIgnoredFieldsCount() {
      const allFields = loadAllFieldDefinitions();
      const ignoredCount = allFields.filter(f => f.ignored).length;
      const countSpan = document.getElementById('ignoredFieldsCount');
      if (countSpan) {
        countSpan.textContent = ignoredCount;
      }
    }

    // ========================================================================
    // FIELD OPTIMIZATION TOOL (GLOBAL FIELD DETECTION)
    // ========================================================================
    
    function analyzeFieldDuplicates() {
      const allFields = loadAllFieldDefinitions();
      const activeFields = allFields.filter(f => !f.ignored);
      
      // Group fields by ID, baseUrlId, AND appType to find duplicates
      // This ensures Jira and ServiceNow fields are kept separate
      const fieldGroups = new Map();
      
      activeFields.forEach(field => {
        const key = `${field.id}|${field.baseUrlId || 'global'}|${field.appType || 'unknown'}`;
        if (!fieldGroups.has(key)) {
          fieldGroups.set(key, []);
        }
        fieldGroups.get(key).push(field);
      });
      
      // Analyze each group for duplicates
      const duplicateGroups = [];
      const savedIssueTypes = loadItems(getStorageKey('issueTypes')) || [];
      
      fieldGroups.forEach((instances, key) => {
        const [fieldId, baseUrlId, appType] = key.split('|');
        
        // Get unique issue types from all instances
        const issueTypes = new Set();
        let hasGlobal = false;
        
        instances.forEach(inst => {
          // Handle both single issueTypeId and array of issueTypeIds
          if (inst.issueTypeId) {
            if (Array.isArray(inst.issueTypeId)) {
              inst.issueTypeId.forEach(id => issueTypes.add(id));
            } else {
              issueTypes.add(inst.issueTypeId);
            }
          } else {
            hasGlobal = true;
          }
        });
        
        // Consider as duplicate if:
        // 1. Multiple instances with same ID (regardless of issue type)
        // 2. OR single instance but has multiple issue types in array
        const shouldConsiderDuplicate = instances.length > 1 || 
          (instances.length === 1 && instances[0].issueTypeId && Array.isArray(instances[0].issueTypeId) && instances[0].issueTypeId.length > 1);
        
        if (shouldConsiderDuplicate && (issueTypes.size >= 2 || hasGlobal)) {
          const label = instances[0].label;
          const appType = instances[0].appType;
          const isRequired = instances.some(i => i.required);
          
          // Get issue type labels
          const issueTypeLabels = Array.from(issueTypes).map(itId => {
            const match = savedIssueTypes.find(it => it.id === itId);
            return match ? match.name || match.alias || itId : itId;
          });
          
          // Check if this field appears in all known issue types (recommend global)
          const allIssueTypeIds = savedIssueTypes.map(it => it.id);
          const appearsInAllTypes = allIssueTypeIds.length > 0 && 
            allIssueTypeIds.every(id => issueTypes.has(id));
          
          duplicateGroups.push({
            fieldId: fieldId,
            label: label,
            appType: appType,
            baseUrlId: baseUrlId === 'global' ? null : baseUrlId,
            instanceCount: instances.length,
            issueTypeCount: issueTypes.size,
            issueTypes: Array.from(issueTypes),
            issueTypeLabels: issueTypeLabels,
            isRequired: isRequired,
            hasGlobal: hasGlobal,
            appearsInAllTypes: appearsInAllTypes,
            instances: instances,
            recommendMerge: issueTypes.size >= 2,
            recommendGlobal: appearsInAllTypes || issueTypes.size >= 4
          });
        }
      });
      
      // Sort by instance count (most duplicated first)
      duplicateGroups.sort((a, b) => b.instanceCount - a.instanceCount);
      
      return {
        totalGroups: duplicateGroups.length,
        recommended: duplicateGroups.filter(g => g.recommendMerge).length,
        groups: duplicateGroups
      };
    }
    
    function openFieldOptimization() {
      const analysis = analyzeFieldDuplicates();
      
      if (analysis.totalGroups === 0) {
        alert('No duplicate fields found. Import fields from multiple issue types to see optimization opportunities.');
        return;
      }
      
      const modal = document.getElementById('fieldOptimizationModal');
      modal.style.display = 'flex';
      
      // Update stats
      document.getElementById('optimizationStats').textContent = 
        `Found ${analysis.totalGroups} duplicate groups, ${analysis.recommended} recommended for merging`;
      
      // Populate list
      refreshOptimizationList(analysis);
    }
    
    function closeFieldOptimization() {
      const modal = document.getElementById('fieldOptimizationModal');
      modal.style.display = 'none';
    }
    
    function refreshOptimizationList(analysis) {
      const list = document.getElementById('optimizationList');
      list.innerHTML = '';
      
      if (analysis.groups.length === 0) {
        list.innerHTML = '<div style="color:#999;text-align:center;padding:20px;">No duplicate fields found</div>';
        return;
      }
      
      analysis.groups.forEach((group, index) => {
        const row = document.createElement('div');
        row.style.cssText = 'background:#fff;border:1px solid #ddd;border-radius:8px;padding:16px;margin-bottom:12px;';
        
        // Checkbox for bulk operations
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'optimization-checkbox';
        checkbox.dataset.groupIndex = index;
        checkbox.checked = group.recommendMerge;
        checkbox.style.cssText = 'cursor:pointer;margin-right:12px;';
        
        // Field info
        const info = document.createElement('div');
        info.style.cssText = 'flex:1;';
        
        let badges = '';
        if (group.appType) {
          const appColor = group.appType === 'jira' ? '#5dade2' : '#45b7d1';
          badges += `<span style="font-size:0.75em;background:${appColor};color:#fff;padding:2px 6px;border-radius:3px;margin-left:4px;">${group.appType.toUpperCase()}</span>`;
        }
        if (group.isRequired) {
          badges += `<span style="font-size:0.75em;background:#e74c3c;color:#fff;padding:2px 6px;border-radius:3px;margin-left:4px;">REQUIRED</span>`;
        }
        if (group.recommendMerge) {
          badges += `<span style="font-size:0.75em;background:#27ae60;color:#fff;padding:2px 6px;border-radius:3px;margin-left:4px;">‚úì RECOMMENDED</span>`;
        }
        
        // Add recommendation badge if this should be global
        if (group.recommendGlobal) {
          badges += `<span style="font-size:0.75em;background:#f39c12;color:#fff;padding:2px 6px;border-radius:3px;margin-left:4px;">‚≠ê SUGGEST GLOBAL</span>`;
        }
        
        info.innerHTML = `
          <div style="display:flex;align-items:center;margin-bottom:8px;">
            ${escapeHtml(group.label)}${badges}
          </div>
          <div style="font-size:0.85em;color:#666;margin-bottom:4px;">ID: ${escapeHtml(group.fieldId)}</div>
          <div style="font-size:0.85em;color:#666;">
            ${group.instanceCount} instances across ${group.issueTypeCount} issue types: 
            ${group.issueTypeLabels.join(', ')}
          </div>
        `;
        
        // Merge buttons container
        const btnContainer = document.createElement('div');
        btnContainer.style.cssText = 'display:flex;gap:8px;margin-left:12px;';
        
        // Merge to Multi-Type button
        const mergeMultiBtn = document.createElement('button');
        mergeMultiBtn.textContent = 'Merge';
        mergeMultiBtn.title = 'Merge into one field with multiple issue types';
        mergeMultiBtn.style.cssText = 'background:#9b59b6;color:#fff;border:none;border-radius:4px;padding:8px 16px;cursor:pointer;font-size:0.9em;';
        mergeMultiBtn.onclick = function() {
          mergeToMultiType([group]);
        };
        
        // Make Global button
        const makeGlobalBtn = document.createElement('button');
        makeGlobalBtn.textContent = group.recommendGlobal ? '‚≠ê Global' : 'Global';
        makeGlobalBtn.title = 'Merge into one global field (all issue types)';
        makeGlobalBtn.style.cssText = `background:${group.recommendGlobal ? '#f39c12' : '#3498db'};color:#fff;border:none;border-radius:4px;padding:8px 16px;cursor:pointer;font-size:0.9em;`;
        makeGlobalBtn.onclick = function() {
          mergeToGlobal([group]);
        };
        
        btnContainer.appendChild(mergeMultiBtn);
        btnContainer.appendChild(makeGlobalBtn);
        
        const container = document.createElement('div');
        container.style.cssText = 'display:flex;align-items:center;';
        container.appendChild(checkbox);
        container.appendChild(info);
        container.appendChild(btnContainer);
        
        row.appendChild(container);
        list.appendChild(row);
      });
      
      // Store analysis for later use
      window.currentOptimizationAnalysis = analysis;
    }
    
    function mergeToGlobal(groups) {
      if (groups.length === 0) return;
      
      const fieldNames = groups.map(g => g.label).join(', ');
      const count = groups.reduce((sum, g) => sum + g.instanceCount, 0);
      
      if (!confirm(`Merge ${groups.length} field(s) (${fieldNames}) to global?\n\nThis will keep 1 global instance and remove ${count - groups.length} duplicates.`)) {
        return;
      }
      
      // Create backup
      const allFields = loadAllFieldDefinitions();
      localStorage.setItem('lastFieldOptimizationBackup', JSON.stringify(allFields));
      
      let mergedCount = 0;
      
      groups.forEach(group => {
        // Analyze instances to pick the best field type and merge options
        const fieldTypes = new Set(group.instances.map(i => i.fieldType || 'text'));
        const hasCombobox = fieldTypes.has('combobox');
        
        // Pick the most feature-rich field type (combobox > text)
        const finalFieldType = hasCombobox ? 'combobox' : Array.from(fieldTypes)[0];
        
        // Use existing global instance as template, or first instance
        const template = group.instances.find(i => !i.issueTypeId) || group.instances[0];
        
        // Build clean global field explicitly (don't use spread to avoid copying unwanted properties)
        const globalField = {
          id: template.id,
          label: template.label,
          fieldType: finalFieldType,
          required: group.instances.some(i => i.required), // Most permissive
          appType: template.appType
        };
        
        // Add baseUrlId if it exists
        if (template.baseUrlId) {
          globalField.baseUrlId = template.baseUrlId;
        }
        
        // Merge options only if final type is combobox
        if (finalFieldType === 'combobox') {
          const optionsMap = new Map();
          group.instances.forEach(inst => {
            if (inst.options && Array.isArray(inst.options)) {
              inst.options.forEach(opt => {
                const key = `${opt.value}|${opt.label}`;
                if (!optionsMap.has(key)) {
                  optionsMap.set(key, opt);
                }
              });
            }
          });
          if (optionsMap.size > 0) {
            globalField.options = Array.from(optionsMap.values());
          }
        }
        // Don't add options property at all if not combobox
        
        // Remove all instances of this field
        const filtered = allFields.filter(f => f.id !== group.fieldId);
        
        // Add back the single global instance
        filtered.push(globalField);
        
        // Save
        localStorage.setItem(getStorageKey('fieldDefinitions'), JSON.stringify(filtered));
        
        mergedCount += group.instanceCount - 1;
      });
      
      showNotification(`‚úì Merged ${groups.length} field(s), removed ${mergedCount} duplicates`, 'success');
      
      // Refresh the analysis
      const newAnalysis = analyzeFieldDuplicates();
      refreshOptimizationList(newAnalysis);
      
      // Update stats
      document.getElementById('optimizationStats').textContent = 
        `Found ${newAnalysis.totalGroups} duplicate groups, ${newAnalysis.recommended} recommended for merging`;
      
      // Refresh field manager if open
      refreshFieldsList();
    }
    
    function mergeToMultiType(groups) {
      if (groups.length === 0) return;
      
      const fieldNames = groups.map(g => g.label).join(', ');
      const totalInstances = groups.reduce((sum, g) => sum + g.instanceCount, 0);
      
      if (!confirm(`Merge ${groups.length} field(s) (${fieldNames}) to multi-issue-type?\n\nThis will keep 1 instance with multiple issue types and remove ${totalInstances - groups.length} duplicates.`)) {
        return;
      }
      
      // Create backup
      const allFields = loadAllFieldDefinitions();
      localStorage.setItem('lastFieldOptimizationBackup', JSON.stringify(allFields));
      
      let mergedCount = 0;
      
      groups.forEach(group => {
        // Analyze instances to pick the best field type
        const fieldTypes = new Set(group.instances.map(i => i.fieldType || 'text'));
        const hasCombobox = fieldTypes.has('combobox');
        
        // Pick the most feature-rich field type (combobox > text)
        const finalFieldType = hasCombobox ? 'combobox' : Array.from(fieldTypes)[0];
        
        // Build clean merged field explicitly (don't use spread)
        const template = group.instances[0];
        const mergedField = {
          id: template.id,
          label: template.label,
          fieldType: finalFieldType,
          issueTypeId: group.issueTypes, // Array of all issue type IDs
          issueTypeLabel: group.issueTypeLabels.join(', '), // Combined labels for display
          required: group.instances.some(i => i.required), // Most permissive
          appType: template.appType
        };
        
        // Add baseUrlId if it exists
        if (template.baseUrlId) {
          mergedField.baseUrlId = template.baseUrlId;
        }
        
        // Merge options only if final type is combobox
        if (finalFieldType === 'combobox') {
          const optionsMap = new Map();
          group.instances.forEach(inst => {
            if (inst.options && Array.isArray(inst.options)) {
              inst.options.forEach(opt => {
                const key = `${opt.value}|${opt.label}`;
                if (!optionsMap.has(key)) {
                  optionsMap.set(key, opt);
                }
              });
            }
          });
          if (optionsMap.size > 0) {
            mergedField.options = Array.from(optionsMap.values());
          }
        }
        // Don't add options property at all if not combobox
        
        // Remove all instances of this field with matching baseUrlId
        const filtered = allFields.filter(f => {
          if (f.id !== group.fieldId) return true;
          if (group.baseUrlId && f.baseUrlId !== group.baseUrlId) return true;
          return false;
        });
        
        // Add back the single merged instance
        filtered.push(mergedField);
        
        // Save
        localStorage.setItem(getStorageKey('fieldDefinitions'), JSON.stringify(filtered));
        
        mergedCount += group.instanceCount - 1;
      });
      
      showNotification(`‚úì Merged ${groups.length} field(s) to multi-type, removed ${mergedCount} duplicates`, 'success');
      
      // Refresh the analysis
      const newAnalysis = analyzeFieldDuplicates();
      refreshOptimizationList(newAnalysis);
      
      // Update stats
      document.getElementById('optimizationStats').textContent = 
        `Found ${newAnalysis.totalGroups} duplicate groups, ${newAnalysis.recommended} recommended for merging`;
      
      // Refresh field manager if open
      refreshFieldsList();
    }
    
    function mergeSelectedToGlobal() {
      if (!window.currentOptimizationAnalysis) return;
      
      const checkboxes = document.querySelectorAll('.optimization-checkbox:checked');
      if (checkboxes.length === 0) {
        alert('Please select fields to merge.');
        return;
      }
      
      const selectedGroups = [];
      checkboxes.forEach(cb => {
        const index = parseInt(cb.dataset.groupIndex);
        selectedGroups.push(window.currentOptimizationAnalysis.groups[index]);
      });
      
      mergeToGlobal(selectedGroups);
    }
    
    function mergeSelectedToMultiType() {
      if (!window.currentOptimizationAnalysis) return;
      
      const checkboxes = document.querySelectorAll('.optimization-checkbox:checked');
      if (checkboxes.length === 0) {
        alert('Please select fields to merge.');
        return;
      }
      
      const selectedGroups = [];
      checkboxes.forEach(cb => {
        const index = parseInt(cb.dataset.groupIndex);
        selectedGroups.push(window.currentOptimizationAnalysis.groups[index]);
      });
      
      mergeToMultiType(selectedGroups);
    }
    
    function undoLastOptimization() {
      const backup = localStorage.getItem('lastFieldOptimizationBackup');
      if (!backup) {
        alert('No optimization to undo.');
        return;
      }
      
      if (!confirm('Undo last field optimization? This will restore all merged fields.')) {
        return;
      }
      
      try {
        const restoredFields = JSON.parse(backup);
        localStorage.setItem(getStorageKey('fieldDefinitions'), JSON.stringify(restoredFields));
        localStorage.removeItem('lastFieldOptimizationBackup');
        
        showNotification('‚úì Optimization undone, fields restored', 'success');
        
        // Refresh the analysis
        const newAnalysis = analyzeFieldDuplicates();
        refreshOptimizationList(newAnalysis);
        
        document.getElementById('optimizationStats').textContent = 
          `Found ${newAnalysis.totalGroups} duplicate groups, ${newAnalysis.recommended} recommended for merging`;
        
        refreshFieldsList();
      } catch (e) {
        alert('Error restoring fields: ' + e.message);
      }
    }

    function cleanupFieldDataIntegrity() {
      if (!confirm('Clean up field data integrity?\n\nThis will:\n- Remove options from non-combobox fields\n- Fix any other data inconsistencies\n\nA backup will be created automatically.')) {
        return;
      }
      
      try {
        // Create backup
        const allFields = loadAllFieldDefinitions();
        localStorage.setItem('lastFieldCleanupBackup', JSON.stringify(allFields));
        
        let fixedCount = 0;
        const cleaned = allFields.map(field => {
          let fixed = false;
          
          // Build clean field object
          const cleanField = {
            id: field.id,
            label: field.label,
            fieldType: field.fieldType || 'text'
          };
          
          // Preserve valid properties
          if (field.appType) cleanField.appType = field.appType;
          if (field.baseUrlId) cleanField.baseUrlId = field.baseUrlId;
          if (field.issueTypeId) cleanField.issueTypeId = field.issueTypeId;
          if (field.issueTypeLabel) cleanField.issueTypeLabel = field.issueTypeLabel;
          if (field.tableNameId) cleanField.tableNameId = field.tableNameId;
          if (field.required) cleanField.required = field.required;
          if (field.ignored) cleanField.ignored = field.ignored;
          
          // Only add options if field type is combobox
          if (cleanField.fieldType === 'combobox') {
            if (field.options && Array.isArray(field.options) && field.options.length > 0) {
              cleanField.options = field.options;
            }
          } else {
            // Check if we're removing options (means field was corrupted)
            if (field.options && Array.isArray(field.options) && field.options.length > 0) {
              fixed = true;
            }
          }
          
          if (fixed) fixedCount++;
          return cleanField;
        });
        
        // Save cleaned data
        localStorage.setItem(getStorageKey('fieldDefinitions'), JSON.stringify(cleaned));
        
        if (fixedCount > 0) {
          showNotification(`‚úì Cleaned ${fixedCount} field(s) with data integrity issues`, 'success');
        } else {
          showNotification('‚úì No integrity issues found - all fields are clean!', 'success');
        }
        
        // Refresh displays
        const newAnalysis = analyzeFieldDuplicates();
        refreshOptimizationList(newAnalysis);
        document.getElementById('optimizationStats').textContent = 
          `Found ${newAnalysis.totalGroups} duplicate groups, ${newAnalysis.recommended} recommended for merging`;
        refreshFieldsList();
        loadFieldsManagement(); // Refresh Config Management
        
      } catch (e) {
        alert('Error cleaning up fields: ' + e.message);
      }
    }

    function editFieldDefinition(index) {
      const definitions = loadFieldDefinitions();
      const def = definitions[index];
      if (!def) return;

      currentEditingFieldIndex = index;
      document.getElementById('fieldIdInput').value = def.id;
      document.getElementById('fieldIdInput').disabled = true;
      document.getElementById('fieldLabelInput').value = def.label;
      document.getElementById('fieldTypeSelect').value = def.fieldType || 'text';
      document.getElementById('fieldBaseUrlSelect').value = def.baseUrlId || '';
      document.getElementById('fieldIssueTypeSelect').value = def.issueTypeId || def.tableNameId || '';
      document.getElementById('fieldRequiredCheckbox').checked = def.required || false;
      currentComboboxOptions = def.options || [];
      toggleFieldTypeOptions();
      document.getElementById('fieldLabelInput').focus();

      const addBtn = document.getElementById('addFieldBtn');
      const cancelBtn = document.getElementById('cancelEditFieldBtn');
      addBtn.textContent = 'Update';
      addBtn.style.background = '#27ae60';
      addBtn.onclick = () => addFieldDefinition();
      cancelBtn.style.display = 'inline-block';
    }

    function cancelEditField() {
      currentEditingFieldIndex = null;
      currentComboboxOptions = [];
      document.getElementById('fieldIdInput').value = '';
      document.getElementById('fieldIdInput').disabled = false;
      document.getElementById('fieldLabelInput').value = '';
      document.getElementById('fieldTypeSelect').value = 'text';
      document.getElementById('fieldBaseUrlSelect').value = '';
      document.getElementById('fieldIssueTypeSelect').value = '';
      document.getElementById('fieldRequiredCheckbox').checked = false;
      toggleFieldTypeOptions();
      const addBtn = document.getElementById('addFieldBtn');
      const cancelBtn = document.getElementById('cancelEditFieldBtn');
      addBtn.textContent = 'Add';
      addBtn.style.background = '#3498db';
      addBtn.onclick = () => addFieldDefinition();
      cancelBtn.style.display = 'none';
    }

    // Field Type & Combobox Options Management
    let currentComboboxOptions = [];

    function toggleFieldTypeOptions() {
      const fieldType = document.getElementById('fieldTypeSelect').value;
      const optionsSection = document.getElementById('comboboxOptionsSection');
      optionsSection.style.display = fieldType === 'combobox' ? 'block' : 'none';
      if (fieldType === 'combobox') {
        refreshComboboxOptionsList();
      }
    }

    function addComboboxOption() {
      const labelInput = document.getElementById('optionLabelInput');
      const valueInput = document.getElementById('optionValueInput');
      const label = labelInput.value.trim();
      const value = valueInput.value.trim();

      if (!label || !value) {
        alert('Both label and value are required');
        return;
      }

      currentComboboxOptions.push({ label, value });
      labelInput.value = '';
      valueInput.value = '';
      refreshComboboxOptionsList();
    }

    function removeComboboxOption(index) {
      currentComboboxOptions.splice(index, 1);
      refreshComboboxOptionsList();
    }

    function refreshComboboxOptionsList() {
      const list = document.getElementById('comboboxOptionsList');
      list.innerHTML = '';

      if (currentComboboxOptions.length === 0) {
        list.innerHTML = '<div style="color:#999;font-size:0.85em;padding:4px;">No options added</div>';
        return;
      }

      currentComboboxOptions.forEach((opt, index) => {
        const row = document.createElement('div');
        row.className = 'combobox-option-row';
        row.style.cssText = 'display:flex;gap:8px;align-items:center;padding:4px;border-bottom:1px solid #ddd;';
        
        const info = document.createElement('div');
        info.style.cssText = 'flex:1;font-size:0.85em;';
        info.innerHTML = `<strong>${escapeHtml(opt.label)}</strong> ‚Üí ${escapeHtml(opt.value)}`;
        
        const deleteBtn = document.createElement('button');
        deleteBtn.type = 'button';
        deleteBtn.textContent = '√ó';
        deleteBtn.style.cssText = 'background:#e74c3c;color:#fff;border:none;border-radius:4px;padding:2px 8px;cursor:pointer;font-size:1.2em;line-height:1;';
        deleteBtn.onclick = () => removeComboboxOption(index);
        
        row.appendChild(info);
        row.appendChild(deleteBtn);
        list.appendChild(row);
      });
    }

    function refreshConfigItemsList() {
      const configItemsList = document.getElementById('configItemsList');
      const items = loadConfigurationItems();

      configItemsList.innerHTML = '';
      if (items.length === 0) {
        configItemsList.innerHTML = '<div style="color:#999;">No configuration items</div>';
        return;
      }

      items.forEach((item, index) => {
        const row = document.createElement('div');
        row.style.cssText = 'display:flex;gap:8px;align-items:center;padding:6px;border-bottom:1px solid #eee;justify-content:space-between;';

        const info = document.createElement('div');
        info.style.cssText = 'flex:1;font-size:0.9em;';
        info.innerHTML = `<div style="font-weight:500;font-size:0.95em;">${escapeHtml(item.label)}</div><div style="color:#666;font-size:0.85em;">${escapeHtml(item.id)}</div>`;

        const buttons = document.createElement('div');
        buttons.style.cssText = 'display:flex;gap:4px;';

        const editBtn = document.createElement('button');
        editBtn.type = 'button';
        editBtn.textContent = 'Edit';
        editBtn.style.cssText = 'background:#3498db;color:#fff;border:none;border-radius:4px;padding:4px 8px;cursor:pointer;font-size:0.85em;';
        editBtn.onclick = () => editConfigurationItem(index);

        const deleteBtn = document.createElement('button');
        deleteBtn.type = 'button';
        deleteBtn.textContent = 'Delete';
        deleteBtn.style.cssText = 'background:#e74c3c;color:#fff;border:none;border-radius:4px;padding:4px 8px;cursor:pointer;font-size:0.85em;';
        deleteBtn.onclick = () => {
          deleteConfigurationItem(index);
        };

        buttons.appendChild(editBtn);
        buttons.appendChild(deleteBtn);
        row.appendChild(info);
        row.appendChild(buttons);
        configItemsList.appendChild(row);
      });
    }

    function editConfigurationItem(index) {
      const items = loadConfigurationItems();
      const item = items[index];
      if (!item) return;

      currentEditingFieldIndex = index;
      document.getElementById('fieldIdInput').value = item.id;
      document.getElementById('fieldIdInput').disabled = true;
      document.getElementById('fieldLabelInput').value = item.label;
      document.getElementById('fieldLabelInput').focus();

      const addBtn = document.getElementById('addFieldBtn');
      const cancelBtn = document.getElementById('cancelEditFieldBtn');
      addBtn.textContent = 'Update';
      addBtn.style.background = '#27ae60';
      addBtn.onclick = () => updateConfigurationItem();
      cancelBtn.style.display = 'inline-block';
    }

    function updateConfigurationItem() {
      const fieldLabel = document.getElementById('fieldLabelInput').value.trim();

      if (!fieldLabel) {
        alert('Please enter a label');
        return;
      }

      try {
        const items = loadConfigurationItems();
        if (currentEditingFieldIndex !== null) {
          items[currentEditingFieldIndex].label = fieldLabel;
        }
        saveConfigurationItems(items);
        cancelEditField();
        refreshConfigItemsList();
        saveState();
      } catch (e) {
        alert('Error updating configuration item: ' + e.message);
      }
    }

    function deleteConfigurationItem(index) {
      if (!confirm('Delete this configuration item?')) return;

      try {
        const items = loadConfigurationItems();
        const deletedItem = items[index];
        items.splice(index, 1);
        saveConfigurationItems(items);

        refreshConfigItemsList();
        saveState();
      } catch (e) {
        alert('Error deleting configuration item: ' + e.message);
      }
    }

    function refreshFieldsList() {
      const fieldsList = document.getElementById('fieldManagerList');
      const definitions = loadFieldDefinitions();
      const baseUrls = loadItems(getStorageKey('baseUrls')) || [];
      const issueTypes = loadItems(getStorageKey('issueTypes')) || [];
      const searchTerm = document.getElementById('fieldSearchInput')?.value.toLowerCase() || '';

      fieldsList.innerHTML = '';
      if (definitions.length === 0) {
        fieldsList.innerHTML = '<div style="color:#999;">No fields defined</div>';
        return;
      }

      // Add "Select All" checkbox
      const selectAllRow = document.createElement('div');
      selectAllRow.className = 'select-all-row';
      selectAllRow.style.cssText = 'display:flex;gap:8px;align-items:center;padding:8px;border-bottom:2px solid #3498db;background:#f8f9fa;';
      selectAllRow.innerHTML = `
        <input type="checkbox" id="selectAllFieldsCheckbox" onchange="toggleSelectAllFields(this.checked)" style="cursor:pointer;">
        <label for="selectAllFieldsCheckbox" style="cursor:pointer;font-weight:600;color:#2c3e50;">Select All</label>
      `;
      fieldsList.appendChild(selectAllRow);

      definitions.forEach((def, index) => {
        // Apply search filter
        if (searchTerm && !def.label.toLowerCase().includes(searchTerm) && !def.id.toLowerCase().includes(searchTerm)) {
          return;
        }

        const row = document.createElement('div');
        row.className = 'field-list-row';
        row.setAttribute('data-field-index', index);
        row.style.cssText = 'display:flex;gap:8px;align-items:center;padding:8px;border-bottom:1px solid #eee;justify-content:space-between;';

        // Checkbox
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'field-checkbox';
        checkbox.setAttribute('data-field-index', index);
        checkbox.style.cssText = 'cursor:pointer;';
        checkbox.onchange = updateFieldSelectionUI;

        const info = document.createElement('div');
        info.style.cssText = 'flex:1;';
        
        let badges = '';
        
        // App Type badge
        if (def.appType) {
          const appColor = def.appType === 'jira' ? '#5dade2' : '#45b7d1';
          badges += `<span style="font-size:0.75em;background:${appColor};color:#fff;padding:2px 6px;border-radius:4px;margin-left:4px;">${def.appType.toUpperCase()}</span>`;
        }
        
        // Required badge
        if (def.required) {
          badges += `<span style="font-size:0.75em;background:#e74c3c;color:#fff;padding:2px 6px;border-radius:4px;margin-left:4px;">REQUIRED</span>`;
        }
        
        // Base URL badge
        if (def.baseUrlId) {
          const baseUrl = baseUrls.find(b => b.id === def.baseUrlId);
          if (baseUrl) {
             badges += `<span style="font-size:0.75em;background:#e8f4fd;color:#2980b9;padding:2px 6px;border-radius:4px;margin-left:4px;">${escapeHtml(baseUrl.alias)}</span>`;
          } else {
             badges += `<span style="font-size:0.75em;background:#fde8e8;color:#c0392b;padding:2px 6px;border-radius:4px;margin-left:4px;">Unknown Instance</span>`;
          }
        }
        
        // Issue Type badge - handle both single and array of issue types
        const defIssueTypeId = def.issueTypeId || def.tableNameId;
        if (defIssueTypeId) {
          if (Array.isArray(defIssueTypeId)) {
            // Multiple issue types
            const issueTypeLabels = defIssueTypeId.map(itId => {
              const issueType = issueTypes.find(t => t.value === itId || t.id === itId);
              return issueType ? issueType.alias || issueType.name : itId;
            });
            badges += `<span style="font-size:0.75em;background:#f0f4c3;color:#827717;padding:2px 6px;border-radius:4px;margin-left:4px;" title="${escapeHtml(issueTypeLabels.join(', '))}">üìã ${defIssueTypeId.length} Types</span>`;
          } else {
            // Single issue type
            const issueType = issueTypes.find(t => t.value === defIssueTypeId || t.id === defIssueTypeId);
            if (issueType) {
               badges += `<span style="font-size:0.75em;background:#f0f4c3;color:#827717;padding:2px 6px;border-radius:4px;margin-left:4px;">${escapeHtml(issueType.alias || issueType.name)}</span>`;
            } else {
               badges += `<span style="font-size:0.75em;background:#f0f4c3;color:#827717;padding:2px 6px;border-radius:4px;margin-left:4px;">${escapeHtml(defIssueTypeId)}</span>`;
            }
          }
        } else {
          // Global field (no issue type restriction)
          badges += `<span style="font-size:0.75em;background:#95a5a6;color:#fff;padding:2px 6px;border-radius:4px;margin-left:4px;">üåê GLOBAL</span>`;
        }

        info.innerHTML = `<div style="font-weight:500;">${escapeHtml(def.label)}${badges}</div><div style="font-size:0.85em;color:#666;">${escapeHtml(def.id)}</div>`;

        const deleteBtn = document.createElement('button');
        deleteBtn.type = 'button';
        deleteBtn.textContent = 'Delete';
        deleteBtn.style.cssText = 'background:#e74c3c;color:#fff;border:none;border-radius:4px;padding:6px 12px;cursor:pointer;font-size:0.9em;';
        deleteBtn.onclick = () => {
          deleteFieldDefinition(index);
        };

        const buttons = document.createElement('div');
        buttons.style.cssText = 'display:flex;gap:6px;';

        const editBtn = document.createElement('button');
        editBtn.type = 'button';
        editBtn.textContent = 'Edit';
        editBtn.style.cssText = 'background:#3498db;color:#fff;border:none;border-radius:4px;padding:6px 12px;cursor:pointer;font-size:0.9em;';
        editBtn.onclick = () => editFieldDefinition(index);

        buttons.appendChild(editBtn);
        buttons.appendChild(deleteBtn);
        
        row.appendChild(checkbox);
        row.appendChild(info);
        row.appendChild(buttons);
        fieldsList.appendChild(row);
      });
      
      updateFieldSelectionUI();
    }

    function filterFieldsList() {
      refreshFieldsList();
    }

    function updateFieldSelectionUI() {
      const checkboxes = document.querySelectorAll('.field-checkbox');
      const checked = Array.from(checkboxes).filter(cb => cb.checked);
      const count = checked.length;
      
      const toolbar = document.getElementById('bulkOperationsToolbar');
      const countDisplay = document.getElementById('selectedFieldCount');
      
      if (count > 0) {
        toolbar.style.display = 'block';
        countDisplay.style.display = 'inline';
        countDisplay.textContent = `(${count} selected)`;
      } else {
        toolbar.style.display = 'none';
        countDisplay.style.display = 'none';
      }
    }

    function toggleSelectAllFields(checked) {
      const checkboxes = document.querySelectorAll('.field-checkbox');
      checkboxes.forEach(cb => cb.checked = checked);
      updateFieldSelectionUI();
    }

    function deselectAllFields() {
      document.getElementById('selectAllFieldsCheckbox').checked = false;
      toggleSelectAllFields(false);
    }

    function getSelectedFieldIndices() {
      const checkboxes = document.querySelectorAll('.field-checkbox:checked');
      return Array.from(checkboxes).map(cb => parseInt(cb.getAttribute('data-field-index')));
    }

    function bulkDeleteFields() {
      const indices = getSelectedFieldIndices();
      if (indices.length === 0) {
        alert('No fields selected');
        return;
      }
      
      if (!confirm(`Delete ${indices.length} selected field(s)?`)) return;
      
      try {
        const definitions = loadFieldDefinitions();
        // Sort indices in descending order to delete from end to start
        indices.sort((a, b) => b - a);
        indices.forEach(index => {
          definitions.splice(index, 1);
        });
        saveFieldDefinitions(definitions);
        refreshFieldsList();
        updateAllFieldSelects();
        saveState();
        alert(`‚úì Deleted ${indices.length} field(s)`);
      } catch (e) {
        alert('Error deleting fields: ' + e.message);
      }
    }

    function bulkSetAppType(appType) {
      const indices = getSelectedFieldIndices();
      if (indices.length === 0) {
        alert('No fields selected');
        return;
      }
      
      try {
        const definitions = loadFieldDefinitions();
        indices.forEach(index => {
          definitions[index].appType = appType;
        });
        saveFieldDefinitions(definitions);
        refreshFieldsList();
        updateAllFieldSelects();
        saveState();
        alert(`‚úì Set ${indices.length} field(s) to ${appType.toUpperCase()}`);
      } catch (e) {
        alert('Error setting app type: ' + e.message);
      }
    }

    function bulkSetRequired(required) {
      const indices = getSelectedFieldIndices();
      if (indices.length === 0) {
        alert('No fields selected');
        return;
      }
      
      try {
        const definitions = loadFieldDefinitions();
        indices.forEach(index => {
          definitions[index].required = required;
        });
        saveFieldDefinitions(definitions);
        refreshFieldsList();
        updateAllFieldSelects();
        saveState();
        const status = required ? 'required' : 'optional';
        alert(`‚úì Marked ${indices.length} field(s) as ${status}`);
      } catch (e) {
        alert('Error setting required status: ' + e.message);
      }
    }

    function addFieldDefinition() {
      const fieldId = document.getElementById('fieldIdInput').value.trim();
      const fieldLabel = document.getElementById('fieldLabelInput').value.trim();
      const fieldType = document.getElementById('fieldTypeSelect').value;
      const baseUrlId = document.getElementById('fieldBaseUrlSelect').value;
      const issueTypeId = document.getElementById('fieldIssueTypeSelect').value;
      const isRequired = document.getElementById('fieldRequiredCheckbox').checked;

      if (!fieldId || !fieldLabel) {
        alert('Please enter both ID and Label');
        return;
      }

      if (fieldType === 'combobox' && currentComboboxOptions.length === 0) {
        alert('Please add at least one option for combobox fields');
        return;
      }

      try {
        // Check if this is a configuration item
        const configItems = loadConfigurationItems();
        const isConfigItem = configItems.some(c => c.id === fieldId);

        if (isConfigItem) {
          // Update configuration item
          const index = configItems.findIndex(c => c.id === fieldId);
          if (index >= 0) {
            if (currentEditingFieldIndex !== null && currentEditingFieldIndex === index) {
              configItems[index].label = fieldLabel;
            }
          }
          saveConfigurationItems(configItems);
          cancelEditField();
          refreshConfigItemsList();
        } else {
          // Handle custom fields
          const definitions = loadFieldDefinitions();

          const fieldData = { 
            id: fieldId, 
            label: fieldLabel, 
            category: 'custom',
            fieldType: fieldType,
            baseUrlId: baseUrlId,
            issueTypeId: issueTypeId,
            required: isRequired
          };

          if (fieldType === 'combobox') {
            fieldData.options = [...currentComboboxOptions];
          }

          if (currentEditingFieldIndex !== null) {
            definitions[currentEditingFieldIndex] = { ...definitions[currentEditingFieldIndex], ...fieldData };
          } else {
            const existingIndex = definitions.findIndex(d => d.id === fieldId);
            if (existingIndex >= 0) {
              definitions[existingIndex] = { ...definitions[existingIndex], ...fieldData };
            } else {
              definitions.push(fieldData);
            }
          }

          saveFieldDefinitions(definitions);
          updateAllFieldSelects();
          cancelEditField();
          refreshFieldsList();
        }
        saveState();
      } catch (e) {
        alert('Error saving field definition: ' + e.message);
      }
    }

    function deleteFieldDefinition(index) {
      if (!confirm('Delete this field definition?')) return;

      try {
        const definitions = loadFieldDefinitions();
        definitions.splice(index, 1);
        saveFieldDefinitions(definitions);

        // Update all dropdowns
        updateAllFieldSelects();

        // Refresh list
        refreshFieldsList();
        saveState();
      } catch (e) {
        alert('Error deleting field definition: ' + e.message);
      }
    }

    function updateAllFieldSelects() {
      const definitions = loadFieldDefinitions();
      const rows = document.querySelectorAll('.field-row');

      rows.forEach(row => {
        const select = row.querySelector('.field-select');
        const currentValue = select.value;

        // Clear options except placeholder
        while (select.options.length > 1) {
          select.remove(1);
        }

        // Add all definitions
        definitions.forEach(def => {
          const option = document.createElement('option');
          option.value = def.id;
          option.textContent = def.label;
          select.appendChild(option);
        });

        // Restore selection
        select.value = currentValue;
      });
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // ========================================================================
    // CONFIGURATION PRESETS - Functions for saving/loading templates
    // ========================================================================

    function loadConfigurationPresets() {
      try {
        // Load from app-specific key first
        const appKey = currentAppType === 'jira' ? 'linkGenJiraPresets' : 'linkGenSnowPresets';
        let stored = localStorage.getItem(appKey);
        
        // Migration: Check for legacy preset data and migrate if needed
        if (!stored || stored === '[]') {
          const legacyStored = localStorage.getItem('snowConfigurationPresets');
          if (legacyStored) {
            console.log('Migrating legacy presets to app-specific storage');
            // Assign presets to both apps initially (user can delete unwanted ones later)
            localStorage.setItem('linkGenJiraPresets', legacyStored);
            localStorage.setItem('linkGenSnowPresets', legacyStored);
            stored = legacyStored;
          }
        }
        
        if (!stored) return [];
        const parsed = JSON.parse(stored);
        return Array.isArray(parsed) ? parsed : [];
      } catch (e) {
        console.error('Failed to load presets:', e);
        return [];
      }
    }

    function saveConfigurationPreset(preset) {
      try {
        if (!preset.id || !preset.name) {
          throw new Error('Preset must have id and name');
        }
        
        // Add app type to preset for future filtering
        preset.appType = currentAppType;
        
        const presets = loadConfigurationPresets();
        const index = presets.findIndex(p => p.id === preset.id);
        if (index >= 0) {
          presets[index] = preset;
        } else {
          presets.push(preset);
        }
        
        // Save to app-specific key
        const appKey = currentAppType === 'jira' ? 'linkGenJiraPresets' : 'linkGenSnowPresets';
        localStorage.setItem(appKey, JSON.stringify(presets));
        return preset;
      } catch (e) {
        throw new Error('Failed to save preset: ' + e.message);
      }
    }

    function deleteConfigurationPreset(presetId) {
      try {
        const presets = loadConfigurationPresets();
        const index = presets.findIndex(p => p.id === presetId);
        if (index < 0) {
          throw new Error('Preset not found');
        }
        presets.splice(index, 1);
        
        // Save to app-specific key
        const appKey = currentAppType === 'jira' ? 'linkGenJiraPresets' : 'linkGenSnowPresets';
        localStorage.setItem(appKey, JSON.stringify(presets));
        return true;
      } catch (e) {
        throw new Error('Failed to delete preset: ' + e.message);
      }
    }

    function generatePresetId(name) {
      return name.toLowerCase()
        .replace(/\s+/g, '-')
        .replace(/[^a-z0-9-]/g, '') + '-' + Date.now();
    }

    // ========================================================================
    // PRESET UI - Modal Functions
    // ========================================================================

    function openSavePresetModal() {
      const modal = document.getElementById('savePresetModal');
      const baseUrl = document.getElementById('baseUrl').value || '(none)';
      const issueType = document.getElementById('issueType').value || '(none)';

      document.getElementById('baseUrlDisplay').textContent = baseUrl;
      document.getElementById('issueTypeDisplay').textContent = issueType;
      document.getElementById('presetNameInput').value = '';
      document.getElementById('presetDescriptionInput').value = '';
      document.getElementById('lockBaseUrl').checked = false;
      document.getElementById('lockIssueType').checked = false;

      modal.style.display = 'flex';
      document.getElementById('presetNameInput').focus();
    }

    function closeSavePresetModal() {
      document.getElementById('savePresetModal').style.display = 'none';
    }

    function saveCurrentAsPreset() {
      const name = document.getElementById('presetNameInput').value.trim();
      if (!name) {
        alert('Please enter a preset name');
        return;
      }

      try {
        const baseUrl = document.getElementById('baseUrl').value.trim();
        const issueType = document.getElementById('issueType').value.trim();
        const lockBaseUrl = document.getElementById('lockBaseUrl').checked;
        const lockIssueType = document.getElementById('lockIssueType').checked;
        const description = document.getElementById('presetDescriptionInput').value.trim();

        const fields = getFields();

        const preset = {
          id: generatePresetId(name),
          name: name,
          fields: fields,
          createdAt: Date.now()
        };

        if (description) preset.description = description;
        
        // Always save baseUrl and issueType (not just when locked)
        if (baseUrl) preset.baseUrl = baseUrl;
        if (issueType) preset.issueType = issueType;
        
        // For Jira, also save projectId
        if (currentAppType === 'jira') {
          const projectId = document.getElementById('projectId').value.trim();
          if (projectId) preset.projectId = projectId;
        }
        
        // Store lock states
        preset.lockBaseUrl = lockBaseUrl;
        preset.lockIssueType = lockIssueType;

        saveConfigurationPreset(preset);

        // Refresh preset dropdown
        populatePresetDropdown();

        closeSavePresetModal();
        alert('Preset saved successfully!');
      } catch (e) {
        alert('Error saving preset: ' + e.message);
      }
    }

    function populatePresetDropdown() {
      const select = document.getElementById('presetSelect');
      const presets = loadConfigurationPresets();

      // Keep placeholder
      select.innerHTML = '<option value="">-- Load Preset --</option>';

      presets.forEach(preset => {
        const option = document.createElement('option');
        option.value = preset.id;
        option.textContent = preset.name;
        select.appendChild(option);
      });
    }

    function loadPresetFromDropdown() {
      const select = document.getElementById('presetSelect');
      const presetId = select.value;

      if (!presetId) return;

      try {
        const formData = applyPresetToForm(presetId);

        // Clear fields
        document.getElementById('fields').innerHTML = '';

        // Populate form
        document.getElementById('baseUrl').value = formData.baseUrl;
        document.getElementById('issueType').value = formData.issueType;
        
        // For Jira, also restore projectId
        if (currentAppType === 'jira' && formData.projectId) {
          document.getElementById('projectId').value = formData.projectId;
        }

        // Add fields
        if (!formData.fields || !Array.isArray(formData.fields)) {
          formData.fields = [];
        }
        formData.fields.forEach(f => addField(f));

        saveState();
        select.value = ''; // Reset dropdown
        alert('Preset loaded successfully!');
      } catch (e) {
        console.error('Error loading preset:', e);
        alert('Error loading preset: ' + e.message);
        select.value = '';
      }
    }

    function applyPresetToForm(presetId) {
      const presets = loadConfigurationPresets();
      const preset = presets.find(p => p.id === presetId);
      if (!preset) throw new Error('Preset not found');
      return {
        baseUrl: preset.baseUrl || '',
        issueType: preset.issueType || preset.tableName || '',
        projectId: preset.projectId || '',
        fields: preset.fields || []
      };
    }

    function openManagePresetsModal() {
      const modal = document.getElementById('managePresetsModal');
      modal.style.display = 'flex';
      refreshPresetsList();
    }

    function closeManagePresetsModal() {
      document.getElementById('managePresetsModal').style.display = 'none';
    }

    function editConfigurationPreset(presetId) {
      const presets = loadConfigurationPresets();
      const preset = presets.find(p => p.id === presetId);
      if (!preset) {
        alert('Preset not found');
        return;
      }

      // Load the preset into the form
      document.getElementById('baseUrl').value = preset.baseUrl || '';
      document.getElementById('issueType').value = preset.issueType || preset.tableName || '';
      
      // For Jira, also restore projectId
      if (currentAppType === 'jira' && preset.projectId) {
        document.getElementById('projectId').value = preset.projectId;
      }

      // Clear existing fields
      document.getElementById('fields').innerHTML = '';

      // Add preset fields
      if (preset.fields && preset.fields.length > 0) {
        preset.fields.forEach(f => addField(f));
      } else {
        addField();
      }

      closeManagePresetsModal();
      saveState();
      alert(`Loaded preset: ${preset.name}. Make changes and save as a new preset or overwrite this one.`);
    }

    function refreshPresetsList() {
      const presetsList = document.getElementById('presetsList');
      const presets = loadConfigurationPresets();

      presetsList.innerHTML = '';
      if (presets.length === 0) {
        presetsList.innerHTML = '<div style="color:#999;padding:20px;text-align:center;">No presets saved yet</div>';
        return;
      }

      presets.forEach((preset, index) => {
        const row = document.createElement('div');
        row.style.cssText = 'padding:12px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center;';

        const info = document.createElement('div');
        info.style.cssText = 'flex:1;';
        let infoHtml = `<div style="font-weight:500;margin-bottom:4px;">${escapeHtml(preset.name)}</div>`;
        if (preset.description) {
          infoHtml += `<div style="font-size:0.9em;color:#666;">${escapeHtml(preset.description)}</div>`;
        }
        const presetIssueType = preset.issueType || preset.tableName;
        if (preset.baseUrl || presetIssueType) {
          infoHtml += `<div style="font-size:0.85em;color:#999;margin-top:4px;">`;
          if (preset.baseUrl) infoHtml += `URL: ${escapeHtml(preset.baseUrl)} ‚Ä¢ `;
          if (presetIssueType) infoHtml += `Issue Type: ${escapeHtml(presetIssueType)}`;
          infoHtml += `</div>`;
        }
        info.innerHTML = infoHtml;

        const buttons = document.createElement('div');
        buttons.style.cssText = 'display:flex;gap:8px;';

        const editBtn = document.createElement('button');
        editBtn.type = 'button';
        editBtn.textContent = 'Edit';
        editBtn.style.cssText = 'background:#3498db;color:#fff;border:none;border-radius:4px;padding:6px 12px;cursor:pointer;font-size:0.9em;';
        editBtn.onclick = () => editConfigurationPreset(preset.id);

        const deleteBtn = document.createElement('button');
        deleteBtn.type = 'button';
        deleteBtn.textContent = 'Delete';
        deleteBtn.style.cssText = 'background:#e74c3c;color:#fff;border:none;border-radius:4px;padding:6px 12px;cursor:pointer;font-size:0.9em;';
        deleteBtn.onclick = () => {
          if (confirm('Delete this preset?')) {
            try {
              deleteConfigurationPreset(preset.id);
              populatePresetDropdown();
              refreshPresetsList();
            } catch (e) {
              alert('Error deleting preset: ' + e.message);
            }
          }
        };

        buttons.appendChild(editBtn);
        buttons.appendChild(deleteBtn);
        row.appendChild(info);
        row.appendChild(buttons);
        presetsList.appendChild(row);
      });
    }

    // Copy link to clipboard
    // Copy link to clipboard
    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => {
        // Success - handled by UI already
      }).catch(err => {
        console.error('Failed to copy:', err);
        alert('Failed to copy link to clipboard');
      });
    }

    function copyLink() {
      const link = document.getElementById('link').textContent;
      copyToClipboard(link);
      
      // Update button feedback
      const btn = event.target.closest('button');
      if (btn) {
        const originalHTML = btn.innerHTML;
        btn.innerHTML = '<i class="bi bi-check-circle"></i> Copied!';
        setTimeout(() => btn.innerHTML = originalHTML, 1200);
      }
    }
    
    // Toggle link details expansion
    function toggleLinkDisplay() {
      const details = document.getElementById('linkDetails');
      const icon = document.getElementById('expandIcon');
      
      if (details.style.display === 'none') {
        details.style.display = 'block';
        icon.className = 'bi bi-chevron-up';
      } else {
        details.style.display = 'none';
        icon.className = 'bi bi-chevron-down';
      }
    }

    // ========================================================================
    // SEPARATE MODALS - Base URL, Issue Type Manager
    // ========================================================================

    // Generic helper functions
    function generateItemId(prefix) {
      return prefix + '_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    function loadItems(storageKey) {
      try {
        const stored = localStorage.getItem(storageKey);
        if (!stored) return [];
        const parsed = JSON.parse(stored);
        return Array.isArray(parsed) ? parsed : [];
      } catch (e) {
        console.error(`Failed to load items from ${storageKey}:`, e);
        return [];
      }
    }

    function saveItems(storageKey, items) {
      try {
        if (!Array.isArray(items)) {
          throw new Error('Items must be an array');
        }
        localStorage.setItem(storageKey, JSON.stringify(items));
        return true;
      } catch (e) {
        console.error(`Failed to save items to ${storageKey}:`, e);
        throw new Error('Could not save items (localStorage full?)');
      }
    }

    // ========================================================================
    // BASE URL MANAGER
    // ========================================================================

    let currentEditingBaseUrlId = null;

    function openBaseUrlManager() {
      const modal = document.getElementById('baseUrlManagerModal');
      if (!modal) {
        console.error('baseUrlManagerModal not found');
        return;
      }
      modal.style.display = 'flex';
      refreshBaseUrlList();
    }

    function closeBaseUrlManager() {
      const modal = document.getElementById('baseUrlManagerModal');
      if (!modal) return;
      modal.style.display = 'none';
      cancelBaseUrlEdit();
    }

    function saveBaseUrl() {
      const alias = document.getElementById('baseUrlAliasInput').value.trim();
      const value = document.getElementById('baseUrlValueInput').value.trim();

      if (!alias || !value) {
        alert('Please fill in all fields');
        return;
      }

      // Validate URL format
      if (!value.match(/^https?:\/\/.+/)) {
        alert('Please enter a valid URL starting with http:// or https://');
        return;
      }

      try {
        const items = loadItems(getStorageKey('baseUrls')) || [];
        
        if (currentEditingBaseUrlId) {
          // Update existing
          const index = items.findIndex(item => item.id === currentEditingBaseUrlId);
          if (index >= 0) {
            items[index].alias = alias;
            items[index].value = value;
            items[index].updatedAt = Date.now();
          }
        } else {
          // Add new
          items.push({
            id: generateItemId('base_url'),
            alias: alias,
            value: value,
            createdAt: Date.now()
          });
        }

        saveItems(getStorageKey('baseUrls'), items);
        populateBaseUrlDropdown();
        refreshBaseUrlList();
        cancelBaseUrlEdit();
      } catch (e) {
        alert('Error saving base URL: ' + e.message);
      }
    }

    function editBaseUrl(itemId) {
      const items = loadItems(getStorageKey('baseUrls')) || [];
      const item = items.find(i => i.id === itemId);
      if (!item) return;

      currentEditingBaseUrlId = itemId;
      document.getElementById('baseUrlAliasInput').value = item.alias;
      document.getElementById('baseUrlValueInput').value = item.value;
      
      const saveBtn = document.getElementById('saveBaseUrlBtn');
      const cancelBtn = document.getElementById('cancelBaseUrlBtn');
      saveBtn.textContent = 'Update';
      saveBtn.style.background = '#3498db';
      cancelBtn.style.display = 'inline-block';
    }

    function deleteBaseUrl(itemId) {
      if (!confirm('Delete this base URL?')) return;

      try {
        const items = loadItems(getStorageKey('baseUrls')) || [];
        const filtered = items.filter(item => item.id !== itemId);
        saveItems(getStorageKey('baseUrls'), filtered);
        populateBaseUrlDropdown();
        refreshBaseUrlList();
      } catch (e) {
        alert('Error deleting base URL: ' + e.message);
      }
    }

    function applyBaseUrl(itemId) {
      const items = loadItems(getStorageKey('baseUrls')) || [];
      const item = items.find(i => i.id === itemId);
      if (!item) return;

      document.getElementById('baseUrl').value = item.id;
      closeBaseUrlManager();
      saveState();
      detectAppType();
    }

    function cancelBaseUrlEdit() {
      currentEditingBaseUrlId = null;
      document.getElementById('baseUrlAliasInput').value = '';
      document.getElementById('baseUrlValueInput').value = '';
      
      const saveBtn = document.getElementById('saveBaseUrlBtn');
      const cancelBtn = document.getElementById('cancelBaseUrlBtn');
      saveBtn.textContent = 'Save';
      saveBtn.style.background = '#27ae60';
      cancelBtn.style.display = 'none';
    }

    function refreshBaseUrlList() {
      const list = document.getElementById('baseUrlSavedList');
      if (!list) return;
      
      const items = loadItems(getStorageKey('baseUrls')) || [];
      list.innerHTML = '';
      
      if (items.length === 0) {
        list.innerHTML = '<div style="padding:16px;color:#999;text-align:center;">No saved base URLs yet.<br>Add one above to get started!</div>';
        return;
      }

      items.forEach(item => {
        const row = document.createElement('div');
        row.style.cssText = 'padding:12px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:flex-start;';

        const info = document.createElement('div');
        info.style.cssText = 'flex:1;';
        info.innerHTML = `
          <div style="font-weight:600;margin-bottom:6px;font-size:1.05em;color:#2c3e50;">${escapeHtml(item.alias)}</div>
          <div style="font-size:0.9em;color:#666;">${escapeHtml(item.value)}</div>
        `;

        const buttons = document.createElement('div');
        buttons.style.cssText = 'display:flex;gap:8px;flex-direction:column;';

        const useBtn = document.createElement('button');
        useBtn.type = 'button';
        useBtn.textContent = 'Use';
        useBtn.style.cssText = 'background:#27ae60;color:#fff;border:none;border-radius:4px;padding:6px 16px;cursor:pointer;font-size:0.9em;white-space:nowrap;';
        useBtn.onclick = () => applyBaseUrl(item.id);

        const editBtn = document.createElement('button');
        editBtn.type = 'button';
        editBtn.textContent = 'Edit';
        editBtn.style.cssText = 'background:#3498db;color:#fff;border:none;border-radius:4px;padding:6px 16px;cursor:pointer;font-size:0.9em;';
        editBtn.onclick = () => editBaseUrl(item.id);

        const deleteBtn = document.createElement('button');
        deleteBtn.type = 'button';
        deleteBtn.textContent = 'Delete';
        deleteBtn.style.cssText = 'background:#e74c3c;color:#fff;border:none;border-radius:4px;padding:6px 16px;cursor:pointer;font-size:0.9em;';
        deleteBtn.onclick = () => deleteBaseUrl(item.id);

        buttons.appendChild(useBtn);
        buttons.appendChild(editBtn);
        buttons.appendChild(deleteBtn);
        row.appendChild(info);
        row.appendChild(buttons);
        list.appendChild(row);
      });
    }

    function populateBaseUrlDropdown() {
      const select = document.getElementById('baseUrl');
      if (!select) return;
      
      // Load from unified key, fallback to legacy keys for migration
      let items = loadItems(getStorageKey('baseUrls'));
      console.log('[populateBaseUrlDropdown] Loaded items:', items);
      if (!items || items.length === 0) {
        // Migrate from app-specific legacy keys
        const legacyKey = currentAppType === 'jira' ? 'jiraSavedBaseUrls' : 'snowSavedBaseUrls';
        items = loadItems(legacyKey) || [];
        if (items.length > 0) {
          saveItems(getStorageKey('baseUrls'), items);
        }
      }
      const currentValue = select.value;
      
      // Clear existing options except first
      while (select.options.length > 1) {
        select.remove(1);
      }

      // Add saved items
      items.forEach(item => {
        const option = document.createElement('option');
        option.value = item.id; // Use ID
        option.textContent = `${item.alias}: ${item.value}`;
        select.appendChild(option);
      });

      // Restore selection if it still exists
      if (currentValue) {
        select.value = currentValue;
      }
    }

    // ========================================================================
    // ISSUE TYPE MANAGER
    // ========================================================================

    let currentEditingIssueTypeId = null;

    function openIssueTypeManager() {
      const modal = document.getElementById('issueTypeManagerModal');
      if (!modal) {
        console.error('issueTypeManagerModal not found');
        return;
      }
      modal.style.display = 'flex';
      refreshIssueTypeList();
    }

    function closeIssueTypeManager() {
      const modal = document.getElementById('issueTypeManagerModal');
      if (!modal) return;
      modal.style.display = 'none';
      cancelIssueTypeEdit();
    }

    function saveIssueType() {
      const alias = document.getElementById('issueTypeAliasInput').value.trim();
      const value = document.getElementById('issueTypeValueInput').value.trim();

      if (!alias || !value) {
        alert('Please fill in all fields');
        return;
      }

      try {
        const items = loadItems(getStorageKey('issueTypes')) || [];
        
        if (currentEditingIssueTypeId) {
          // Update existing
          const index = items.findIndex(item => item.id === currentEditingIssueTypeId);
          if (index >= 0) {
            items[index].alias = alias;
            items[index].value = value;
            items[index].updatedAt = Date.now();
          }
        } else {
          // Add new
          items.push({
            id: generateItemId('issuetype'),
            alias: alias,
            value: value,
            createdAt: Date.now()
          });
        }

        saveItems(getStorageKey('issueTypes'), items);
        populateIssueTypeDropdown();
        refreshIssueTypeList();
        cancelIssueTypeEdit();
      } catch (e) {
        alert('Error saving issue type: ' + e.message);
      }
    }

    function editIssueType(itemId) {
      const items = loadItems(getStorageKey('issueTypes')) || [];
      const item = items.find(i => i.id === itemId);
      if (!item) return;

      currentEditingIssueTypeId = itemId;
      document.getElementById('issueTypeAliasInput').value = item.alias;
      document.getElementById('issueTypeValueInput').value = item.value;
      
      const saveBtn = document.getElementById('saveIssueTypeBtn');
      const cancelBtn = document.getElementById('cancelIssueTypeBtn');
      saveBtn.textContent = 'Update';
      saveBtn.style.background = '#3498db';
      cancelBtn.style.display = 'inline-block';
    }

    function deleteIssueType(itemId) {
      if (!confirm('Delete this issue type?')) return;

      try {
        const items = loadItems(getStorageKey('issueTypes')) || [];
        const filtered = items.filter(item => item.id !== itemId);
        saveItems(getStorageKey('issueTypes'), filtered);
        populateIssueTypeDropdown();
        refreshIssueTypeList();
      } catch (e) {
        alert('Error deleting issue type: ' + e.message);
      }
    }

    function applyIssueType(itemId) {
      const items = loadItems(getStorageKey('issueTypes')) || [];
      const item = items.find(i => i.id === itemId);
      if (!item) return;

      document.getElementById('issueType').value = item.value;
      closeIssueTypeManager();
      saveState();
    }

    function cancelIssueTypeEdit() {
      currentEditingIssueTypeId = null;
      document.getElementById('issueTypeAliasInput').value = '';
      document.getElementById('issueTypeValueInput').value = '';
      
      const saveBtn = document.getElementById('saveIssueTypeBtn');
      const cancelBtn = document.getElementById('cancelIssueTypeBtn');
      saveBtn.textContent = 'Save';
      saveBtn.style.background = '#27ae60';
      cancelBtn.style.display = 'none';
    }

    function refreshIssueTypeList() {
      const list = document.getElementById('issueTypeSavedList');
      if (!list) return;
      
      // Load from unified key, fallback to legacy keys for migration
      let items = loadItems(getStorageKey('issueTypes'));
      if (!items || items.length === 0) {
        // Migrate from app-specific legacy keys
        const legacyKey = currentAppType === 'jira' ? 'jiraSavedIssueTypes' : 
                         (loadItems('snowSavedIssueTypes') ? 'snowSavedIssueTypes' : 'snowSavedTableNames');
        items = loadItems(legacyKey) || [];
        if (items.length > 0) {
          saveItems(getStorageKey('issueTypes'), items);
        }
      }
      list.innerHTML = '';
      
      if (items.length === 0) {
        list.innerHTML = '<div style="padding:16px;color:#999;text-align:center;">No saved issue types yet.<br>Add one above to get started!</div>';
        return;
      }

      items.forEach(item => {
        const row = document.createElement('div');
        row.style.cssText = 'padding:12px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:flex-start;';

        const info = document.createElement('div');
        info.style.cssText = 'flex:1;';
        info.innerHTML = `
          <div style="font-weight:600;margin-bottom:6px;font-size:1.05em;color:#2c3e50;">${escapeHtml(item.alias)}</div>
          <div style="font-size:0.9em;color:#666;">${escapeHtml(item.value)}</div>
        `;

        const buttons = document.createElement('div');
        buttons.style.cssText = 'display:flex;gap:8px;flex-direction:column;';

        const useBtn = document.createElement('button');
        useBtn.type = 'button';
        useBtn.textContent = 'Use';
        useBtn.style.cssText = 'background:#27ae60;color:#fff;border:none;border-radius:4px;padding:6px 16px;cursor:pointer;font-size:0.9em;white-space:nowrap;';
        useBtn.onclick = () => applyIssueType(item.id);

        const editBtn = document.createElement('button');
        editBtn.type = 'button';
        editBtn.textContent = 'Edit';
        editBtn.style.cssText = 'background:#3498db;color:#fff;border:none;border-radius:4px;padding:6px 16px;cursor:pointer;font-size:0.9em;';
        editBtn.onclick = () => editIssueType(item.id);

        const deleteBtn = document.createElement('button');
        deleteBtn.type = 'button';
        deleteBtn.textContent = 'Delete';
        deleteBtn.style.cssText = 'background:#e74c3c;color:#fff;border:none;border-radius:4px;padding:6px 16px;cursor:pointer;font-size:0.9em;';
        deleteBtn.onclick = () => deleteIssueType(item.id);

        buttons.appendChild(useBtn);
        buttons.appendChild(editBtn);
        buttons.appendChild(deleteBtn);
        row.appendChild(info);
        row.appendChild(buttons);
        list.appendChild(row);
      });
    }

    function populateIssueTypeDropdown() {
      const select = document.getElementById('issueType');
      if (!select) return;
      
      // Load from unified key, fallback to legacy keys for migration
      let items = loadItems(getStorageKey('issueTypes'));
      if (!items || items.length === 0) {
        // Migrate from app-specific legacy keys
        const legacyKey = currentAppType === 'jira' ? 'jiraSavedIssueTypes' : 
                         (loadItems('snowSavedIssueTypes') ? 'snowSavedIssueTypes' : 'snowSavedTableNames');
        items = loadItems(legacyKey) || [];
        if (items.length > 0) {
          saveItems(getStorageKey('issueTypes'), items);
        }
      }
      const currentValue = select.value;
      
      // Clear existing options except first
      while (select.options.length > 1) {
        select.remove(1);
      }

      // Add saved items
      items.forEach(item => {
        const option = document.createElement('option');
        option.value = item.value;
        option.textContent = `${item.alias}: ${item.value}`;
        select.appendChild(option);
      });

      // Restore selection if it still exists
      if (currentValue) {
        select.value = currentValue;
      }
    }

    // ========================================================================
    // PROJECT ID MANAGER (Jira only)
    // ========================================================================
    
    let currentEditingProjectIdId = null;

    function openProjectIdManager() {
      const modal = document.getElementById('projectIdManagerModal');
      if (!modal) {
        console.error('projectIdManagerModal not found');
        return;
      }
      modal.style.display = 'flex';
      refreshProjectIdList();
    }

    function closeProjectIdManager() {
      const modal = document.getElementById('projectIdManagerModal');
      if (!modal) return;
      modal.style.display = 'none';
      cancelProjectIdEdit();
    }

    function saveProjectId() {
      const alias = document.getElementById('projectIdAliasInput').value.trim();
      const value = document.getElementById('projectIdValueInput').value.trim();

      if (!alias || !value) {
        alert('Please fill in all fields');
        return;
      }

      try {
        const items = loadItems(getStorageKey('projectIds')) || [];
        
        if (currentEditingProjectIdId) {
          const index = items.findIndex(item => item.id === currentEditingProjectIdId);
          if (index >= 0) {
            items[index].alias = alias;
            items[index].value = value;
            items[index].updatedAt = Date.now();
          }
        } else {
          items.push({
            id: generateItemId('projectid'),
            alias: alias,
            value: value,
            createdAt: Date.now()
          });
        }

        saveItems(getStorageKey('projectIds'), items);
        populateProjectIdDropdown();
        refreshProjectIdList();
        cancelProjectIdEdit();
      } catch (e) {
        alert('Error saving project ID: ' + e.message);
      }
    }

    function editProjectId(itemId) {
      const items = loadItems(getStorageKey('projectIds')) || [];
      const item = items.find(i => i.id === itemId);
      if (!item) return;

      currentEditingProjectIdId = itemId;
      document.getElementById('projectIdAliasInput').value = item.alias;
      document.getElementById('projectIdValueInput').value = item.value;
      
      const saveBtn = document.getElementById('saveProjectIdBtn');
      const cancelBtn = document.getElementById('cancelProjectIdBtn');
      saveBtn.textContent = 'Update';
      saveBtn.style.background = '#3498db';
      cancelBtn.style.display = 'inline-block';
    }

    function deleteProjectId(itemId) {
      if (!confirm('Delete this project ID?')) return;

      try {
        const items = loadItems(getStorageKey('projectIds')) || [];
        const filtered = items.filter(item => item.id !== itemId);
        saveItems(getStorageKey('projectIds'), filtered);
        populateProjectIdDropdown();
        refreshProjectIdList();
      } catch (e) {
        alert('Error deleting project ID: ' + e.message);
      }
    }

    function applyProjectId(itemId) {
      const items = loadItems(getStorageKey('projectIds')) || [];
      const item = items.find(i => i.id === itemId);
      if (!item) return;

      document.getElementById('projectId').value = item.value;
      closeProjectIdManager();
      saveState();
    }

    function cancelProjectIdEdit() {
      currentEditingProjectIdId = null;
      const aliasInput = document.getElementById('projectIdAliasInput');
      const valueInput = document.getElementById('projectIdValueInput');
      if (aliasInput) aliasInput.value = '';
      if (valueInput) valueInput.value = '';
      
      const saveBtn = document.getElementById('saveProjectIdBtn');
      const cancelBtn = document.getElementById('cancelProjectIdBtn');
      if (saveBtn) {
        saveBtn.textContent = 'Save';
        saveBtn.style.background = '#27ae60';
      }
      if (cancelBtn) cancelBtn.style.display = 'none';
    }

    function refreshProjectIdList() {
      const list = document.getElementById('projectIdSavedList');
      if (!list) return;
      
      let items = loadItems(getStorageKey('projectIds')) || loadItems('jiraSavedProjectIds') || [];
      list.innerHTML = '';
      
      if (items.length === 0) {
        list.innerHTML = '<div style="padding:16px;color:#999;text-align:center;">No saved project IDs yet.<br>Add one above to get started!</div>';
        return;
      }

      items.forEach(item => {
        const row = document.createElement('div');
        row.style.cssText = 'padding:12px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:flex-start;';

        const info = document.createElement('div');
        info.style.cssText = 'flex:1;';
        info.innerHTML = `
          <div style="font-weight:600;margin-bottom:6px;font-size:1.05em;color:#2c3e50;">${escapeHtml(item.alias)}</div>
          <div style="font-size:0.9em;color:#666;">${escapeHtml(item.value)}</div>
        `;

        const buttons = document.createElement('div');
        buttons.style.cssText = 'display:flex;gap:8px;flex-direction:column;';

        const useBtn = document.createElement('button');
        useBtn.type = 'button';
        useBtn.textContent = 'Use';
        useBtn.style.cssText = 'background:#27ae60;color:#fff;border:none;border-radius:4px;padding:6px 16px;cursor:pointer;font-size:0.9em;white-space:nowrap;';
        useBtn.onclick = () => applyProjectId(item.id);

        const editBtn = document.createElement('button');
        editBtn.type = 'button';
        editBtn.textContent = 'Edit';
        editBtn.style.cssText = 'background:#3498db;color:#fff;border:none;border-radius:4px;padding:6px 16px;cursor:pointer;font-size:0.9em;';
        editBtn.onclick = () => editProjectId(item.id);

        const deleteBtn = document.createElement('button');
        deleteBtn.type = 'button';
        deleteBtn.textContent = 'Delete';
        deleteBtn.style.cssText = 'background:#e74c3c;color:#fff;border:none;border-radius:4px;padding:6px 16px;cursor:pointer;font-size:0.9em;';
        deleteBtn.onclick = () => deleteProjectId(item.id);

        buttons.appendChild(useBtn);
        buttons.appendChild(editBtn);
        buttons.appendChild(deleteBtn);
        row.appendChild(info);
        row.appendChild(buttons);
        list.appendChild(row);
      });
    }

    function populateProjectIdDropdown() {
      const select = document.getElementById('projectId');
      if (!select) return;
      
      // Load from unified key, fallback to legacy key for migration
      let items = loadItems(getStorageKey('projectIds'));
      if (!items || items.length === 0) {
        items = loadItems('jiraSavedProjectIds') || [];
        if (items.length > 0) {
          saveItems(getStorageKey('projectIds'), items);
        }
      }
      const currentValue = select.value;
      
      // Clear existing options except first
      while (select.options.length > 1) {
        select.remove(1);
      }

      // Add saved items
      items.forEach(item => {
        const option = document.createElement('option');
        option.value = item.value;
        option.textContent = `${item.alias}: ${item.value}`;
        select.appendChild(option);
      });

      // Restore selection if it still exists
      if (currentValue) {
        select.value = currentValue;
      }
    }

    // ========================================================================
    // CONFIGURATION EXPORT/IMPORT & URL LOADING
    // ========================================================================

    function exportConfiguration() {
      try {
        // Get all fields including ignored ones
        const allFields = loadAllFieldDefinitions();
        const activeFields = allFields.filter(f => !f.ignored);
        const ignoredFields = allFields.filter(f => f.ignored);
        
        const config = {
          version: '1.0.0',
          exportedAt: new Date().toISOString(),
          description: 'Link Generator Configuration',
          appType: currentAppType,
          configItems: loadConfigurationItems(),
          fieldDefinitions: activeFields,
          ignoredFields: ignoredFields,
          baseUrls: loadItems(getStorageKey('baseUrls')) || loadItems('snowSavedBaseUrls') || [],
          issueTypes: loadItems(getStorageKey('issueTypes')) || loadItems('snowSavedIssueTypes') || [],
          projectIds: loadItems(getStorageKey('projectIds')) || []
        };

        const jsonString = JSON.stringify(config, null, 2);
        const blob = new Blob([jsonString], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `link-generator-config-${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);

        alert('Configuration exported successfully!');
      } catch (e) {
        alert('Error exporting configuration: ' + e.message);
      }
    }

    // Storage for undo functionality
    let lastImportBackup = null;

    function importConfiguration(file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const config = JSON.parse(e.target.result);

          // Validate config structure
          if (!config.version) {
            throw new Error('Invalid configuration file: missing version');
          }

          // Show preview modal
          showImportPreview(config);
        } catch (e) {
          alert('Error importing configuration: ' + e.message);
        }
      };
      reader.onerror = function() {
        alert('Error importing configuration: Failed to read file');
      };
      reader.readAsText(file);
    }

    function showImportPreview(config) {
      // Process and enhance the config before showing preview
      const processed = processImportedConfig(config);
      
      // Load existing ignored fields to check for matches
      const allStoredFields = loadAllFieldDefinitions();
      const alreadyIgnoredFieldIds = new Set(
        allStoredFields.filter(f => f.ignored).map(f => f.id)
      );
      
      // Count how many incoming fields are already ignored
      const preIgnoredCount = (processed.fieldDefinitions || []).filter(f => 
        alreadyIgnoredFieldIds.has(f.id)
      ).length;
      
      // Count what will be imported
      const counts = {
        fields: (processed.fieldDefinitions || []).length,
        preIgnored: preIgnoredCount,
        ignored: (processed.ignoredFields || []).length,
        baseUrls: (processed.baseUrls || []).length,
        issueTypes: (processed.issueTypes || []).length,
        projectIds: (processed.projectIds || []).length,
        skipped: processed.skippedFields || 0
      };

      // Create preview modal
      const modal = document.createElement('div');
      modal.id = 'importPreviewModal';
      modal.style.cssText = 'position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.7);z-index:2000;display:flex;align-items:center;justify-content:center;';
      
      const content = document.createElement('div');
      content.style.cssText = 'background:#fff;border-radius:12px;padding:32px;max-width:900px;width:90vw;max-height:90vh;display:flex;flex-direction:column;box-shadow:0 10px 40px rgba(0,0,0,0.3);';
      
      let issueTypeInfo = '';
      if (processed.issueTypeLabel) {
        issueTypeInfo = `<div style="background:#d4edda;border:1px solid #c3e6cb;color:#155724;padding:12px;border-radius:6px;margin-bottom:16px;">
          ‚úì Issue Type Mapped: <strong>${processed.issueType}</strong> ‚Üí <strong>"${processed.issueTypeLabel}"</strong>
        </div>`;
      }

      let skippedInfo = '';
      if (counts.skipped > 0) {
        skippedInfo = `<div style="background:#fff3cd;border:1px solid #ffc107;color:#856404;padding:12px;border-radius:6px;margin-bottom:16px;">
          ‚ö† Skipped ${counts.skipped} field(s) with auto-generated/meaningless IDs
        </div>`;
      }
      
      let preIgnoredInfo = '';
      if (counts.preIgnored > 0) {
        preIgnoredInfo = `<div style="background:#e7f3ff;border:1px solid #2196F3;color:#004085;padding:12px;border-radius:6px;margin-bottom:16px;">
          ‚ÑπÔ∏è ${counts.preIgnored} field(s) already in your ignore list (pre-checked below)
        </div>`;
      }

      // Analyze duplicates before showing preview
      let duplicateInfo = '';
      if (processed.fieldDefinitions && processed.fieldDefinitions.length > 1) {
        const fieldGroups = new Map();
        processed.fieldDefinitions.forEach(field => {
          const key = `${field.id}|${field.baseUrlId || 'global'}`;
          if (!fieldGroups.has(key)) {
            fieldGroups.set(key, []);
          }
          fieldGroups.get(key).push(field);
        });
        
        const duplicateGroups = Array.from(fieldGroups.values()).filter(group => group.length > 1);
        if (duplicateGroups.length > 0) {
          const totalDuplicates = duplicateGroups.reduce((sum, group) => sum + group.length, 0);
          duplicateInfo = `<div style="background:#fff3cd;border:1px solid #f39c12;color:#856404;padding:12px;border-radius:6px;margin-bottom:16px;">
            üîÄ <strong>${duplicateGroups.length}</strong> field(s) found across multiple issue types (${totalDuplicates} total instances). After import, use the <strong>Field Optimizer</strong> to merge them.
          </div>`;
        }
      }

      content.innerHTML = `
        <h2 style="margin:0 0 16px 0;color:#2c3e50;">üì• Import Preview</h2>
        <p style="color:#666;margin:0 0 20px 0;">Review and select items to import. Uncheck any you don't want.</p>
        
        ${issueTypeInfo}
        ${skippedInfo}
        ${preIgnoredInfo}
        ${duplicateInfo}
        
        <div style="background:#f8f9fa;padding:16px;border-radius:8px;margin-bottom:16px;">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
            <h3 style="margin:0;font-size:1.1em;color:#2c3e50;">Field Definitions (${counts.fields}${counts.ignored > 0 ? `, ${counts.ignored} ignored` : ''})</h3>
            <div style="display:flex;gap:8px;">
              <button id="selectAllFieldsBtn" style="background:#3498db;color:#fff;border:none;border-radius:4px;padding:6px 12px;cursor:pointer;font-size:0.85em;">Select All</button>
              <button id="deselectAllFieldsBtn" style="background:#95a5a6;color:#fff;border:none;border-radius:4px;padding:6px 12px;cursor:pointer;font-size:0.85em;">Deselect All</button>
            </div>
          </div>
          <div id="fieldsList" style="min-height:200px;max-height:300px;overflow-y:auto;border:1px solid #ddd;border-radius:4px;padding:12px;background:#fff;">
            <!-- Fields will be populated here -->
          </div>
        </div>

        <div style="background:#e7f3ff;padding:12px;border-radius:8px;border-left:4px solid #2196F3;margin-bottom:16px;font-size:0.9em;">
          <strong>üí° Tip:</strong> Required fields are marked with ‚ö†Ô∏è. Toggle the checkbox to change. Use "Undo Last Import" if needed.
        </div>

        <div style="display:flex;gap:12px;justify-content:flex-end;margin-top:auto;">
          <button id="cancelImportBtn" style="background:#6c757d;color:#fff;border:none;border-radius:6px;padding:12px 24px;cursor:pointer;font-size:14px;font-weight:500;">Cancel</button>
          <button id="confirmImportBtn" style="background:#27ae60;color:#fff;border:none;border-radius:6px;padding:12px 24px;cursor:pointer;font-size:14px;font-weight:600;">Import Selected</button>
        </div>
      `;

      modal.appendChild(content);
      document.body.appendChild(modal);

      // Populate fields list with checkboxes
      const fieldsList = document.getElementById('fieldsList');
      
      console.log('Import Preview: fieldsList element found?', !!fieldsList);
      console.log('Import Preview: Number of fields to display:', processed.fieldDefinitions ? processed.fieldDefinitions.length : 0);
      
      if (!fieldsList) {
        console.error('Import Preview: fieldsList element not found!');
        return;
      }
      
      if (processed.fieldDefinitions && processed.fieldDefinitions.length > 0) {
        // Clear any existing content first
        fieldsList.innerHTML = '';
        
        // Load existing ignored fields to check against
        const allStoredFields = loadAllFieldDefinitions();
        const alreadyIgnoredFieldIds = new Set(
          allStoredFields.filter(f => f.ignored).map(f => f.id)
        );
        
        processed.fieldDefinitions.forEach((field, index) => {
          // Check if this field is already ignored in storage
          const isAlreadyIgnored = alreadyIgnoredFieldIds.has(field.id);
          
          const row = document.createElement('div');
          row.style.cssText = 'display:flex;gap:8px;align-items:center;padding:8px;border-bottom:1px solid #eee;';
          row.setAttribute('data-field-index', index);
          
          // Pre-set opacity if already ignored
          if (isAlreadyIgnored) {
            row.style.opacity = '0.5';
          }

          // Checkbox for selection
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.checked = true;
          checkbox.className = 'import-field-checkbox';
          checkbox.style.cssText = 'cursor:pointer;';

          // Field info
          const info = document.createElement('div');
          info.style.cssText = 'flex:1;';
          
          let badges = '';
          if (field.appType) {
            const appColor = field.appType === 'jira' ? '#5dade2' : '#45b7d1';
            badges += `<span style="font-size:0.75em;background:${appColor};color:#fff;padding:2px 6px;border-radius:3px;margin-left:4px;">${field.appType.toUpperCase()}</span>`;
          }
          
          // Show issue type if present
          let issueTypeInfo = '';
          if (field.issueTypeLabel) {
            issueTypeInfo = `<span style="font-size:0.75em;background:#95a5a6;color:#fff;padding:2px 6px;border-radius:3px;margin-left:4px;">${escapeHtml(field.issueTypeLabel)}</span>`;
          } else if (field.issueTypeId && Array.isArray(field.issueTypeId) && field.issueTypeId.length > 1) {
            issueTypeInfo = `<span style="font-size:0.75em;background:#f39c12;color:#fff;padding:2px 6px;border-radius:3px;margin-left:4px;">üîÄ ${field.issueTypeId.length} types</span>`;
          }
          
          info.innerHTML = `
            <div style="font-weight:500;">${escapeHtml(field.label)}${badges}${issueTypeInfo}</div>
            <div style="font-size:0.85em;color:#666;">${escapeHtml(field.id)}</div>
          `;

          // Required checkbox
          const requiredLabel = document.createElement('label');
          requiredLabel.style.cssText = 'display:flex;align-items:center;gap:4px;cursor:pointer;white-space:nowrap;';
          
          const requiredCheckbox = document.createElement('input');
          requiredCheckbox.type = 'checkbox';
          requiredCheckbox.checked = field.required || false;
          requiredCheckbox.className = 'import-required-checkbox';
          requiredCheckbox.style.cssText = 'cursor:pointer;';
          
          const requiredText = document.createElement('span');
          requiredText.textContent = field.required ? '‚ö†Ô∏è Required' : 'Optional';
          requiredText.style.cssText = `font-size:0.85em;color:${field.required ? '#e74c3c' : '#95a5a6'};font-weight:500;`;
          
          requiredCheckbox.onchange = function() {
            field.required = this.checked;
            requiredText.textContent = this.checked ? '‚ö†Ô∏è Required' : 'Optional';
            requiredText.style.color = this.checked ? '#e74c3c' : '#95a5a6';
          };

          requiredLabel.appendChild(requiredCheckbox);
          requiredLabel.appendChild(requiredText);

          // Ignore checkbox
          const ignoreLabel = document.createElement('label');
          ignoreLabel.style.cssText = 'display:flex;align-items:center;gap:4px;cursor:pointer;white-space:nowrap;';
          
          const ignoreCheckbox = document.createElement('input');
          ignoreCheckbox.type = 'checkbox';
          ignoreCheckbox.checked = isAlreadyIgnored; // Pre-check if already ignored
          ignoreCheckbox.className = 'import-ignore-checkbox';
          ignoreCheckbox.style.cssText = 'cursor:pointer;';
          
          const ignoreText = document.createElement('span');
          ignoreText.textContent = isAlreadyIgnored ? 'üö´ Already Ignored' : 'üö´ Ignore';
          ignoreText.style.cssText = 'font-size:0.85em;color:#e67e22;font-weight:500;';
          
          // If already ignored, also uncheck the select checkbox
          if (isAlreadyIgnored) {
            checkbox.checked = false;
          }
          
          ignoreCheckbox.onchange = function() {
            if (this.checked) {
              // If ignoring, uncheck select and gray out
              checkbox.checked = false;
              row.style.opacity = '0.5';
              field.ignored = true;
              ignoreText.textContent = 'üö´ Ignore';
            } else {
              // If un-ignoring, restore normal appearance
              row.style.opacity = '1';
              field.ignored = false;
              ignoreText.textContent = 'üö´ Ignore';
            }
          };
          
          // Prevent selecting if ignored
          checkbox.onchange = function() {
            if (this.checked && ignoreCheckbox.checked) {
              // Can't select AND ignore
              this.checked = false;
            }
          };

          ignoreLabel.appendChild(ignoreCheckbox);
          ignoreLabel.appendChild(ignoreText);

          row.appendChild(checkbox);
          row.appendChild(info);
          row.appendChild(requiredLabel);
          row.appendChild(ignoreLabel);
          fieldsList.appendChild(row);
        });
        
        console.log('Import Preview: Successfully added', processed.fieldDefinitions.length, 'field rows to DOM');
      } else {
        fieldsList.innerHTML = '<div style="color:#999;text-align:center;padding:20px;">No fields to import</div>';
        console.log('Import Preview: No fields to display');
      }

      // Button handlers
      document.getElementById('selectAllFieldsBtn').onclick = function() {
        document.querySelectorAll('.import-field-checkbox').forEach(cb => cb.checked = true);
      };

      document.getElementById('deselectAllFieldsBtn').onclick = function() {
        document.querySelectorAll('.import-field-checkbox').forEach(cb => cb.checked = false);
      };

      document.getElementById('cancelImportBtn').onclick = function() {
        document.body.removeChild(modal);
      };

      document.getElementById('confirmImportBtn').onclick = function() {
        // Separate selected fields from ignored fields
        const selectedFields = [];
        const ignoredFields = [];
        
        document.querySelectorAll('.import-field-checkbox').forEach((checkbox, index) => {
          const field = processed.fieldDefinitions[index];
          const ignoreCheckbox = document.querySelectorAll('.import-ignore-checkbox')[index];
          
          if (ignoreCheckbox && ignoreCheckbox.checked) {
            // Field is marked as ignored
            field.ignored = true;
            field.ignoredAt = new Date().toISOString();
            field.ignoredReason = 'manual';
            ignoredFields.push(field);
          } else if (checkbox.checked) {
            // Field is selected for import
            selectedFields.push(field);
          }
        });
        
        if (selectedFields.length === 0 && ignoredFields.length === 0) {
          alert('Please select at least one field to import or ignore, or click Cancel.');
          return;
        }

        // Update processed config with selected and ignored fields
        processed.fieldDefinitions = selectedFields;
        processed.ignoredFields = ignoredFields;
        
        document.body.removeChild(modal);
        executeImport(processed);
      };
    }

    function processImportedConfig(config) {
      const processed = { ...config };
      
      // Filter out meaningless field IDs
      if (processed.fieldDefinitions && Array.isArray(processed.fieldDefinitions)) {
        const original = processed.fieldDefinitions.length;
        processed.fieldDefinitions = processed.fieldDefinitions.filter(field => {
          // Skip if label === id and contains random hash pattern
          if (field.label === field.id && /_[A-Za-z0-9]{16}/.test(field.id)) {
            return false;
          }
          // Skip form tokens, CSRF, etc.
          if (/formToken|csrf|__token|_token/.test(field.id)) {
            return false;
          }
          // Skip if label is just the field ID with "customfield_" prefix and no meaningful name
          if (field.id.startsWith('customfield_') && field.label === field.id) {
            return false;
          }
          return true;
        });
        
        // Ensure all field definitions have appType from config
        if (processed.appType) {
          processed.fieldDefinitions.forEach(field => {
            if (!field.appType) {
              field.appType = processed.appType;
            }
          });
        }
        
        processed.skippedFields = original - processed.fieldDefinitions.length;
      }

      // Map issue type ID to label
      if (processed.issueType) {
        const savedIssueTypes = loadItems(getStorageKey('issueTypes')) || [];
        const match = savedIssueTypes.find(it => it.value === processed.issueType || it.id === processed.issueType);
        if (match) {
          processed.issueTypeLabel = match.alias;
          // Update all field definitions to use the label
          if (processed.fieldDefinitions) {
            processed.fieldDefinitions.forEach(field => {
              if (field.issueType === processed.issueType) {
                field.issueTypeLabel = match.alias;
              }
            });
          }
        }
      }

      return processed;
    }

    function executeImport(config) {
      try {
        // Detect and switch app type FIRST, before any operations that use getStorageKey()
        if (config.appType) {
          switchAppType(config.appType);
        }
        
        // Create backup before import
        lastImportBackup = {
          timestamp: new Date().toISOString(),
          configItems: loadConfigurationItems(),
          fieldDefinitions: loadFieldDefinitions(),
          baseUrls: loadItems(getStorageKey('baseUrls')) || [],
          issueTypes: loadItems(getStorageKey('issueTypes')) || [],
          projectIds: loadItems(getStorageKey('projectIds')) || []
        };

        // Save backup to localStorage for persistence
        localStorage.setItem('lastImportBackup', JSON.stringify(lastImportBackup));

        // Helper to merge items with smart dropdown option merging
        const mergeItems = (existing, incoming, isFieldDefinitions = false) => {
          const map = new Map();
          if (Array.isArray(existing)) {
            existing.forEach(i => {
              if (isFieldDefinitions) {
                // For field definitions, use id + issueTypeId + baseUrlId as key
                const issueTypeKey = Array.isArray(i.issueTypeId) ? i.issueTypeId.sort().join(',') : (i.issueTypeId || 'global');
                const key = `${i.id}|${issueTypeKey}|${i.baseUrlId || 'global'}`;
                map.set(key, i);
              } else {
                map.set(i.id, i);
              }
            });
          }
          if (Array.isArray(incoming)) {
            incoming.forEach(item => {
              if (isFieldDefinitions) {
                // For field definitions, use id + issueTypeId + baseUrlId as key
                const issueTypeKey = Array.isArray(item.issueTypeId) ? item.issueTypeId.sort().join(',') : (item.issueTypeId || 'global');
                const key = `${item.id}|${issueTypeKey}|${item.baseUrlId || 'global'}`;
                const existingItem = map.get(key);
                if (existingItem && existingItem.fieldType === 'combobox' && item.fieldType === 'combobox') {
                  // Merge dropdown options
                  const optionsMap = new Map();
                  if (existingItem.options) existingItem.options.forEach(opt => optionsMap.set(opt.value, opt));
                  if (item.options) item.options.forEach(opt => optionsMap.set(opt.value, opt));
                  item.options = Array.from(optionsMap.values());
                }
                map.set(key, item);
              } else {
                const existingItem = map.get(item.id);
                if (existingItem && existingItem.fieldType === 'combobox' && item.fieldType === 'combobox') {
                  // Merge dropdown options
                  const optionsMap = new Map();
                  if (existingItem.options) existingItem.options.forEach(opt => optionsMap.set(opt.value, opt));
                  if (item.options) item.options.forEach(opt => optionsMap.set(opt.value, opt));
                  item.options = Array.from(optionsMap.values());
                }
                map.set(item.id, item);
              }
            });
          }
          return Array.from(map.values());
        };

        // Import all data with merge
        if (config.configItems && Array.isArray(config.configItems)) {
          const existing = loadConfigurationItems();
          saveConfigurationItems(mergeItems(existing, config.configItems));
        }
        if (config.fieldDefinitions && Array.isArray(config.fieldDefinitions)) {
          const existing = loadFieldDefinitions();
          
          // If baseUrl/issueType/projectKey exist, update field definitions to reference them
          if (config.baseUrl) {
            const baseUrlId = config.baseUrl.replace(/https?:\/\//, '').replace(/\//g, '-');
            config.fieldDefinitions.forEach(field => {
              if (!field.baseUrlId) field.baseUrlId = baseUrlId;
            });
          }
          if (config.issueType) {
            config.fieldDefinitions.forEach(field => {
              if (!field.issueTypeId && field.issueType === config.issueType) {
                field.issueTypeId = config.issueType;
              }
            });
          }
          
          saveFieldDefinitions(mergeItems(existing, config.fieldDefinitions, true));
        }
        
        // Handle ignored fields - merge them into existing fields with ignored flag
        if (config.ignoredFields && Array.isArray(config.ignoredFields)) {
          const allFields = loadAllFieldDefinitions(); // Load including ignored
          
          config.ignoredFields.forEach(ignoredField => {
            // Check if field already exists in storage
            const existingIndex = allFields.findIndex(f => f.id === ignoredField.id);
            if (existingIndex >= 0) {
              // Field exists - update it to be ignored
              allFields[existingIndex].ignored = true;
              allFields[existingIndex].ignoredAt = ignoredField.ignoredAt || new Date().toISOString();
              allFields[existingIndex].ignoredReason = ignoredField.ignoredReason || 'manual';
            } else {
              // Field doesn't exist - add it as ignored
              ignoredField.ignored = true;
              allFields.push(ignoredField);
            }
          });
          
          // Save back all fields including ignored ones
          localStorage.setItem(getStorageKey('fieldDefinitions'), JSON.stringify(allFields));
          console.log('[executeImport] Processed', config.ignoredFields.length, 'ignored fields');
        }
        
        // v0.11.0: Field metadata is preserved but dropdown entries are NOT auto-created
        // This prevents duplicate/conflicting base URLs, issue types, and project IDs.
        // Users must manually create dropdown entries via management screens.
        // 
        // Fields retain baseUrl/issueType/projectKey metadata for:
        // - Proper filtering and display
        // - Auto-populate matching logic
        // - Field organization and categorization
        
        // v0.11.0: DO NOT auto-create dropdown entries from import
        // Fields keep metadata (baseUrl, issueType, projectId) but dropdown items
        // must be created manually by user. This prevents duplicate/conflicting entries.
        // 
        // Field metadata is preserved for matching logic:
        // - fields know which issue type/base URL they belong to
        // - auto-populate still works if matching dropdown entries exist
        // - import won't create unwanted dropdown clutter
        
        console.log('[Import] Skipping auto-creation of dropdown items (v0.11.0 behavior)');
        console.log('[Import] Field metadata preserved:', {
          baseUrl: config.baseUrl || 'none',
          issueType: config.issueType || 'none',
          projectKey: config.projectKey || 'none'
        });

        // Clear form state so user gets a clean slate after import
        localStorage.removeItem('linkGenFormState');
        localStorage.removeItem('snowGenState'); // Legacy key

        alert('Configuration imported successfully! Items have been merged. Use "Undo Last Import" if needed. Reloading...');
        window.location.reload();
      } catch (e) {
        alert('Error during import: ' + e.message);
      }
    }

    function undoLastImport() {
      try {
        // Try to load backup from memory or localStorage
        let backup = lastImportBackup;
        if (!backup) {
          const stored = localStorage.getItem('lastImportBackup');
          if (stored) {
            backup = JSON.parse(stored);
          }
        }

        if (!backup) {
          alert('No import to undo. Backup not found.');
          return;
        }

        const confirmed = confirm(
          `Undo import from ${new Date(backup.timestamp).toLocaleString()}?\n\n` +
          `This will restore:\n` +
          `‚Ä¢ ${backup.fieldDefinitions.length} field definitions\n` +
          `‚Ä¢ ${backup.baseUrls.length} base URLs\n` +
          `‚Ä¢ ${backup.issueTypes.length} issue types\n` +
          `‚Ä¢ ${backup.projectIds.length} project IDs\n\n` +
          `Continue?`
        );

        if (!confirmed) return;

        // Restore from backup
        saveConfigurationItems(backup.configItems);
        saveFieldDefinitions(backup.fieldDefinitions);
        saveItems(getStorageKey('baseUrls'), backup.baseUrls);
        saveItems(getStorageKey('issueTypes'), backup.issueTypes);
        saveItems(getStorageKey('projectIds'), backup.projectIds);

        // Clear backup after use
        lastImportBackup = null;
        localStorage.removeItem('lastImportBackup');

        alert('Import undone successfully! Reloading...');
        window.location.reload();
      } catch (e) {
        alert('Error undoing import: ' + e.message);
      }
    }

    // ========================================================================
    // CONFIG MANAGEMENT MODAL
    // ========================================================================

    function openConfigManagementModal() {
      const modal = document.getElementById('configManagementModal');
      if (!modal) return;
      
      // Populate dropdowns in the form
      populateConfigFieldSelects();
      
      modal.style.display = 'block';
      showConfigTab('fields'); // Show fields tab by default
    }

    function closeConfigManagementModal() {
      const modal = document.getElementById('configManagementModal');
      if (!modal) return;
      modal.style.display = 'none';
      cancelConfigFieldEdit();
    }

    function populateConfigFieldSelects() {
      // Populate Base URL select
      const baseUrlSelect = document.getElementById('configFieldBaseUrlSelect');
      baseUrlSelect.innerHTML = '<option value="">All Instances</option>';
      const baseUrls = loadItems(getStorageKey('baseUrls')) || [];
      baseUrls.forEach(url => {
        const option = document.createElement('option');
        option.value = url.id;
        option.textContent = `${url.alias} (${url.value})`;
        baseUrlSelect.appendChild(option);
      });
      
      // Populate Issue Type select
      const issueTypeSelect = document.getElementById('configFieldIssueTypeSelect');
      issueTypeSelect.innerHTML = '<option value="">All Issue Types</option>';
      const issueTypes = loadItems(getStorageKey('issueTypes')) || [];
      issueTypes.forEach(it => {
        const option = document.createElement('option');
        option.value = it.value;
        option.textContent = `${it.alias} (${it.value})`;
        issueTypeSelect.appendChild(option);
      });
    }

    let editingConfigFieldId = null;
    let configComboboxOptions = [];

    function toggleConfigFieldOptions() {
      const fieldType = document.getElementById('configFieldTypeSelect').value;
      const optionsSection = document.getElementById('configComboboxOptionsSection');
      optionsSection.style.display = fieldType === 'combobox' ? 'block' : 'none';
    }

    function addConfigComboboxOption() {
      const labelInput = document.getElementById('configOptionLabelInput');
      const valueInput = document.getElementById('configOptionValueInput');
      
      const label = labelInput.value.trim();
      const value = valueInput.value.trim();
      
      if (!label || !value) {
        alert('Please provide both label and value');
        return;
      }
      
      configComboboxOptions.push({ label, value });
      labelInput.value = '';
      valueInput.value = '';
      
      renderConfigComboboxOptions();
    }

    function renderConfigComboboxOptions() {
      const list = document.getElementById('configComboboxOptionsList');
      
      if (configComboboxOptions.length === 0) {
        list.innerHTML = '<p style="color:#999;text-align:center;padding:8px;margin:0;font-size:0.85em;">No options yet</p>';
        return;
      }
      
      let html = '';
      configComboboxOptions.forEach((opt, index) => {
        html += `
          <div style="display:flex;justify-content:space-between;align-items:center;padding:6px 8px;background:white;margin-bottom:3px;border-radius:3px;border:1px solid #dee2e6;">
            <span style="font-size:0.85em;"><strong>${opt.label}</strong> = ${opt.value}</span>
            <button onclick="removeConfigComboboxOption(${index})" style="background:#e74c3c;color:#fff;border:none;border-radius:3px;padding:2px 8px;cursor:pointer;font-size:0.75em;">√ó</button>
          </div>
        `;
      });
      
      list.innerHTML = html;
    }

    function removeConfigComboboxOption(index) {
      configComboboxOptions.splice(index, 1);
      renderConfigComboboxOptions();
    }

    function editConfigField(fieldId) {
      const fields = loadFieldDefinitions();
      const field = fields.find(f => f.id === fieldId);
      
      if (!field) {
        alert('Field not found');
        return;
      }
      
      // Populate form
      document.getElementById('configFieldIdInput').value = field.id;
      document.getElementById('configFieldLabelInput').value = field.label;
      document.getElementById('configFieldTypeSelect').value = field.fieldType || 'text';
      document.getElementById('configFieldBaseUrlSelect').value = field.baseUrlId || '';
      document.getElementById('configFieldIssueTypeSelect').value = field.issueTypeId || '';
      document.getElementById('configFieldRequiredCheck').checked = field.required || false;
      
      // Handle combobox options
      configComboboxOptions = field.options ? [...field.options] : [];
      toggleConfigFieldOptions();
      renderConfigComboboxOptions();
      
      // Update UI
      editingConfigFieldId = fieldId;
      document.getElementById('configSaveFieldBtn').textContent = 'Update Field';
      document.getElementById('configCancelFieldBtn').style.display = 'inline-block';
      
      // Scroll to form
      document.querySelector('#configFieldsTab').scrollTop = 0;
    }

    function cancelConfigFieldEdit() {
      editingConfigFieldId = null;
      configComboboxOptions = [];
      
      document.getElementById('configFieldIdInput').value = '';
      document.getElementById('configFieldLabelInput').value = '';
      document.getElementById('configFieldTypeSelect').value = 'text';
      document.getElementById('configFieldBaseUrlSelect').value = '';
      document.getElementById('configFieldIssueTypeSelect').value = '';
      document.getElementById('configFieldRequiredCheck').checked = false;
      
      toggleConfigFieldOptions();
      renderConfigComboboxOptions();
      
      document.getElementById('configSaveFieldBtn').textContent = 'Save Field';
      document.getElementById('configCancelFieldBtn').style.display = 'none';
    }

    function saveConfigField() {
      const fieldId = document.getElementById('configFieldIdInput').value.trim();
      const label = document.getElementById('configFieldLabelInput').value.trim();
      const fieldType = document.getElementById('configFieldTypeSelect').value;
      const baseUrlId = document.getElementById('configFieldBaseUrlSelect').value;
      const issueTypeId = document.getElementById('configFieldIssueTypeSelect').value;
      const required = document.getElementById('configFieldRequiredCheck').checked;
      
      if (!fieldId || !label) {
        alert('Please provide Field ID and Label');
        return;
      }
      
      const fields = loadFieldDefinitions();
      
      if (editingConfigFieldId) {
        // Update existing field
        const index = fields.findIndex(f => f.id === editingConfigFieldId);
        if (index >= 0) {
          const updated = {
            id: fieldId,
            label: label,
            fieldType: fieldType,
            baseUrlId: baseUrlId || undefined,
            issueTypeId: issueTypeId || undefined,
            required: required
          };
          
          // Only add options if fieldType is combobox
          if (fieldType === 'combobox' && configComboboxOptions.length > 0) {
            updated.options = configComboboxOptions;
          }
          // Explicitly don't copy old options if field type changed from combobox
          
          // Preserve appType if it exists
          if (fields[index].appType) {
            updated.appType = fields[index].appType;
          }
          
          fields[index] = updated;
        }
      } else {
        // Add new field
        const newField = {
          id: fieldId,
          label: label,
          fieldType: fieldType,
          required: required
        };
        
        if (baseUrlId) newField.baseUrlId = baseUrlId;
        if (issueTypeId) newField.issueTypeId = issueTypeId;
        if (fieldType === 'combobox') newField.options = configComboboxOptions;
        
        // Get appType from body
        const isJira = document.body.classList.contains('app-jira');
        const isServiceNow = document.body.classList.contains('app-servicenow');
        if (isJira) newField.appType = 'jira';
        if (isServiceNow) newField.appType = 'servicenow';
        
        fields.push(newField);
      }
      
      saveFieldDefinitions(fields);
      updateAllFieldSelects();
      loadFieldsManagement();
      cancelConfigFieldEdit();
      
      alert(editingConfigFieldId ? 'Field updated successfully!' : 'Field added successfully!');
    }

    function showConfigTab(tabName) {
      // Update tab buttons
      document.querySelectorAll('.config-tab').forEach(btn => {
        btn.style.color = '#6c757d';
        btn.style.borderBottom = '3px solid transparent';
      });
      
      const activeBtn = document.getElementById(`tab${tabName.charAt(0).toUpperCase() + tabName.slice(1)}Btn`);
      if (activeBtn) {
        activeBtn.style.color = '#3498db';
        activeBtn.style.borderBottom = '3px solid #3498db';
      }
      
      // Hide all tab contents
      document.querySelectorAll('.config-tab-content').forEach(content => {
        content.style.display = 'none';
      });
      
      // Show selected tab
      const selectedTab = document.getElementById(`config${tabName.charAt(0).toUpperCase() + tabName.slice(1)}Tab`);
      if (selectedTab) {
        selectedTab.style.display = 'block';
      }
      
      // Load data for the selected tab
      if (tabName === 'fields') {
        loadFieldsManagement();
      } else if (tabName === 'dropdowns') {
        loadBaseUrlsManagement();
      } else if (tabName === 'issueTypes') {
        loadIssueTypesManagement();
      } else if (tabName === 'projects') {
        loadProjectIdsManagement();
      }
    }

    function loadFieldsManagement() {
      const fields = loadFieldDefinitions();
      const summary = document.getElementById('fieldsSummary');
      const list = document.getElementById('fieldsListByIssueType');
      
      const dropdownCount = fields.filter(f => f.fieldType === 'combobox').length;
      summary.textContent = `Total: ${fields.length} fields (${dropdownCount} dropdowns)`;
      
      // Group by issue type
      const issueTypeDefs = loadItems(getStorageKey('issueTypes')) || [];
      const grouped = {};
      fields.forEach(field => {
        let issueTypeLabel;
        
        if (field.issueTypeLabel) {
          // Use existing label (for merged fields)
          issueTypeLabel = field.issueTypeLabel;
        } else if (!field.issueTypeId) {
          // No issueTypeId = global field
          issueTypeLabel = 'All Issue Types';
        } else {
          // Look up the label for this issueTypeId
          const issueTypeDef = issueTypeDefs.find(it => it.id === field.issueTypeId);
          issueTypeLabel = issueTypeDef ? issueTypeDef.name : field.issueTypeId;
        }
        
        if (!grouped[issueTypeLabel]) grouped[issueTypeLabel] = [];
        grouped[issueTypeLabel].push(field);
      });
      
      let html = '';
      Object.keys(grouped).forEach(issueType => {
        const fieldsInType = grouped[issueType];
        html += `
          <div style="margin-bottom:20px;border:1px solid #dee2e6;border-radius:8px;padding:16px;background:#f8f9fa;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
              <h4 style="margin:0;color:#2c3e50;">${issueType} <span style="color:#6c757d;font-size:0.9em;font-weight:normal;">(${fieldsInType.length})</span></h4>
              <button onclick="deleteFieldsByIssueType('${issueType}')" style="background:#dc3545;color:#fff;border:none;border-radius:4px;padding:6px 12px;cursor:pointer;font-size:12px;">Delete All</button>
            </div>
            <div style="max-height:200px;overflow-y:auto;">
        `;
        
        fieldsInType.forEach(field => {
          const optionsInfo = (field.fieldType === 'combobox' && field.options) ? ` <span style="color:#6c757d;">(${field.options.length} options)</span>` : '';
          const requiredBadge = field.required ? '<span style="background:#e74c3c;color:white;padding:2px 6px;border-radius:3px;font-size:0.75em;margin-left:8px;">REQUIRED</span>' : '';
          html += `
            <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 12px;background:white;margin-bottom:4px;border-radius:4px;">
              <div style="flex:1;">
                <strong>${field.label}</strong>${requiredBadge} <span style="color:#999;font-size:0.85em;">${field.id}</span>${optionsInfo}
              </div>
              <div style="display:flex;gap:6px;">
                <button onclick="editConfigField('${field.id.replace(/'/g, "\\\'")}')" style="background:#3498db;color:#fff;border:none;border-radius:4px;padding:4px 10px;cursor:pointer;font-size:11px;">Edit</button>
                <button onclick="deleteField('${field.id.replace(/'/g, "\\\'")}')" style="background:#6c757d;color:#fff;border:none;border-radius:4px;padding:4px 10px;cursor:pointer;font-size:11px;">Delete</button>
              </div>
            </div>
          `;
        });
        
        html += `</div></div>`;
      });
      
      list.innerHTML = html || '<p style="color:#999;text-align:center;padding:40px;">No fields found.</p>';
    }

    function loadBaseUrlsManagement() {
      const urls = loadItems(getStorageKey('baseUrls')) || [];
      const summary = document.getElementById('urlsSummary');
      const list = document.getElementById('baseUrlsList');
      
      summary.textContent = `Total: ${urls.length} base URLs`;
      
      let html = '';
      urls.forEach(url => {
        html += `
          <div style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:#f8f9fa;margin-bottom:8px;border-radius:6px;border:1px solid #dee2e6;">
            <div>
              <strong>${url.alias}</strong><br>
              <span style="color:#666;font-size:0.9em;">${url.value}</span>
            </div>
            <button onclick="deleteBaseUrl('${url.id}')" style="background:#6c757d;color:#fff;border:none;border-radius:4px;padding:6px 14px;cursor:pointer;font-size:12px;">Delete</button>
          </div>
        `;
      });
      
      list.innerHTML = html || '<p style="color:#999;text-align:center;padding:40px;">No base URLs found.</p>';
    }

    function loadIssueTypesManagement() {
      const issueTypes = loadItems(getStorageKey('issueTypes')) || [];
      const summary = document.getElementById('issueTypesSummary');
      const list = document.getElementById('issueTypesList');
      
      summary.textContent = `Total: ${issueTypes.length} issue types`;
      
      let html = '';
      issueTypes.forEach(it => {
        html += `
          <div style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:#f8f9fa;margin-bottom:8px;border-radius:6px;border:1px solid #dee2e6;">
            <div>
              <strong>${it.alias}</strong><br>
              <span style="color:#666;font-size:0.9em;">ID: ${it.value}</span>
            </div>
            <button onclick="deleteIssueTypeFromConfig('${it.id}')" style="background:#6c757d;color:#fff;border:none;border-radius:4px;padding:6px 14px;cursor:pointer;font-size:12px;">Delete</button>
          </div>
        `;
      });
      
      list.innerHTML = html || '<p style="color:#999;text-align:center;padding:40px;">No issue types found.</p>';
    }

    function loadProjectIdsManagement() {
      const projects = loadItems(getStorageKey('projectIds')) || [];
      const summary = document.getElementById('projectsSummary');
      const list = document.getElementById('projectIdsList');
      
      summary.textContent = `Total: ${projects.length} project IDs`;
      
      let html = '';
      projects.forEach(p => {
        html += `
          <div style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:#f8f9fa;margin-bottom:8px;border-radius:6px;border:1px solid #dee2e6;">
            <div>
              <strong>${p.alias}</strong><br>
              <span style="color:#666;font-size:0.9em;">ID: ${p.value}</span>
            </div>
            <button onclick="deleteProjectIdFromConfig('${p.id}')" style="background:#6c757d;color:#fff;border:none;border-radius:4px;padding:6px 14px;cursor:pointer;font-size:12px;">Delete</button>
          </div>
        `;
      });
      
      list.innerHTML = html || '<p style="color:#999;text-align:center;padding:40px;">No project IDs found.</p>';
    }

    // Delete functions
    function deleteField(fieldId) {
      if (!confirm(`Delete field "${fieldId}"?`)) return;
      const fields = loadFieldDefinitions();
      const filtered = fields.filter(f => f.id !== fieldId);
      saveFieldDefinitions(filtered);
      loadFieldsManagement();
      updateAllFieldSelects();
    }

    function deleteFieldsByIssueType(issueType) {
      if (!confirm(`Delete all fields for issue type "${issueType}"?`)) return;
      const fields = loadFieldDefinitions();
      const filtered = fields.filter(f => {
        const fieldIssueType = f.issueType || f.issueTypeLabel || '(No Issue Type)';
        return fieldIssueType !== issueType;
      });
      saveFieldDefinitions(filtered);
      loadFieldsManagement();
      updateAllFieldSelects();
    }

    function clearAllFields() {
      if (!confirm('Clear ALL field definitions? This cannot be undone!')) return;
      saveFieldDefinitions([]);
      loadFieldsManagement();
      updateAllFieldSelects();
    }

    function clearAllBaseUrls() {
      if (!confirm('Clear ALL base URLs? This cannot be undone!')) return;
      saveItems(getStorageKey('baseUrls'), []);
      loadBaseUrlsManagement();
      populateBaseUrlDropdown();
    }

    function deleteIssueTypeFromConfig(itId) {
      const issueTypes = loadItems(getStorageKey('issueTypes')) || [];
      const filtered = issueTypes.filter(it => it.id !== itId);
      saveItems(getStorageKey('issueTypes'), filtered);
      loadIssueTypesManagement();
      populateIssueTypeDropdown();
      refreshIssueTypeList();
    }

    function clearAllIssueTypesConfig() {
      if (!confirm('Clear ALL issue types? This cannot be undone!')) return;
      saveItems(getStorageKey('issueTypes'), []);
      loadIssueTypesManagement();
      populateIssueTypeDropdown();
      refreshIssueTypeList();
    }

    function deleteProjectIdFromConfig(pId) {
      const projects = loadItems(getStorageKey('projectIds')) || [];
      const filtered = projects.filter(p => p.id !== pId);
      saveItems(getStorageKey('projectIds'), filtered);
      loadProjectIdsManagement();
      populateProjectIdDropdown();
      refreshProjectIdList();
    }

    function clearAllProjectIds() {
      if (!confirm('Clear ALL project IDs? This cannot be undone!')) return;
      saveItems(getStorageKey('projectIds'), []);
      loadProjectIdsManagement();
      populateProjectIdDropdown();
      refreshProjectIdList();
    }

    function loadConfigurationFromUrl(configUrl) {
      try {
        console.log('Loading configuration from URL:', configUrl);
        
        // Use fetch to load the config from URL
        fetch(configUrl)
          .then(response => {
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            return response.json();
          })
          .then(config => {
            // Validate config structure
            if (!config.version) {
              throw new Error('Invalid configuration: missing version');
            }

            // Import all data
            if (config.configItems && Array.isArray(config.configItems)) {
              saveConfigurationItems(config.configItems);
            }
            if (config.fieldDefinitions && Array.isArray(config.fieldDefinitions)) {
              saveFieldDefinitions(config.fieldDefinitions);
            }
            if (config.baseUrls && Array.isArray(config.baseUrls)) {
              saveItems(getStorageKey('baseUrls'), config.baseUrls);
            }
            // Support both new issueTypes and legacy tableNames
            if (config.issueTypes && Array.isArray(config.issueTypes)) {
              saveItems(getStorageKey('issueTypes'), config.issueTypes);
            }
            if (config.tableNames && Array.isArray(config.tableNames)) {
              saveItems(getStorageKey('issueTypes'), config.tableNames);
            }
            if (config.projectIds && Array.isArray(config.projectIds)) {
              saveItems(getStorageKey('projectIds'), config.projectIds);
            }
            
            // Detect app type from config if available
            if (config.appType) {
              switchAppType(config.appType);
            }

            // Save import timestamp
            localStorage.setItem('linkGenLastConfigUrl', configUrl);

            console.log('Configuration loaded from URL successfully');
            // Reload to refresh UI with new config
            window.location.reload();
          })
          .catch(e => {
            console.error('Failed to load configuration from URL:', e);
            // Don't alert - might be offline, let app continue
          });
      } catch (e) {
        console.error('Error loading configuration from URL:', e);
      }
    }

    function openImportModal() {
      const modal = document.getElementById('importModal');
      modal.style.display = 'flex';
      // Reset to file tab
      switchImportTab('file');
    }

    function closeImportModal() {
      const modal = document.getElementById('importModal');
      modal.style.display = 'none';
      // Clear inputs
      document.getElementById('importFileInput').value = '';
      document.getElementById('importJsonTextarea').value = '';
    }

    function switchImportTab(tab) {
      const fileTab = document.getElementById('importFileTab');
      const pasteTab = document.getElementById('importPasteTab');
      const fileTabBtn = document.getElementById('importFileTabBtn');
      const pasteTabBtn = document.getElementById('importPasteTabBtn');
      
      if (tab === 'file') {
        fileTab.style.display = 'block';
        pasteTab.style.display = 'none';
        fileTabBtn.style.borderBottom = '3px solid #3498db';
        pasteTabBtn.style.borderBottom = '3px solid transparent';
      } else {
        fileTab.style.display = 'none';
        pasteTab.style.display = 'block';
        fileTabBtn.style.borderBottom = '3px solid transparent';
        pasteTabBtn.style.borderBottom = '3px solid #3498db';
      }
    }

    function handleFileImport(event) {
      const files = Array.from(event.target.files);
      if (files.length > 0) {
        closeImportModal();
        if (files.length === 1) {
          importConfiguration(files[0]);
        } else {
          importMultipleConfigurations(files);
        }
      }
    }

    function clearImportJson() {
      document.getElementById('importJsonTextarea').value = '';
    }

    function importFromPastedJson() {
      const jsonText = document.getElementById('importJsonTextarea').value.trim();
      
      if (!jsonText) {
        alert('Please paste JSON configuration first');
        return;
      }
      
      try {
        const config = JSON.parse(jsonText);
        closeImportModal();
        
        // Create a mock file object to use existing import logic
        const blob = new Blob([jsonText], { type: 'application/json' });
        const file = new File([blob], 'pasted-config.json', { type: 'application/json' });
        
        importConfiguration(file);
      } catch (err) {
        alert('Invalid JSON: ' + err.message);
      }
    }

    async function importMultipleConfigurations(files) {
      try {
        // Read all files
        const filePromises = files.map(file => {
          return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = e => {
              try {
                const config = JSON.parse(e.target.result);
                resolve({ filename: file.name, config });
              } catch (err) {
                reject(new Error(`Failed to parse ${file.name}: ${err.message}`));
              }
            };
            reader.onerror = () => reject(new Error(`Failed to read ${file.name}`));
            reader.readAsText(file);
          });
        });

        const results = await Promise.all(filePromises);
        
        // Merge all configurations
        const mergedConfig = {
          configItems: [],
          fieldDefinitions: [],
          baseUrls: [],
          issueTypes: [],
          projectIds: [],
          ignoredFields: []
        };
        
        // Set appType from first config that has it
        let detectedAppType = null;

        // Merge each config
        results.forEach(({ filename, config }, index) => {
          // Detect app type from first config
          if (!detectedAppType && config.appType) {
            detectedAppType = config.appType;
          }
          
          // First, process each config individually to set baseUrlId and issueTypeId on fields
          if (config.baseUrl && config.fieldDefinitions) {
            const baseUrlId = config.baseUrl.replace(/https?:\/\//, '').replace(/\//g, '-');
            config.fieldDefinitions.forEach(field => {
              if (!field.baseUrlId) field.baseUrlId = baseUrlId;
              // Also set appType on each field
              if (detectedAppType && !field.appType) field.appType = detectedAppType;
            });
          }
          if (config.issueType && config.fieldDefinitions) {
            config.fieldDefinitions.forEach(field => {
              // Set issueTypeId from either field.issueType or config.issueType
              if (!field.issueTypeId) {
                field.issueTypeId = field.issueType || config.issueType;
              }
              // Preserve field.issueType for display
              if (!field.issueType && config.issueType) {
                field.issueType = config.issueType;
              }
            });
          }
          
          // Now merge into master config
          if (config.configItems) mergedConfig.configItems.push(...config.configItems);
          if (config.fieldDefinitions) mergedConfig.fieldDefinitions.push(...config.fieldDefinitions);
          if (config.baseUrls) mergedConfig.baseUrls.push(...config.baseUrls);
          if (config.issueTypes) mergedConfig.issueTypes.push(...config.issueTypes);
          if (config.projectIds) mergedConfig.projectIds.push(...config.projectIds);
          if (config.ignoredFields) mergedConfig.ignoredFields.push(...config.ignoredFields);
          
          // Handle legacy formats
          if (config.baseUrl && !mergedConfig.baseUrls.find(b => b.url === config.baseUrl)) {
            const baseUrlId = config.baseUrl.replace(/https?:\/\//, '').replace(/\//g, '-');
            mergedConfig.baseUrls.push({ id: baseUrlId, url: config.baseUrl });
          }
          if (config.issueType && !mergedConfig.issueTypes.find(it => it.id === config.issueType)) {
            mergedConfig.issueTypes.push({ 
              id: config.issueType, 
              name: config.issueTypeLabel || config.issueType,
              alias: config.issueTypeLabel || config.issueType
            });
          }
        });

        // Deduplicate merged data intelligently
        // For baseUrls, issueTypes, projectIds - dedupe by ID
        mergedConfig.baseUrls = Array.from(new Map(mergedConfig.baseUrls.map(b => [b.id, b])).values());
        mergedConfig.issueTypes = Array.from(new Map(mergedConfig.issueTypes.map(it => [it.id, it])).values());
        mergedConfig.projectIds = Array.from(new Map(mergedConfig.projectIds.map(p => [p.id, p])).values());
        
        // For configItems - dedupe by id
        mergedConfig.configItems = Array.from(new Map(mergedConfig.configItems.map(c => [c.id, c])).values());
        
        // For ignoredFields - dedupe by id
        mergedConfig.ignoredFields = Array.from(new Set(mergedConfig.ignoredFields));
        
        // For fieldDefinitions - DON'T dedupe yet, let the import preview show all duplicates
        // User will see which ones are duplicates and can decide what to import
        
        // Set appType on merged config so executeImport can switch to it
        if (detectedAppType) {
          mergedConfig.appType = detectedAppType;
        }
        
        // Show import preview with the merged config
        const processed = processImportedConfig(mergedConfig);
        showImportPreview(processed);
        
      } catch (e) {
        alert('Error importing files: ' + e.message);
        console.error('Multi-file import error:', e);
      }
    }

    // ========================================================================
    // FIELD EXTRACTOR MODAL
    // ========================================================================

    function openFieldExtractorModal() {
      const modal = document.getElementById('fieldExtractorModal');
      if (!modal) {
        console.error('fieldExtractorModal not found');
        return;
      }
      
      // Set the bookmarklet href dynamically based on current app type
      const bookmarkletLink = document.getElementById('fieldExtractorBookmarklet');
      if (bookmarkletLink) {
        let bookmarkletCode;
        
        if (currentAppType === 'jira') {
          // Jira Field Extractor Bookmarklet
          bookmarkletCode = `(function(){
            const currentUrl = window.location.href;
            const urlObj = new URL(currentUrl);
            const baseUrl = urlObj.protocol + '//' + urlObj.hostname;
            
            // Extract project key and issue type from Jira URLs
            let projectKey = '';
            let issueType = '';
            
            // Pattern 1: /browse/PROJ-123 -> extract 'PROJ'
            const browseMatch = currentUrl.match(/\\/browse\\/([A-Z0-9]+)-/i);
            if (browseMatch) {
              projectKey = browseMatch[1].toUpperCase();
            }
            
            // Pattern 2: /projects/PROJ/... -> extract 'PROJ'
            if (!projectKey) {
              const projectMatch = currentUrl.match(/\\/projects\\/([A-Z0-9]+)/i);
              if (projectMatch) {
                projectKey = projectMatch[1].toUpperCase();
              }
            }
            
            // Pattern 3: pid= query parameter
            const pidParam = urlObj.searchParams.get('pid');
            if (pidParam) {
              projectKey = projectKey || pidParam;
            }
            
            // Extract issue type from issuetype param or DOM
            const issueTypeParam = urlObj.searchParams.get('issuetype');
            if (issueTypeParam) {
              issueType = issueTypeParam;
            } else {
              const typeEl = document.querySelector('#type-val, [data-field-id="issuetype"]');
              if (typeEl) {
                issueType = typeEl.textContent.trim();
              }
            }
            
            const fields = document.querySelectorAll('input[id], input[name], select[id], select[name], textarea[id], textarea[name]');
            const extracted = [];
            const requiredFieldIds = new Set();
            
            // First pass: identify required fields by checking labels
            fields.forEach(field => {
              if (!field.id && !field.name) return;
              const fieldId = field.id || field.name;
              
              // Get label for this field
              let label = fieldId;
              const closestLabel = field.closest('label');
              if (closestLabel && closestLabel.textContent) {
                label = closestLabel.textContent.trim();
              } else {
                const labelFor = document.querySelector("label[for='" + field.id + "']");
                if (labelFor && labelFor.textContent) {
                  label = labelFor.textContent.trim();
                }
              }
              label = label.replace(/[*:]/g, '').trim();
              
              // Check if THIS field itself is required (by attributes or asterisk in label)
              const isFieldRequired = field.required || 
                                     field.getAttribute('aria-required') === 'true' ||
                                     field.hasAttribute('required') ||
                                     label.includes('*') ||
                                     label.match(/Required|Mandatory/i);
              
              // If this field is required, add it to the set
              if (isFieldRequired) {
                requiredFieldIds.add(fieldId);
                console.log('[Jira] Found required field (direct):', fieldId, 'label:', label);
              }
              
              // Check if label indicates this is a required validation field
              if (label.match(/Required|Mandatory/i)) {
                // Pattern 1: "reporter-field" with label "Reporter Required" -> base: "reporter"
                if (fieldId.endsWith('-field')) {
                  const baseFieldId = fieldId.replace(/-field$/, '');
                  requiredFieldIds.add(baseFieldId);
                  console.log('[Jira] Found required field (pattern -field):', fieldId, '->', baseFieldId, 'label:', label);
                }
                // Pattern 2: "reporterRequired" -> base: "reporter"
                else if (fieldId.match(/(Required|_required|_mandatory)$/i)) {
                  const baseFieldId = fieldId.replace(/(Required|_required|_mandatory)$/i, '');
                  if (baseFieldId) {
                    requiredFieldIds.add(baseFieldId);
                    console.log('[Jira] Found required field (pattern suffix):', fieldId, '->', baseFieldId, 'label:', label);
                  }
                }
              }
            });
            
            console.log('[Jira] Total required fields detected:', requiredFieldIds.size);
            if (requiredFieldIds.size > 0) {
              console.log('[Jira] Required field IDs:', Array.from(requiredFieldIds));
            }
            
            // Helper function to check if a field should be skipped
            const shouldSkipField = (field, fieldId, label) => {
              // Skip hidden fields
              if (field.type === 'hidden') return true;
              
              // Skip validation fields with -field suffix and "Required" in label
              if (fieldId.endsWith('-field') && label && label.match(/Required|Mandatory/i)) return true;
              
              // Skip fields with validation/technical suffixes
              const skipSuffixes = ['Required', '_required', '_mandatory', '_validation', 
                                   '_readonly', '_hidden', '_token', '_secret', 
                                   '_timestamp', '_hash', '_checksum'];
              if (skipSuffixes.some(suffix => fieldId.endsWith(suffix))) return true;
              
              // Skip if ID ends with technical suffix and label contains "Required" or similar
              if (label && (label.includes('Required') || label.includes('Mandatory')) && 
                  fieldId.match(/(Required|_required|_mandatory)$/i)) return true;
              
              // Skip system fields
              const systemPrefixes = ['__', 'sys_', 'csrf', 'token_', '_token'];
              if (systemPrefixes.some(prefix => fieldId.startsWith(prefix))) return true;
              
              // SMART AUTO-EXCLUSION PATTERNS (v0.11.1)
              // Pattern 1: QuickSearch fields (never used)
              if (fieldId.toLowerCase().includes('quicksearch') || label.toLowerCase().includes('quick search')) {
                console.log('[Skip] QuickSearch pattern:', fieldId);
                return true;
              }
              
              // Pattern 2: Empty or missing labels
              if (!label || label.trim() === '' || label === fieldId) {
                console.log('[Skip] Empty/missing label:', fieldId);
                return true;
              }
              
              // Pattern 3: Customfield with useless label
              // Skip if ID contains "customfield" AND label is just a variation of the ID
              if (fieldId.toLowerCase().includes('customfield')) {
                const labelNorm = label.toLowerCase().replace(/[^a-z0-9]/g, '');
                const idNorm = fieldId.toLowerCase().replace(/[^a-z0-9]/g, '');
                if (labelNorm === idNorm || label.toLowerCase() === 'customfield') {
                  console.log('[Skip] Customfield with useless label:', fieldId, 'label:', label);
                  return true;
                }
              }
              
              // Pattern 4: ALL textarea variant fields (always duplicates in Jira/SNOW)
              // Any field with "-textarea" or "_textarea" in ID is a duplicate
              if (fieldId.toLowerCase().includes('-textarea') || fieldId.toLowerCase().includes('_textarea')) {
                console.log('[Skip] Textarea variant:', fieldId);
                return true;
              }
              
              return false;
            };
            
            // Second pass: extract actual fields and mark required ones
            fields.forEach(field => {
              if (!field.id && !field.name) return;
              const fieldId = field.id || field.name;
              if (extracted.some(f => f.id === fieldId)) return;
              
              let label = fieldId;
              const closestLabel = field.closest('label');
              if (closestLabel && closestLabel.textContent) {
                label = closestLabel.textContent.trim();
              } else {
                const labelFor = document.querySelector("label[for='" + field.id + "']");
                if (labelFor && labelFor.textContent) {
                  label = labelFor.textContent.trim();
                }
              }
              
              label = label.replace(/[*:]/g, '').trim();
              
              // Skip validation fields BEFORE cleaning the label (need "Required" text for detection)
              if (fieldId.endsWith('-field') && label.match(/Required|Mandatory/i)) {
                console.log('[Jira] Skipping validation field:', fieldId, 'label:', label);
                return;
              }
              
              // Clean up "Required" and "Mandatory" from labels (v0.11.6 - FINAL FIX)
              // Handle all variations: trailing, with punctuation, with extra spaces
              const labelBefore = label;
              // Remove Required/Mandatory at END (with optional trailing punctuation/spaces)
              label = label.replace(/\s+(Required|Mandatory)[\s.,;:!?]*$/gi, '').trim();
              // Remove if it's anywhere with word boundary  
              label = label.replace(/\s+(Required|Mandatory)\b/gi, '').trim();
              if (labelBefore !== label && (fieldId === 'summary' || labelBefore.includes('Required') || labelBefore.includes('Mandatory'))) {
                console.log('[Label Clean] "' + labelBefore + '" -> "' + label + '"');
              }
              
              // Capitalize first letter of each word for better readability
              if (label && label.length > 0) {
                label = label.split(' ').map(word => 
                  word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
                ).join(' ');
              }
              
              // Skip if this is a technical/validation field
              if (shouldSkipField(field, fieldId, label)) return;
              
              // Check if this field is required
              const isRequired = requiredFieldIds.has(fieldId) || requiredFieldIds.has(fieldId.toLowerCase());
              
              // Determine field type and extract options for dropdowns
              let fieldType = 'text';
              let options = [];
              
              if (field.tagName === 'SELECT') {
                fieldType = 'combobox';
                // Extract all options with their labels and values
                Array.from(field.options).forEach(opt => {
                  if (opt.value) { // Skip empty placeholder options
                    options.push({
                      label: opt.textContent.trim(),
                      value: opt.value
                    });
                  }
                });
              }
              
              const fieldDef = {
                id: fieldId,
                label: label || fieldId,
                category: 'custom',
                fieldType: fieldType,
                issueType: issueType,
                required: isRequired
              };
              
              if (options.length > 0) {
                fieldDef.options = options;
              }
              
              extracted.push(fieldDef);
            });
            
            // Count dropdown fields for summary
            const dropdownCount = extracted.filter(f => f.fieldType === 'combobox').length;
            
            const result = {
              version: '1.3.0',
              extractorVersion: '0.11.6',
              extractedAt: new Date().toISOString(),
              description: 'Extracted Field Definitions',
              tool: 'Field Extractor Bookmarklet',
              appType: 'jira',
              baseUrl: baseUrl,
              projectKey: projectKey,
              issueType: issueType,
              fieldDefinitions: extracted
            };
            
            const jsonStr = JSON.stringify(result, null, 2);
            const modal = document.createElement('div');
            modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:999999;display:flex;align-items:center;justify-content:center;font-family:Arial,sans-serif;';
            
            const copyBtn = document.createElement('button');
            copyBtn.textContent = 'Copy to Clipboard';
            copyBtn.style.cssText = 'background:#3498db;color:white;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;font-size:14px;margin-right:10px;';
            copyBtn.onclick = function() {
              navigator.clipboard.writeText(jsonStr);
              this.textContent = '‚úì Copied!';
              setTimeout(() => { this.textContent = 'Copy to Clipboard'; }, 2000);
            };
            
            const downloadBtn = document.createElement('button');
            downloadBtn.textContent = 'Download JSON';
            downloadBtn.style.cssText = 'background:#27ae60;color:white;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;font-size:14px;margin-right:10px;';
            downloadBtn.onclick = function() {
              const blob = new Blob([jsonStr], {type: 'application/json'});
              const url = URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url;
              a.download = 'extracted-fields-jira-' + new Date().toISOString().split('T')[0] + '.json';
              a.click();
              URL.revokeObjectURL(url);
            };
            
            const closeBtn = document.createElement('button');
            closeBtn.textContent = 'Close';
            closeBtn.style.cssText = 'background:#95a5a6;color:white;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;font-size:14px;';
            closeBtn.onclick = function() { modal.remove(); };
            
            const textarea = document.createElement('textarea');
            textarea.value = jsonStr;
            textarea.readOnly = true;
            textarea.style.cssText = 'width:100%;height:200px;padding:12px;border:1px solid #ccc;border-radius:6px;font-family:monospace;font-size:12px;resize:vertical;margin-bottom:15px;box-sizing:border-box;';
            
            const btnContainer = document.createElement('div');
            btnContainer.style.cssText = 'display:flex;gap:10px;justify-content:flex-end;';
            btnContainer.appendChild(copyBtn);
            btnContainer.appendChild(downloadBtn);
            btnContainer.appendChild(closeBtn);
            
            const content = document.createElement('div');
            content.style.cssText = 'background:white;border-radius:12px;padding:30px;max-width:600px;width:90%;box-shadow:0 10px 40px rgba(0,0,0,0.3);';
            content.innerHTML = '<h2 style="color:#2c3e50;margin:0 0 20px 0;">Jira Field Extractor Results</h2><p style="color:#555;margin:0 0 10px 0;">Found <strong>' + extracted.length + '</strong> fields (' + dropdownCount + ' dropdowns with options).</p><p style="color:#666;font-size:0.9em;margin:0 0 20px 0;"><strong>Extractor Version:</strong> <span style="background:#27ae60;color:white;padding:2px 8px;border-radius:3px;font-weight:600;">0.11.6</span><br><strong>Base URL:</strong> ' + baseUrl + '<br><strong>Project:</strong> ' + (projectKey || '(not detected)') + '<br><strong>Issue Type:</strong> ' + (issueType || '(not detected)') + '</p>';
            content.appendChild(textarea);
            content.appendChild(btnContainer);
            
            modal.appendChild(content);
            document.body.appendChild(modal);
          })();`;
        } else {
          // ServiceNow Field Extractor Bookmarklet
          bookmarkletCode = `(function(){
            const currentUrl = window.location.href;
            const urlObj = new URL(currentUrl);
            const baseUrl = urlObj.protocol + '//' + urlObj.hostname;
            
            let issueType = '';
            const uriMatch = currentUrl.match(/uri=([a-z_]+)\\.do/i);
            if (uriMatch) {
              issueType = uriMatch[1];
            } else {
              const pathMatch = urlObj.pathname.match(/\\/([a-z_]+)\\.do/i);
              if (pathMatch) {
                issueType = pathMatch[1];
              }
            }
            
            const fields = document.querySelectorAll('input[id], input[name], select[id], select[name], textarea[id], textarea[name]');
            const extracted = [];
            const requiredFieldIds = new Set();
            
            // First pass: identify required fields by checking labels
            fields.forEach(field => {
              if (!field.id && !field.name) return;
              const fieldId = field.id || field.name;
              
              // Get label for this field - ServiceNow uses aria-labelledby
              let label = fieldId;
              
              // Try aria-labelledby first (ServiceNow pattern)
              const ariaLabelledBy = field.getAttribute('aria-labelledby');
              if (ariaLabelledBy) {
                const labelElement = document.getElementById(ariaLabelledBy);
                if (labelElement && labelElement.textContent) {
                  label = labelElement.textContent.trim();
                }
              }
              
              // Fallback to standard label methods
              if (!ariaLabelledBy || label === fieldId) {
                const closestLabel = field.closest('label');
                if (closestLabel && closestLabel.textContent) {
                  label = closestLabel.textContent.trim();
                } else {
                  const labelFor = document.querySelector("label[for='" + field.id + "']");
                  if (labelFor && labelFor.textContent) {
                    label = labelFor.textContent.trim();
                  }
                }
                
                const fieldContainer = field.closest("[class*='field']");
                if (fieldContainer && fieldContainer.querySelector('label')) {
                  label = fieldContainer.querySelector('label').textContent.trim();
                }
              }
              
              label = label.replace(/[*:]/g, '').trim();
              
              // Check if THIS field itself is required (by attributes or asterisk in label)
              const isFieldRequired = field.required || 
                                     field.getAttribute('aria-required') === 'true' ||
                                     field.hasAttribute('required') ||
                                     label.includes('*') ||
                                     label.match(/Required|Mandatory/i);
              
              // If this field is required, add it to the set
              if (isFieldRequired) {
                requiredFieldIds.add(fieldId);
                console.log('[SNOW] Found required field (direct):', fieldId, 'label:', label);
              }
              
              // Check if label indicates this is a required validation field
              if (label.match(/Required|Mandatory/i)) {
                // Pattern 1: "reporter-field" with label "Reporter Required" -> base: "reporter"
                if (fieldId.endsWith('-field')) {
                  const baseFieldId = fieldId.replace(/-field$/, '');
                  requiredFieldIds.add(baseFieldId);
                  console.log('[SNOW] Found required field (pattern -field):', fieldId, '->', baseFieldId, 'label:', label);
                }
                // Pattern 2: "reporterRequired" -> base: "reporter"
                else if (fieldId.match(/(Required|_required|_mandatory)$/i)) {
                  const baseFieldId = fieldId.replace(/(Required|_required|_mandatory)$/i, '');
                  if (baseFieldId) {
                    requiredFieldIds.add(baseFieldId);
                    console.log('[SNOW] Found required field (pattern suffix):', fieldId, '->', baseFieldId, 'label:', label);
                  }
                }
              }
            });
            
            console.log('[SNOW] Total required fields detected:', requiredFieldIds.size);
            if (requiredFieldIds.size > 0) {
              console.log('[SNOW] Required field IDs:', Array.from(requiredFieldIds));
            }
            
            // Helper function to check if a field should be skipped
            const shouldSkipField = (field, fieldId, label) => {
              // Skip hidden fields
              if (field.type === 'hidden') return true;
              
              // Skip validation fields with -field suffix and "Required" in label
              if (fieldId.endsWith('-field') && label && label.match(/Required|Mandatory/i)) return true;
              
              // Skip fields with validation/technical suffixes
              const skipSuffixes = ['Required', '_required', '_mandatory', '_validation', 
                                   '_readonly', '_hidden', '_token', '_secret', 
                                   '_timestamp', '_hash', '_checksum'];
              if (skipSuffixes.some(suffix => fieldId.endsWith(suffix))) return true;
              
              // Skip if ID ends with technical suffix and label contains "Required" or similar
              if (label && (label.includes('Required') || label.includes('Mandatory')) && 
                  fieldId.match(/(Required|_required|_mandatory)$/i)) return true;
              
              // Skip system fields
              const systemPrefixes = ['__', 'sys_', 'csrf', 'token_', '_token'];
              if (systemPrefixes.some(prefix => fieldId.startsWith(prefix))) return true;
              
              // SMART AUTO-EXCLUSION PATTERNS (v0.11.1)
              // Pattern 1: QuickSearch fields (never used)
              if (fieldId.toLowerCase().includes('quicksearch') || label.toLowerCase().includes('quick search')) {
                console.log('[Skip] QuickSearch pattern:', fieldId);
                return true;
              }
              
              // Pattern 2: Empty or missing labels
              if (!label || label.trim() === '' || label === fieldId) {
                console.log('[Skip] Empty/missing label:', fieldId);
                return true;
              }
              
              // Pattern 3: Customfield with useless label
              // Skip if ID contains "customfield" AND label is just a variation of the ID
              if (fieldId.toLowerCase().includes('customfield')) {
                const labelNorm = label.toLowerCase().replace(/[^a-z0-9]/g, '');
                const idNorm = fieldId.toLowerCase().replace(/[^a-z0-9]/g, '');
                if (labelNorm === idNorm || label.toLowerCase() === 'customfield') {
                  console.log('[Skip] Customfield with useless label:', fieldId, 'label:', label);
                  return true;
                }
              }
              
              // Pattern 4: ALL textarea variant fields (always duplicates in Jira/SNOW)
              // Any field with "-textarea" or "_textarea" in ID is a duplicate
              if (fieldId.toLowerCase().includes('-textarea') || fieldId.toLowerCase().includes('_textarea')) {
                console.log('[Skip] Textarea variant:', fieldId);
                return true;
              }
              
              return false;
            };
            
            // Second pass: extract actual fields and mark required ones
            fields.forEach(field => {
              if (!field.id && !field.name) return;
              const fieldId = field.id || field.name;
              if (extracted.some(f => f.id === fieldId)) return;
              
              // Get label for this field - ServiceNow uses aria-labelledby
              let label = fieldId;
              
              // Try aria-labelledby first (ServiceNow pattern)
              const ariaLabelledBy = field.getAttribute('aria-labelledby');
              if (ariaLabelledBy) {
                const labelElement = document.getElementById(ariaLabelledBy);
                if (labelElement && labelElement.textContent) {
                  label = labelElement.textContent.trim();
                }
              }
              
              // Fallback to standard label methods
              if (!ariaLabelledBy || label === fieldId) {
                const closestLabel = field.closest('label');
                if (closestLabel && closestLabel.textContent) {
                  label = closestLabel.textContent.trim();
                } else {
                  const labelFor = document.querySelector("label[for='" + field.id + "']");
                  if (labelFor && labelFor.textContent) {
                    label = labelFor.textContent.trim();
                  }
                }
                
                const fieldContainer = field.closest("[class*='field']");
                if (fieldContainer && fieldContainer.querySelector('label')) {
                  label = fieldContainer.querySelector('label').textContent.trim();
                }
              }
              
              label = label.replace(/[*:]/g, '').trim();
              
              // Skip validation fields BEFORE cleaning the label (need "Required" text for detection)
              if (fieldId.endsWith('-field') && label.match(/Required|Mandatory/i)) {
                console.log('[SNOW] Skipping validation field:', fieldId, 'label:', label);
                return;
              }
              
              // Clean up "Required" and "Mandatory" from labels (v0.11.6 - FINAL FIX)
              // Handle all variations: trailing, with punctuation, with extra spaces
              const labelBefore = label;
              // Remove Required/Mandatory at END (with optional trailing punctuation/spaces)
              label = label.replace(/\s+(Required|Mandatory)[\s.,;:!?]*$/gi, '').trim();
              // Remove if it's anywhere with word boundary  
              label = label.replace(/\s+(Required|Mandatory)\b/gi, '').trim();
              if (labelBefore !== label && (fieldId === 'summary' || labelBefore.includes('Required') || labelBefore.includes('Mandatory'))) {
                console.log('[Label Clean] "' + labelBefore + '" -> "' + label + '"');
              }
              
              // Capitalize first letter of each word for better readability
              if (label && label.length > 0) {
                label = label.split(' ').map(word => 
                  word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
                ).join(' ');
              }
              
              // Skip if this is a technical/validation field
              if (shouldSkipField(field, fieldId, label)) return;
              
              // Check if this field is required
              const isRequired = requiredFieldIds.has(fieldId) || requiredFieldIds.has(fieldId.toLowerCase());
              
              // Determine field type and extract options for dropdowns
              let fieldType = 'text';
              let options = [];
              
              if (field.tagName === 'SELECT') {
                fieldType = 'combobox';
                // Extract all options with their labels and values
                Array.from(field.options).forEach(opt => {
                  if (opt.value) { // Skip empty placeholder options
                    options.push({
                      label: opt.textContent.trim(),
                      value: opt.value
                    });
                  }
                });
              }
              
              const fieldDef = {
                id: fieldId,
                label: label || fieldId,
                category: 'custom',
                fieldType: fieldType,
                issueType: issueType,
                required: isRequired
              };
              
              if (options.length > 0) {
                fieldDef.options = options;
              }
              
              extracted.push(fieldDef);
            });
            
            // Count dropdown fields for summary
            const dropdownCount = extracted.filter(f => f.fieldType === 'combobox').length;
            
            const result = {
              version: '1.3.0',
              extractorVersion: '0.11.6',
              extractedAt: new Date().toISOString(),
              description: 'Extracted Field Definitions',
              tool: 'Field Extractor Bookmarklet',
              appType: 'servicenow',
              baseUrl: baseUrl,
              issueType: issueType,
              fieldDefinitions: extracted
            };
            
            const jsonStr = JSON.stringify(result, null, 2);
            const modal = document.createElement('div');
            modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:999999;display:flex;align-items:center;justify-content:center;font-family:Arial,sans-serif;';
            
            const copyBtn = document.createElement('button');
            copyBtn.textContent = 'Copy to Clipboard';
            copyBtn.style.cssText = 'background:#3498db;color:white;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;font-size:14px;margin-right:10px;';
            copyBtn.onclick = function() {
              navigator.clipboard.writeText(jsonStr);
              this.textContent = '‚úì Copied!';
              setTimeout(() => { this.textContent = 'Copy to Clipboard'; }, 2000);
            };
            
            const downloadBtn = document.createElement('button');
            downloadBtn.textContent = 'Download JSON';
            downloadBtn.style.cssText = 'background:#27ae60;color:white;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;font-size:14px;margin-right:10px;';
            downloadBtn.onclick = function() {
              const blob = new Blob([jsonStr], {type: 'application/json'});
              const url = URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url;
              a.download = 'extracted-fields-servicenow-' + new Date().toISOString().split('T')[0] + '.json';
              a.click();
              URL.revokeObjectURL(url);
            };
            
            const closeBtn = document.createElement('button');
            closeBtn.textContent = 'Close';
            closeBtn.style.cssText = 'background:#95a5a6;color:white;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;font-size:14px;';
            closeBtn.onclick = function() { modal.remove(); };
            
            const textarea = document.createElement('textarea');
            textarea.value = jsonStr;
            textarea.readOnly = true;
            textarea.style.cssText = 'width:100%;height:200px;padding:12px;border:1px solid #ccc;border-radius:6px;font-family:monospace;font-size:12px;resize:vertical;margin-bottom:15px;box-sizing:border-box;';
            
            const btnContainer = document.createElement('div');
            btnContainer.style.cssText = 'display:flex;gap:10px;justify-content:flex-end;';
            btnContainer.appendChild(copyBtn);
            btnContainer.appendChild(downloadBtn);
            btnContainer.appendChild(closeBtn);
            
            const content = document.createElement('div');
            content.style.cssText = 'background:white;border-radius:12px;padding:30px;max-width:600px;width:90%;box-shadow:0 10px 40px rgba(0,0,0,0.3);';
            content.innerHTML = '<h2 style="color:#2c3e50;margin:0 0 20px 0;">ServiceNow Field Extractor Results</h2><p style="color:#555;margin:0 0 10px 0;">Found <strong>' + extracted.length + '</strong> fields (' + dropdownCount + ' dropdowns with options).</p><p style="color:#666;font-size:0.9em;margin:0 0 20px 0;"><strong>Extractor Version:</strong> <span style="background:#27ae60;color:white;padding:2px 8px;border-radius:3px;font-weight:600;">0.11.6</span><br><strong>Base URL:</strong> ' + baseUrl + '<br><strong>Issue Type:</strong> ' + (issueType || '(not detected)') + '</p>';
            content.appendChild(textarea);
            content.appendChild(btnContainer);
            
            modal.appendChild(content);
            document.body.appendChild(modal);
          })();`;
        }
        
        bookmarkletLink.href = 'javascript:' + encodeURIComponent(bookmarkletCode);
        
        // Update bookmarklet link text (same for both app types)
        bookmarkletLink.textContent = 'üîç Field Extractor';
        
        // Modal title stays consistent
        const modalTitle = modal.querySelector('h2');
        if (modalTitle) {
          modalTitle.textContent = 'üîç Field Extractor';
        }
      }
      
      modal.style.display = 'block';
    }

    function closeFieldExtractorModal() {
      const modal = document.getElementById('fieldExtractorModal');
      if (!modal) return;
      modal.style.display = 'none';
    }

    function openFieldPickerModal() {
      // Open the field picker in a new popup window
      const width = 1000;
      const height = 700;
      const left = (screen.width - width) / 2;
      const top = (screen.height - height) / 2;
      
      const popup = window.open(
        'field-picker-window.html',
        'fieldPickerWindow',
        `width=${width},height=${height},left=${left},top=${top},resizable=yes,scrollbars=yes`
      );
      
      if (!popup) {
        alert('Popup blocked! Please allow popups for this site to use the Field Picker.');
        return;
      }
      
      // Focus the popup
      popup.focus();
    }

    function closeFieldPickerModal() {
      const modal = document.getElementById('fieldPickerModal');
      if (!modal) return;
      modal.style.display = 'none';
    }

    function generateFieldPickerBookmarklet() {
      return `(function(){if(window.fieldPickerActive){alert('Field Picker is already active!');return;}window.fieldPickerActive=true;const escapeHtml=(text)=>{const div=document.createElement('div');div.textContent=text;return div.innerHTML;};const isDarkMode=window.matchMedia&&window.matchMedia('(prefers-color-scheme:dark)').matches;const colors=isDarkMode?{modalBg:'#1e293b',borderColor:'#475569',sectionBg:'#334155',textPrimary:'#f1f5f9',textSecondary:'#cbd5e1',codeBg:'#1e293b',buttonBg:'#3b82f6',buttonHover:'#2563eb'}:{modalBg:'#ffffff',borderColor:'#e2e8f0',sectionBg:'#f8fafc',textPrimary:'#1e293b',textSecondary:'#64748b',codeBg:'#f8fafc',buttonBg:'#3b82f6',buttonHover:'#2563eb'};let banner=document.createElement('div');banner.id='fpBanner';banner.style.cssText='position:fixed;top:0;left:50%;transform:translateX(-50%);background:#27ae60;color:white;padding:12px 24px;border-radius:0 0 8px 8px;z-index:999998;font-family:Arial,sans-serif;font-size:14px;box-shadow:0 2px 8px rgba(0,0,0,0.3);pointer-events:none;';banner.textContent='üéØ Field Picker Active - Click any field to inspect (ESC to exit)';document.body.appendChild(banner);document.body.style.cursor='crosshair';const handleClick=(e)=>{let field=null;if(e.target&&e.target.nodeType===1&&e.target.matches){field=e.target.matches('input,select,textarea')?e.target:e.target.closest('input,select,textarea');}if(!field)return;e.preventDefault();e.stopPropagation();let fieldId=field.id||field.name||field.getAttribute('data-ref')||field.getAttribute('aria-labelledby');if(!fieldId&&field.closest('[data-element]')){fieldId=field.closest('[data-element]').getAttribute('data-element');}if(!fieldId){const parent=field.parentElement;if(parent&&parent.classList.contains('reference')){const hiddenInput=parent.querySelector('input[type="hidden"]');if(hiddenInput&&hiddenInput.name){fieldId=hiddenInput.name;}}}const fieldName=field.name||fieldId;let currentValue=field.value;let actualValue=currentValue;let displayedValue=currentValue;if(field.tagName==='INPUT'&&field.type==='text'&&field.hasAttribute('ac_display_value')){actualValue=field.value;displayedValue=field.getAttribute('ac_display_value');}else if(field.tagName==='INPUT'&&field.type==='text'){const container=field.closest('.reference_autocomplete')||field.closest('.form-group')||field.parentElement;if(container){const hiddenInputs=container.querySelectorAll('input[type="hidden"]');for(let hidden of hiddenInputs){if(hidden.value&&hidden.value.length===32&&/^[0-9a-f]{32}$/.test(hidden.value)){actualValue=hidden.value;displayedValue=currentValue;break;}}}if(actualValue===currentValue&&field.name){const hiddenByName=document.querySelector(\`input[type="hidden"][name="\${field.name}"]\`);if(hiddenByName&&hiddenByName.value){actualValue=hiddenByName.value;displayedValue=currentValue;}}}let label=fieldId;const ariaLabelledBy=field.getAttribute('aria-labelledby');if(ariaLabelledBy){const labelEl=document.getElementById(ariaLabelledBy);if(labelEl)label=labelEl.textContent.trim();}else{const labelFor=document.querySelector(\`label[for="\${field.id}"]\`);if(labelFor)label=labelFor.textContent.trim();}label=label.replace(/[*:]/g,'').trim();label=label.replace(/\\s+(Required|Mandatory)[\\s.,;:!?]*$/gi,'').trim();label=label.replace(/\\s+(Required|Mandatory)\\b/gi,'').trim();let fieldType='text';if(field.tagName==='SELECT')fieldType='combobox';else if(field.tagName==='TEXTAREA')fieldType='text';const isRequired=field.required||field.getAttribute('aria-required')==='true'||field.hasAttribute('required');let options=[];let optionCount=0;if(fieldType==='combobox'&&field.options){Array.from(field.options).forEach(opt=>{if(opt.value){options.push({label:opt.textContent.trim(),value:opt.value});}});optionCount=options.length;}showModal({id:fieldId,name:fieldName,label:label,fieldType:fieldType,required:isRequired,currentValue:actualValue,displayedValue:displayedValue!==actualValue?displayedValue:null,options:options,optionCount:optionCount});};const handleHover=(e)=>{let field=null;if(e.target&&e.target.nodeType===1&&e.target.matches){field=e.target.matches('input,select,textarea')?e.target:e.target.closest('input,select,textarea');}if(field&&!field.closest('#fpModal')){field.style.outline='2px solid #3498db';}};const handleHoverOut=(e)=>{let field=null;if(e.target&&e.target.nodeType===1&&e.target.matches){field=e.target.matches('input,select,textarea')?e.target:e.target.closest('input,select,textarea');}if(field){field.style.outline='';}};const handleEscape=(e)=>{if(e.key==='Escape'){deactivate();}};const showModal=(meta)=>{let modal=document.getElementById('fpModal');if(modal)modal.remove();let backdrop=document.getElementById('fpBackdrop');if(!backdrop){backdrop=document.createElement('div');backdrop.id='fpBackdrop';backdrop.style.cssText='position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:999999;display:flex;align-items:center;justify-content:center;';document.body.appendChild(backdrop);}modal=document.createElement('div');modal.id='fpModal';modal.style.cssText=\`background:\${colors.modalBg};border-radius:12px;padding:32px;max-width:600px;width:90%;max-height:85vh;overflow-y:auto;box-shadow:0 10px 40px rgba(0,0,0,0.3);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,sans-serif;position:relative;line-height:1.6;\`;const showAllOptions=meta.optionCount>0&&meta.optionCount<50;const hasLargeDropdown=meta.optionCount>=50;const isDifferent=meta.displayedValue&&meta.currentValue!==meta.displayedValue;let html=\`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;padding-bottom:16px;border-bottom:2px solid \${colors.borderColor};"><h2 style="margin:0;color:\${colors.textPrimary};font-size:24px;font-weight:600;">üéØ Field Details</h2><button id="fpCloseBtn" style="background:none;border:none;font-size:32px;cursor:pointer;color:\${colors.textSecondary};line-height:1;padding:0;width:32px;height:32px;display:flex;align-items:center;justify-content:center;transition:color 0.2s;" onmouseover="this.style.color='#e74c3c'" onmouseout="this.style.color='\${colors.textSecondary}'">&times;</button></div><div style="background:\${colors.sectionBg};padding:20px;border-radius:8px;margin-bottom:20px;"><div style="margin-bottom:16px;"><div style="color:\${colors.textSecondary};font-size:13px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px;">Field ID</div><div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;"><code style="background:\${colors.codeBg};color:\${colors.textPrimary};padding:8px 12px;border-radius:6px;font-size:14px;font-family:Monaco,Consolas,monospace;border:1px solid \${colors.borderColor};flex:1;min-width:0;word-break:break-all;">\${escapeHtml(meta.id)}</code><button class="fpCopyBtn" data-copy="\${escapeHtml(meta.id)}" style="background:\${colors.buttonBg};color:white;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;font-size:13px;font-weight:600;white-space:nowrap;transition:background 0.2s;" onmouseover="this.style.background='\${colors.buttonHover}'" onmouseout="if(!this.classList.contains('copied'))this.style.background='\${colors.buttonBg}'">Copy</button></div></div><div style="margin-bottom:16px;"><div style="color:\${colors.textSecondary};font-size:13px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px;">Label</div><div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;"><span style="font-size:16px;color:\${colors.textPrimary};flex:1;min-width:0;word-break:break-word;">\${escapeHtml(meta.label)}</span><button class="fpCopyBtn" data-copy="\${escapeHtml(meta.label)}" style="background:\${colors.buttonBg};color:white;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;font-size:13px;font-weight:600;white-space:nowrap;transition:background 0.2s;" onmouseover="this.style.background='\${colors.buttonHover}'" onmouseout="if(!this.classList.contains('copied'))this.style.background='\${colors.buttonBg}'">Copy</button></div></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px;"><div><div style="color:\${colors.textSecondary};font-size:13px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px;">Type</div><span style="font-size:15px;color:\${colors.textPrimary};background:\${colors.codeBg};padding:6px 12px;border-radius:6px;display:inline-block;border:1px solid \${colors.borderColor};">\${meta.fieldType}</span></div><div><div style="color:\${colors.textSecondary};font-size:13px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px;">Required</div><span style="font-size:15px;color:\${meta.required?'#e74c3c':'#27ae60'};background:\${colors.codeBg};padding:6px 12px;border-radius:6px;display:inline-block;font-weight:600;border:1px solid \${colors.borderColor};">\${meta.required?'Yes ‚ö†Ô∏è':'No ‚úì'}</span></div></div>\`;if(meta.currentValue){html+=\`<div style="margin-top:16px;padding-top:16px;border-top:1px solid \${colors.borderColor};"><div style="color:\${colors.textSecondary};font-size:13px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px;">Actual Value \${isDifferent?'(sys_id)':''}</div><div style="background:\${colors.codeBg};color:#27ae60;padding:10px 12px;border-radius:6px;font-size:15px;font-weight:500;border:1px solid \${colors.borderColor};word-break:break-word;">\${escapeHtml(meta.currentValue)}</div></div>\`;}if(isDifferent){html+=\`<div style="margin-top:12px;padding-top:12px;border-top:1px solid \${colors.borderColor};"><div style="color:\${colors.textSecondary};font-size:13px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px;">Displayed Value</div><div style="background:\${colors.codeBg};color:\${colors.textSecondary};padding:10px 12px;border-radius:6px;font-size:14px;border:1px solid \${colors.borderColor};word-break:break-word;">\${escapeHtml(meta.displayedValue)}</div></div>\`;}html+=\`</div>\`;if(showAllOptions){html+=\`<div style="background:\${colors.sectionBg};padding:20px;border-radius:8px;margin-bottom:20px;"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;"><div style="color:\${colors.textSecondary};font-size:13px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;">Options (\${meta.optionCount})</div><button class="fpCopyBtn" data-copy='\${JSON.stringify(meta.options)}' style="background:\${colors.buttonBg};color:white;border:none;padding:6px 14px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600;transition:background 0.2s;" onmouseover="this.style.background='\${colors.buttonHover}'" onmouseout="if(!this.classList.contains('copied'))this.style.background='\${colors.buttonBg}'">Copy All</button></div><div style="background:\${colors.codeBg};padding:16px;border-radius:6px;max-height:300px;overflow-y:auto;border:1px solid \${colors.borderColor};"><ul style="margin:0;padding:0;list-style:none;">\`;meta.options.forEach((opt,idx)=>{html+=\`<li style="padding:8px 0;border-bottom:1px solid \${colors.borderColor};font-size:14px;"><span style="color:\${colors.textPrimary};font-weight:500;">\${escapeHtml(opt.label)}</span><br><span style="color:\${colors.textSecondary};font-size:13px;font-family:Monaco,Consolas,monospace;">value: \${escapeHtml(opt.value)}</span></li>\`;});html+=\`</ul></div></div>\`;}else if(hasLargeDropdown){html+=\`<div style="background:#fff3cd;padding:20px;border-radius:8px;margin-bottom:20px;border-left:4px solid #ffc107;"><div style="display:flex;align-items:start;gap:12px;"><span style="font-size:24px;">‚ÑπÔ∏è</span><div><div style="color:#856404;font-weight:600;margin-bottom:6px;font-size:15px;">Large Dropdown Field</div><p style="margin:0;color:#856404;font-size:14px;line-height:1.5;">This field has <strong>\${meta.optionCount.toLocaleString()} options</strong>. To avoid performance issues, only the current value is shown above.</p></div></div></div>\`;}html+=\`<div style="text-align:center;padding-top:8px;"><button id="fpCopyJsonBtn" style="background:#27ae60;color:white;border:none;padding:14px 32px;border-radius:8px;cursor:pointer;font-size:15px;font-weight:600;box-shadow:0 2px 8px rgba(39,174,96,0.3);transition:all 0.2s;" onmouseover="this.style.background='#229954';this.style.transform='translateY(-2px)';this.style.boxShadow='0 4px 12px rgba(39,174,96,0.4)'" onmouseout="if(!this.classList.contains('copied')){this.style.background='#27ae60';this.style.transform='translateY(0)';this.style.boxShadow='0 2px 8px rgba(39,174,96,0.3)'}">üìã Copy Field as JSON</button></div>\`;modal.innerHTML=html;backdrop.appendChild(modal);document.getElementById('fpCloseBtn').onclick=()=>{modal.remove();backdrop.style.display='none';backdrop.remove();};document.querySelectorAll('.fpCopyBtn').forEach(btn=>{btn.onclick=()=>{const text=btn.getAttribute('data-copy');if(navigator.clipboard){navigator.clipboard.writeText(text);}else{const textarea=document.createElement('textarea');textarea.value=text;document.body.appendChild(textarea);textarea.select();document.execCommand('copy');document.body.removeChild(textarea);}btn.classList.add('copied');const originalText=btn.textContent;btn.textContent='‚úì Copied!';btn.style.background='#27ae60';setTimeout(()=>{btn.classList.remove('copied');btn.textContent=originalText;btn.style.background=colors.buttonBg;},1500);};});document.getElementById('fpCopyJsonBtn').onclick=()=>{let cleanId=meta.id;if(cleanId.includes('.')){cleanId=cleanId.split('.').pop();}const json={id:cleanId,label:meta.label,fieldType:meta.fieldType,required:meta.required};if(meta.options.length>0&&meta.options.length<50){json.options=meta.options;}const jsonStr=JSON.stringify(json,null,2);if(navigator.clipboard){navigator.clipboard.writeText(jsonStr);}else{const textarea=document.createElement('textarea');textarea.value=jsonStr;document.body.appendChild(textarea);textarea.select();document.execCommand('copy');document.body.removeChild(textarea);}const btn=document.getElementById('fpCopyJsonBtn');btn.classList.add('copied');const originalText=btn.textContent;btn.textContent='‚úì Copied to Clipboard!';btn.style.background='#27ae60';setTimeout(()=>{btn.classList.remove('copied');btn.textContent=originalText;btn.style.background='#27ae60';},1500);};backdrop.style.display='flex';};const deactivate=()=>{window.fieldPickerActive=false;if(banner)banner.remove();const modal=document.getElementById('fpModal');if(modal)modal.remove();const backdrop=document.getElementById('fpBackdrop');if(backdrop)backdrop.remove();document.body.style.cursor='';document.removeEventListener('click',handleClick,true);document.removeEventListener('keydown',handleEscape,true);document.removeEventListener('mouseover',handleHover,true);document.removeEventListener('mouseout',handleHoverOut,true);};document.addEventListener('click',handleClick,true);document.addEventListener('keydown',handleEscape,true);document.addEventListener('mouseover',handleHover,true);document.addEventListener('mouseout',handleHoverOut,true);})();`;
    }

    // Initialize dropdowns and restore state on page load
    window.addEventListener('DOMContentLoaded', () => {
      // Initialize dark mode
      initializeDarkMode();
      
      // Restore app type from storage or default to 'servicenow'
      const savedAppType = localStorage.getItem('linkGenAppType') || 'servicenow';
      switchAppType(savedAppType);
      
      // Populate all dropdowns (starts with clean/empty selections)
      populateBaseUrlDropdown();
      populateIssueTypeDropdown();
      populateProjectIdDropdown();
      populatePresetDropdown();
      
      // Don't restore form state - user wants clean slate every time
      // Only app type is remembered (handled above)
    });
    
    // Listen for messages from field picker popup
    window.addEventListener('message', (event) => {
      if (event.data.type === 'IMPORT_FIELDS') {
        const config = event.data.config;
        
        // Helper to merge items by ID
        const mergeItems = (existing, incoming) => {
          const map = new Map();
          if (Array.isArray(existing)) existing.forEach(i => map.set(i.id, i));
          if (Array.isArray(incoming)) incoming.forEach(i => map.set(i.id, i));
          return Array.from(map.values());
        };
        
        // Import field definitions
        if (config.fieldDefinitions && Array.isArray(config.fieldDefinitions)) {
          const existing = loadFieldDefinitions();
          const updated = mergeItems(existing, config.fieldDefinitions);
          saveFieldDefinitions(updated);
          
          alert(`Successfully imported ${config.fieldDefinitions.length} field definition(s)!\\n\\nReloading page to show new fields...`);
          window.location.reload();
        }
      }
    });
    
    function saveState() {
      // Save filter checkbox preference only (useful to remember)
      const state = {
        filterFieldsByIssueType: document.getElementById('filterFieldsByIssueType')?.checked || false
      };
      localStorage.setItem('linkGenFormState', JSON.stringify(state));
    }
    
    function restoreState() {
      try {
        const saved = localStorage.getItem('linkGenFormState');
        if (saved) {
          const state = JSON.parse(saved);
          // Only restore the filter checkbox preference
          if (state.filterFieldsByIssueType !== undefined) {
            const filterCheckbox = document.getElementById('filterFieldsByIssueType');
            if (filterCheckbox) filterCheckbox.checked = state.filterFieldsByIssueType;
          }
        }
      } catch (e) {
        console.error('Error restoring state:', e);
      }
    }
  </script>
  
  <!-- Bootstrap 5 JS Bundle (includes Popper) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
