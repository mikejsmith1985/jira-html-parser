name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Get version from tag
        id: version
        run: |
          TAG=${GITHUB_REF#refs/tags/v}
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          PACKAGE_VERSION=$(cat package.json | grep '"version"' | head -1 | sed 's/.*: "\([^"]*\)".*/\1/')
          echo "package=$PACKAGE_VERSION" >> $GITHUB_OUTPUT

      - name: Verify version match
        run: |
          if [ "${{ steps.version.outputs.tag }}" != "${{ steps.version.outputs.package }}" ]; then
            echo "âŒ Error: Tag version (v${{ steps.version.outputs.tag }}) does not match package.json version (${{ steps.version.outputs.package }})"
            exit 1
          fi
          echo "âœ… Version verified: ${{ steps.version.outputs.tag }}"

      - name: Run tests
        continue-on-error: true
        run: npm test

      - name: Get commit info
        id: commit
        run: |
          echo "message=$(git log -1 --pretty=%B | head -1)" >> $GITHUB_OUTPUT
          echo "author=$(git log -1 --pretty=%an)" >> $GITHUB_OUTPUT
          echo "sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.tag }}
          name: Release v${{ steps.version.outputs.tag }}
          files: |
            link-generator.html
            jira-link-generator.html
            servicenow-link-generator.html
            package.json
            README.md
          body: |
            # Release v${{ steps.version.outputs.tag }}
            
            ## Version Information
            - **Version**: ${{ steps.version.outputs.tag }}
            - **Commit**: ${{ steps.commit.outputs.sha }}
            - **Author**: ${{ steps.commit.outputs.author }}
            
            ## Changes
            ```
            ${{ steps.commit.outputs.message }}
            ```
            
            ## Quick Start
            
            ### ðŸ†• Recommended: Unified Tool (v0.6.0+)
            Download `link-generator.html` - Single tool for both Jira and ServiceNow with:
            - App type selector (Jira/ServiceNow)
            - Enhanced Field Extractor with dropdown option extraction
            - Auto-detection of base URL and issue type
            - Unified configuration management
            
            ### Legacy Tools (Deprecated)
            - `jira-link-generator.html` - Jira-only (deprecated, use link-generator.html)
            - `servicenow-link-generator.html` - ServiceNow-only (deprecated, use link-generator.html)
            
            ## Installation
            1. Download `link-generator.html` from the release assets
            2. Open it in any modern web browser (Chrome, Firefox, Safari, Edge)
            3. Select your app type (Jira or ServiceNow) using the buttons at the top
            4. No installation or server required - works 100% offline
            
            ## Testing
            Run tests with: `npm test`
            
            ## Features (v0.6.0+)
            - **Unified Tool** - Single application for both Jira and ServiceNow
            - **Enhanced Field Extractor v1.2.0** - Extracts dropdown options with labels/values
            - **Auto-Detection** - Detects app type from base URL
            - **Project ID Manager** - Manage multiple Jira projects
            - **Issue Type Management** - Renamed from "Table Name" for consistency
            - **Configuration Export/Import** - Share configurations with your team
            - **Rich Text Editing** - Full formatting support
            - **localStorage Persistence** - All settings saved locally
            
            ## Documentation
            - [README.md](https://github.com/mikejsmith1985/jira-html-parser/blob/master/README.md)
            - [RELEASE-v0.6.0.md](https://github.com/mikejsmith1985/jira-html-parser/blob/master/RELEASE-v0.6.0.md) - Full v0.6.0 release notes
            - [CONFIG_ITEMS_USAGE_GUIDE.md](https://github.com/mikejsmith1985/jira-html-parser/blob/master/CONFIG_ITEMS_USAGE_GUIDE.md)
            - [GITHUB_AUTOMATION.md](https://github.com/mikejsmith1985/jira-html-parser/blob/master/GITHUB_AUTOMATION.md)
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
