name: Release

on:
  push:
    branches:
      - master
      - main

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Get commit info
        id: commit
        run: |
          echo "message=$(git log -1 --pretty=%B | head -1)" >> $GITHUB_OUTPUT
          echo "author=$(git log -1 --pretty=%an)" >> $GITHUB_OUTPUT
          echo "sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Run tests
        continue-on-error: true
        run: npm test

      - name: Determine version bump
        id: version
        run: |
          VERSION=$(cat package.json | grep '"version"' | head -1 | sed 's/.*: "\([^"]*\)".*/\1/')
          COMMIT_MSG="${{ steps.commit.outputs.message }}"
          
          # Determine version bump type
          if echo "$COMMIT_MSG" | grep -q "^feat!"; then
            MAJOR=$(echo $VERSION | cut -d. -f1)
            MAJOR=$((MAJOR + 1))
            NEW_VERSION="$MAJOR.0.0"
          elif echo "$COMMIT_MSG" | grep -q "^feat"; then
            MAJOR=$(echo $VERSION | cut -d. -f1)
            MINOR=$(echo $VERSION | cut -d. -f2)
            MINOR=$((MINOR + 1))
            NEW_VERSION="$MAJOR.$MINOR.0"
          else
            MAJOR=$(echo $VERSION | cut -d. -f1)
            MINOR=$(echo $VERSION | cut -d. -f2)
            PATCH=$(echo $VERSION | cut -d. -f3)
            PATCH=$((PATCH + 1))
            NEW_VERSION="$MAJOR.$MINOR.$PATCH"
          fi
          
          echo "current=$VERSION" >> $GITHUB_OUTPUT
          echo "new=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Update package.json version
        run: |
          sed -i 's/"version": "[^"]*"/"version": "${{ steps.version.outputs.new }}"/g' package.json

      - name: Commit and tag
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add package.json
          git commit -m "chore: bump version to ${{ steps.version.outputs.new }}" || true
          git push origin master || true
          git tag -a "v${{ steps.version.outputs.new }}" -m "Release v${{ steps.version.outputs.new }}" || true
          git push origin "v${{ steps.version.outputs.new }}" || true

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.new }}
          name: Release v${{ steps.version.outputs.new }}
          files: |
            link-generator.html
            jira-link-generator.html
            servicenow-link-generator.html
            package.json
            README.md
          body: |
            # Release v${{ steps.version.outputs.new }}
            
            ## Version Information
            - **Previous Version**: ${{ steps.version.outputs.current }}
            - **Current Version**: ${{ steps.version.outputs.new }}
            - **Commit**: ${{ steps.commit.outputs.sha }}
            - **Author**: ${{ steps.commit.outputs.author }}
            
            ## Changes
            ```
            ${{ steps.commit.outputs.message }}
            ```
            
            ## Quick Start
            
            ### ðŸ†• Recommended: Unified Tool (v0.6.0+)
            Download `link-generator.html` - Single tool for both Jira and ServiceNow with:
            - App type selector (Jira/ServiceNow)
            - Enhanced Field Extractor with dropdown option extraction
            - Auto-detection of base URL and issue type
            - Unified configuration management
            
            ### Legacy Tools (Deprecated)
            - `jira-link-generator.html` - Jira-only (deprecated, use link-generator.html)
            - `servicenow-link-generator.html` - ServiceNow-only (deprecated, use link-generator.html)
            
            ## Installation
            1. Download `link-generator.html` from the release assets
            2. Open it in any modern web browser (Chrome, Firefox, Safari, Edge)
            3. Select your app type (Jira or ServiceNow) using the buttons at the top
            4. No installation or server required - works 100% offline
            
            ## Testing
            Run tests with: `npm test`
            
            ## Features (v0.6.0+)
            - **Unified Tool** - Single application for both Jira and ServiceNow
            - **Enhanced Field Extractor v1.2.0** - Extracts dropdown options with labels/values
            - **Auto-Detection** - Detects app type from base URL
            - **Project ID Manager** - Manage multiple Jira projects
            - **Issue Type Management** - Renamed from "Table Name" for consistency
            - **Configuration Export/Import** - Share configurations with your team
            - **Rich Text Editing** - Full formatting support
            - **localStorage Persistence** - All settings saved locally
            
            ## Documentation
            - [README.md](https://github.com/mikejsmith1985/jira-html-parser/blob/master/README.md)
            - [RELEASE-v0.6.0.md](https://github.com/mikejsmith1985/jira-html-parser/blob/master/RELEASE-v0.6.0.md) - Full v0.6.0 release notes
            - [CONFIG_ITEMS_USAGE_GUIDE.md](https://github.com/mikejsmith1985/jira-html-parser/blob/master/CONFIG_ITEMS_USAGE_GUIDE.md)
            - [GITHUB_AUTOMATION.md](https://github.com/mikejsmith1985/jira-html-parser/blob/master/GITHUB_AUTOMATION.md)
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
