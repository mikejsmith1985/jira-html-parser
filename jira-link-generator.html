<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Jira Issue Link Generator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; background: #f4f6fa; margin: 0; padding: 0; }
    .container { max-width: 600px; margin: 40px auto; background: #fff; border-radius: 8px; box-shadow: 0 2px 8px #0001; padding: 32px; }
    h1 { font-size: 1.6em; margin-bottom: 0.5em; }
    label { display: block; margin-top: 1em; font-weight: 500; }
    input[type="text"], select, textarea, .rich-value {
      width: 100%; padding: 8px; margin-top: 4px; border: 1px solid #ccc; border-radius: 4px;
      font-size: 1em; box-sizing: border-box;
    }
    .fields { margin-top: 1.5em; }
    .field-row { display: flex; gap: 8px; align-items: flex-end; margin-bottom: 10px; }
    .field-row input, .field-row select, .field-row textarea, .field-row .rich-value { flex: 1; }
    .field-row button { background: #e74c3c; color: #fff; border: none; border-radius: 4px; padding: 6px 10px; cursor: pointer; }
    .field-row button:hover { background: #c0392b; }
    .add-btn { background: #3498db; color: #fff; border: none; border-radius: 4px; padding: 8px 16px; margin-top: 8px; cursor: pointer; }
    .add-btn:hover { background: #217dbb; }
    .generate-btn { background: #27ae60; color: #fff; border: none; border-radius: 4px; padding: 12px 24px; font-size: 1.1em; margin-top: 20px; cursor: pointer; width: 100%; }
    .generate-btn:hover { background: #1e874b; }
    .output { margin-top: 2em; background: #f9f9f9; border-radius: 6px; padding: 16px; word-break: break-all; }
    .copy-btn { background: #f1c40f; color: #333; border: none; border-radius: 4px; padding: 6px 12px; margin-left: 8px; cursor: pointer; }
    .copy-btn:hover { background: #d4ac0d; }
    @media (max-width: 600px) {
      .container { padding: 12px; }
      .field-row { flex-direction: column; gap: 4px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Jira Issue Link Generator</h1>
    <form id="jiraForm" autocomplete="off">
      <label>Base URL
        <input type="text" id="baseUrl" placeholder="e.g. https://jira.example.com/" required>
      </label>
      <label>Project ID (pid)
        <input type="text" id="projectId" placeholder="e.g. 12345" required>
      </label>
      <label>Issue Type ID
        <input type="text" id="issueTypeId" placeholder="e.g. 10001" required>
      </label>
      <div class="fields" id="fields"></div>
      <button type="button" class="add-btn" onclick="addField()">+ Add Field</button>
      <button type="submit" class="generate-btn">Generate Link</button>
    </form>
    <div class="output" id="output" style="display:none;">
      <strong>Generated Link:</strong>
      <div id="link"></div>
      <button class="copy-btn" onclick="copyLink()">Copy</button>
    </div>
  </div>
  <script>
    // Restore last state
    window.onload = function() {
      const saved = localStorage.getItem('jiraGenState');
      if (saved) {
        const state = JSON.parse(saved);
        document.getElementById('baseUrl').value = state.baseUrl || '';
        document.getElementById('projectId').value = state.projectId || '';
        document.getElementById('issueTypeId').value = state.issueTypeId || '';
        state.fields && state.fields.forEach(f => addField(f));
      } else {
        addField();
      }
    };

    // Save state
    function saveState() {
      const state = {
        baseUrl: document.getElementById('baseUrl').value,
        projectId: document.getElementById('projectId').value,
        issueTypeId: document.getElementById('issueTypeId').value,
        fields: getFields()
      };
      localStorage.setItem('jiraGenState', JSON.stringify(state));
    }

    // Add a new field row
    function addField(data = {}) {
      const fieldsDiv = document.getElementById('fields');
      const row = document.createElement('div');
      row.className = 'field-row';

      const name = document.createElement('input');
      name.type = 'text';
      name.placeholder = 'Field (e.g. summary, description, customfield_12345)';
      name.value = data.name || '';
      name.required = true;

      const value = document.createElement('div');
      value.contentEditable = 'true';
      value.className = 'rich-value';
      value.placeholder = 'Value (use * or - for bullet points, mixed with regular text)';
      value.style.minHeight = '80px';
      value.style.width = '100%';
      value.style.border = '1px solid #ccc';
      value.style.borderRadius = '4px';
      value.style.padding = '8px';
      value.style.fontSize = '1em';
      value.innerHTML = data.value || '';
      value.oninput = saveState;

      const remove = document.createElement('button');
      remove.type = 'button';
      remove.textContent = 'Remove';
      remove.onclick = () => { fieldsDiv.removeChild(row); saveState(); };

      name.oninput = saveState;
value.oninput = saveState;

      row.appendChild(name);
      row.appendChild(value);
      row.appendChild(remove);
      fieldsDiv.appendChild(row);
      saveState();
    }

    // Get all field data
    function getFields() {
      const rows = document.querySelectorAll('.field-row');
      return Array.from(rows).map(row => ({
        name: row.children[0].value.trim(),
        value: row.children[1].innerHTML
      })).filter(f => f.name);
    }

    // Convert HTML formatting from contentEditable to Jira Wiki markup
    function htmlToJiraMarkup(html) {
      let text = html;

      // Handle lists: convert <li> items to Jira bullet format with newlines between items
      text = text.replace(/<li[^>]*>(.*?)<\/li>/gi, (match, content) => {
        const itemText = htmlToJiraMarkup(content);
        return '* ' + itemText.trim() + '\n';
      });

      // Remove <ul>, <ol> tags but keep content
      text = text.replace(/<\/?(?:ul|ol)[^>]*>/gi, '');

      // Convert bold: <b> and <strong> to *text*
      text = text.replace(/<(?:b|strong)[^>]*>(.*?)<\/(?:b|strong)>/gi, '*$1*');

      // Convert italic: <i> and <em> to _text_
      text = text.replace(/<(?:i|em)[^>]*>(.*?)<\/(?:i|em)>/gi, '_$1_');

      // Convert underline: <u> to +text+
      text = text.replace(/<u[^>]*>(.*?)<\/u>/gi, '+$1+');

      // Convert <br> and <br/> to newlines
      text = text.replace(/<br\s*\/?>/gi, '\n');

      // Convert <div> to newlines (but preserve the content)
      text = text.replace(/<div[^>]*>/gi, '\n');
      text = text.replace(/<\/div>/gi, '');

      // Remove any other remaining HTML tags
      text = text.replace(/<[^>]+>/g, '');

      return text;
    }

    // Smart format value: detect bullets and preserve formatting
    function smartFormatValue(val) {
      // First convert HTML formatting to Jira markup
      let formatted = htmlToJiraMarkup(val);

      // Clean up multiple consecutive newlines
      formatted = formatted.replace(/\n\n+/g, '\n');

      // Split by lines and clean up
      const lines = formatted.split('\n');
      return lines.map(line => {
        const trimmed = line.trim();
        if (!trimmed) return '';
        // If line starts with * (bullet), keep it as is
        if (trimmed.startsWith('*')) {
          return trimmed;
        }
        // Otherwise keep as plain text
        return trimmed;
      }).filter(Boolean).join('\n');
    }

    // Generate the Jira link
    document.getElementById('jiraForm').onsubmit = function(e) {
      e.preventDefault();
      const baseUrl = document.getElementById('baseUrl').value.trim().replace(/\/+$/, '');
      const pid = document.getElementById('projectId').value.trim();
      const issueType = document.getElementById('issueTypeId').value.trim();
      const fields = getFields();

      let url = `${baseUrl}/secure/CreateIssueDetails!init.jspa?pid=${encodeURIComponent(pid)}&issuetype=${encodeURIComponent(issueType)}`;
      fields.forEach(f => {
        let val = smartFormatValue(f.value);
        url += `&${encodeURIComponent(f.name)}=${encodeURIComponent(val)}`;
      });

      document.getElementById('link').textContent = url;
      document.getElementById('output').style.display = 'block';
      saveState();
    };

    // Copy link to clipboard
    function copyLink() {
      const link = document.getElementById('link').textContent;
      navigator.clipboard.writeText(link).then(() => {
        const btn = document.querySelector('.copy-btn');
        btn.textContent = 'Copied!';
        setTimeout(() => btn.textContent = 'Copy', 1200);
      });
    }
  </script>
</body>
</html>
